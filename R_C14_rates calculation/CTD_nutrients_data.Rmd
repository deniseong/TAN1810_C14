---
title: "C14 CTD"
author: "Denise Ong"
date: "2/28/2021"
output: pdf_document
---

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               tidy = FALSE,
               fig.height=8, 
               fig.width=8,
               results = 'asis')
opts_knit$set(width=75)
```


Denise notes 20210315:
- depth was selected until 100 m
- depth interval selected every 5 m
- cycle 1/subantarctic 1 - 24 Oct to 30 Oct
- cycle 2/subantarctic 2 - 2 Nov to 6 Nov
- cycle 3/subtropical 1 - 8 to 10 Nov
- cycle 4/ subtropical 2 - 12 to 14 Nov
- cycle 5/ subantarctic 3 - 16 to 17 Nov

# Load libraries

```{r, message=FALSE, warning=FALSE}
library(here)
source(here("init_files", "init.R")) #for libraries
source(here("init_files", "init_markdown.R")) #for maerkdown libraries

colours_cycle <- readxl::read_excel("init_files/colours_cycle.xlsx")
colours_cycle <- structure(colours_cycle$colour,.Names=colours_cycle$cycle)
```

Plot the cycles together until 150 m

# Read table
```{r}
CTD_raw <- readxl::read_excel("data_used/TK_CTD Downcasts.xlsx") %>%
  dplyr::rename(CTD = `cast`) %>%
  mutate(datetime =  dmy_hms(datetime)) %>%
  filter(!is.na(t)) %>%
  mutate(date = date(datetime)) %>%
  mutate(time = hour(datetime)) %>%
  mutate(julian_day = julian(date, origin = date("2018-01-01"))) %>%
  # filter(time %in% (9:12) ) %>% # only morning CTD
  mutate(t_mean = (t+t2)/2) %>% # each CTD has 2 readings. use the average of the two readings.
  mutate(s_mean = (s+s2)/2) %>%
  mutate(os_mean = (os+os2)/2) %>%
  select(-t, -t2, -s, -s2, -os, -os2) %>%
  filter(p <= 150)
CTD_raw
#check CTD,  date, time
check <- readxl::read_excel("data_used/TK_CTD Downcasts.xlsx") %>%
  dplyr::rename(CTD = `cast`) %>%
  mutate(datetime =  dmy_hms(datetime)) %>%
  filter(!is.na(t)) %>%
  mutate(date = date(datetime)) %>%
  mutate(time = hour(datetime)) %>%
  select(date,time) %>%
  distinct()
```

```{r}
CTD <- CTD_raw %>%
  mutate(cycle = NA)

CTD$julian_day <- as.character(CTD$julian_day)
CTD$cycle[grep("297", CTD$julian_day)] = "1"
CTD$cycle[grep("298", CTD$julian_day)] = "1"
CTD$cycle[grep("299", CTD$julian_day)] = "1"
CTD$cycle[grep("300", CTD$julian_day)] = "1"
CTD$cycle[grep("301", CTD$julian_day)] = "1"
CTD$cycle[grep("302", CTD$julian_day)] = "1"
CTD$cycle[grep("305", CTD$julian_day)] = "2"
CTD$cycle[grep("306", CTD$julian_day)] = "2"
CTD$cycle[grep("307", CTD$julian_day)] = "2"
CTD$cycle[grep("308", CTD$julian_day)] = "2"
CTD$cycle[grep("309", CTD$julian_day)] = "2"
CTD$cycle[grep("311", CTD$julian_day)] = "3"
CTD$cycle[grep("312", CTD$julian_day)] = "3"
CTD$cycle[grep("313", CTD$julian_day)] = "3"
CTD$cycle[grep("315", CTD$julian_day)] = "4"
CTD$cycle[grep("316", CTD$julian_day)] = "4"
CTD$cycle[grep("317", CTD$julian_day)] = "4"
CTD$cycle[grep("319", CTD$julian_day)] = "5"
CTD$cycle[grep("320", CTD$julian_day)] = "5"

CTD <- CTD %>% mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(CTD = as.character(CTD)) %>%
  mutate(cycle_name_2 = case_when(julian_day == "297" ~ "SA1-A",
                                  julian_day == "298" ~ "SA1-A",
                                  julian_day == "299" ~ "SA1-A",
                                  julian_day == "300" ~ "SA1-B",
                                  julian_day == "301" ~ "SA1-B",
                                  julian_day == "302" ~ "SA1-B",
                                  TRUE ~ as.character(cycle_name))) %>%
  # filter(cycle_name_2 != "SA1-B") %>% #  SA1 separated into two sub cycles. C14 exp only includes SA1-A.
  filter(!is.na(cycle)) %>% #remove rows without cycle number
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3"))

#check the dates
check <- CTD  %>% 
  select(date, cycle, time, CTD, julian_day) %>%
  distinct()
check
```
# Plots

##Plot temperature

```{r}
temp_plot <- CTD %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=t_mean, y=p, colour=cycle_name)) + 
 geom_point(size=0.02, alpha = 0.6) +
 # geom_path(size=0.1)+
  geom_smooth(orientation = "y", method = "gam", se = FALSE) +
  scale_y_reverse() +
  ylab("Depth (m)")+
  xlab(expression(paste("Temperature (",degree,"C)")))+
  labs(colour = "Cycle") +
  scale_colour_manual(values = colours_cycle)
 
temp_plot

```

##Plot salinity

```{r}
s_plot <- CTD %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=s_mean, y=p, colour=cycle_name)) + 
 #   geom_path(size=0.1) +
  geom_point(size=0.02, alpha = 0.6) +
  geom_smooth(orientation = "y", method = "gam", se = FALSE) +
  scale_y_reverse() +
  ylab(NULL)+
  xlab("Salinity (PSS)") +
  labs(colour = "Cycle") +
  scale_colour_manual(values = colours_cycle)

s_plot

```

## Plot T-S

```{r}
ts_plot <- CTD %>%
  ggplot(aes(x=s_mean, y=t_mean, colour=cycle_name)) + 
   # geom_errorbar(aes(xmin=s_mean-se, xmax=s_mean+se), width=.1, position=pd) +
    #geom_path() +
  geom_point(size=0.75) +
  #geom_smooth(orientation = "y", method = "gam") +
  #scale_y_reverse()+
  ylab(expression(paste("Temperature (",degree,"C)")))+
  xlab("Salinity (PSS)")+
  scale_colour_manual(values = colours_cycle) +
  guides(colour=guide_legend(title="Cycle"))

ts_plot
```

## Plot light
```{r}

par_plot <- CTD %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=par, y=p, colour=cycle_name)) + 
   geom_path(size=0.1) +
 geom_point(size=0.01, alpha = 0.6) +
  # geom_smooth(orientation = "y", method = "gam") +
  scale_y_reverse() +
  ylab(NULL)+
  xlab("Par") +
  labs(colour = "Cycle") +
  scale_colour_manual(values = colours_cycle)

par_plot

```
Plot oxygen

```{r}

o_plot <- CTD %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=os_mean, y=p, colour=cycle_name)) + 
   geom_path(size=0.1) +
 geom_point(size=0.01, alpha = 0.6) +
  geom_smooth(orientation = "y", method = "gam") +
  scale_y_reverse() +
  ylab(NULL)+
  xlab("Oxygen") +
  labs(colour = "Cycle") +
  scale_colour_manual(values = colours_cycle)

o_plot

```

##Plot flourescence

```{r}

f_plot <- CTD %>%
    filter(fl <=4.5) %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=fl, y=p, colour=cycle_name)) + 
#    geom_path(size=0.1) +
  geom_smooth(orientation = "y", method = "gam") +
 #   geom_point(size=0.01, alpha = 0.6) +
#  scale_y_continuous(expand=c(0,0)) +
  scale_y_reverse(limits = c(150,0))+
  ylab("Depth (m)")+
  xlab("Fluorescence (mg/m3)") +
  labs(colour = "Cycle") +
  scale_colour_manual(values = colours_cycle) 

f_plot

```


```{r}
scale=500
test <- CTD %>%
    filter(fl <=4.5) %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  # pivot_longer(cols = c("fl","par"), names_to = "type", values_to = "value") %>%
  ggplot(aes(y=p, colour = cycle_name)) + 
   # geom_path(size=0.1) +
  geom_smooth(aes(x=par), orientation = "y", method = "gam") +
  geom_smooth(aes(x=fl * scale), method="loess", orientation = "y",  linetype="dashed")+
 #   geom_point(size=0.01, alpha = 0.6) +
#  scale_y_continuous(expand=c(0,0)) +
  scale_y_reverse()+
    scale_x_continuous(name="PAR", sec.axis=sec_axis(~./scale, name="Fluorescence (mg/m3)")) +
  ylab("Depth (m)")+
  scale_colour_manual(values = colours_cycle) 

test
```

```{r}
CTD_figure <- plot_grid(
  temp_plot+ theme(legend.position="none"), 
  s_plot+ theme(legend.position="none"), 
  f_plot+ theme(legend.position="none") + ylab(NULL),
  labels = c("A", "B", "C"), 
  align = 'vh',
  hjust = -1,
  nrow = 1) 

# extract a legend that is laid out horizontally
legend_b <- get_legend(
  temp_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
 CTD_figure <- plot_grid(CTD_figure, legend_b, ncol = 1, rel_heights = c(1, .1))

CTD_figure

pdf("figures/4_ctd nutrients/ctd_se.pdf", height=5, width=7) ; plot(CTD_figure) ; dev.off()


```
for TS plot
```{r}
CTD_figure <- plot_grid(
  ts_plot+ theme(legend.position="none"), 
  f_plot+ theme(legend.position="none"),
  labels = c("A", "B"), 
  align = 'vh',
  hjust = -1,
  nrow = 1) 

# extract a legend that is laid out horizontally
legend_b <- get_legend(
  ts_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "top")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
CTD_figure <- plot_grid(CTD_figure, legend_b, ncol = 1, rel_heights = c(1, .1))

CTD_figure

pdf("figures/4_ctd nutrients/ctd_ts.pdf", height=5, width=7) ; plot(CTD_figure) ; dev.off()


```

## summary 
```{r}
summary_sst <-  CTD %>%
  filter(p <= 12) %>%
  pivot_longer(cols = c("t_mean"), names_to = "ctd", values_to = "value") %>%
  group_by(cycle_name, ctd) %>%
  summarise(mean = round(mean(value), 2),
            sd= round(sd(value),2)) %>%
  unite("SST", mean:sd, sep = " ± ") %>%
  # pivot_wider(names_from = ctd,  values_from = mean_sd) %>%
  ungroup() %>%
  select(cycle_name,  "SST")
summary_sst
# writexl::write_xlsx(summary, "summary_nutrients.xlsx")
summary_s <-  CTD %>%
  filter(p <= 150) %>%
  pivot_longer(cols = c("s_mean"), names_to = "ctd", values_to = "value") %>%
  group_by(cycle_name, ctd) %>%
  summarise(mean = round(mean(value), 2),
            sd= round(sd(value),2)) %>%
  unite("Salinity", mean:sd, sep = " ± ") %>%
  # pivot_wider(names_from = ctd,  values_from = mean_sd) %>%
  ungroup() %>%
  select(cycle_name,  "Salinity")
summary_s
summary_ctd <- full_join(summary_sst, summary_s)
```

#check SA1-A and SA1-B
for checks between SA1-A and SA1-B. The only thing that is different is the fluorescence at DCM. SA1-A  is nearly twice fluorescence of SA1-B.
```{r}
p <- CTD %>%
  ggplot(aes(x=t_mean, y=p, colour=cycle_name_2)) + 
  #  geom_errorbar(aes(xmin=t_mean-se, xmax=t_mean+se), width=.1, position=pd) +
    geom_point(size=0.1, alpha = 0.6) +
  geom_smooth(orientation = "y", method = "gam") +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Temperature (",degree,"C)")))+
  labs(colour = "Cycle name") #+
  #scale_colour_manual(values = colours_cycle)
 
p

p <- CTD %>%
  ggplot(aes(x=s_mean, y=p, colour=cycle_name_2)) + 
   # geom_errorbar(aes(xmin=s_mean-se, xmax=s_mean+se), width=.1, position=pd) +
   # geom_path() +
  geom_point(size=0.1, alpha = 0.6) +
  geom_smooth(orientation = "y", method = "gam") +
  scale_y_reverse()+
  theme_bw() +
  ylab(NULL)+
  xlab("Salinity") 

p
p <- CTD %>%
  filter(fl <=4.5) %>%
  ggplot(aes(x=fl, y=p, colour=cycle_name_2)) + 
 #   geom_errorbar(aes(xmin=fl-se, xmax=fl+se), width=.1, position=pd) +
   # geom_path() +
  geom_smooth(orientation = "y", method = "gam") +
    geom_point(size=0.1, alpha = 0.6) +
  scale_y_reverse()+
  theme_bw() +
  ylab(NULL)+
  xlab("Fluorescence") 
p
```

# check ST1 7  vs 8
```{r}
ST1 <- CTD %>%
  filter(CTD %in% c("9142", "9145"))

p <- ST1 %>%
  ggplot(aes(x=t_mean, y=p, colour=CTD)) + 
    geom_point(size=0.1, alpha = 0.6) +
  geom_path(orientation = "y", method = "gam") +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Temperature (",degree,"C)")))
 
p

p <- ST1 %>%
  ggplot(aes(x=s_mean, y=p, colour=CTD)) + 
  geom_point(size=0.1, alpha = 0.6) +
  geom_path(orientation = "y", method = "gam") +
  scale_y_reverse()+
  theme_bw() +
  xlab("Salinity")

p

p <- ST1 %>%
  filter(fl <=4.5) %>%
  ggplot(aes(x=fl, y=p, colour=CTD)) + 
  geom_path(orientation = "y", method = "gam") +
  geom_point(size=0.1, alpha = 0.6) +
  scale_y_reverse()+
  theme_bw() +
  xlab("Fluorescence")
p

```

#nutrients
## Read table, combine with C14 hot for the cycle, exp and station number.
```{r}
nutrients_raw <- readxl::read_excel("data_used/TAN1810_nutrients.xls") %>%
  dplyr::rename(CTD = `U_Cast`,
                depth =`Depth`)

CTD_raw <- readxl::read_excel("data_used/TK_CTD Downcasts.xlsx") %>%
  dplyr::rename(CTD = `cast`) %>%
  mutate(datetime =  dmy_hms(datetime)) %>%
  filter(!is.na(t)) %>%
  mutate(date = date(datetime)) %>%
  #mutate(time = hour(datetime)) %>%
  mutate(julian_day = julian(date, origin = date("2018-01-01"))) %>%
  select(CTD, datetime, date, julian_day) %>%
  mutate(CTD=as.character(CTD)) %>%
  distinct()

nutrients <- full_join(nutrients_raw,CTD_raw) %>%
  filter(!is.na(depth)) %>%
  filter(!is.na(julian_day)) #how to insert date for the missing dates. Corresponding CTD no. is 9167, 9171, 9169, 9168

nutrients


```
```{r}
nutrients <- nutrients %>%
  mutate(cycle = NA)

nutrients$julian_day <- as.character(nutrients$julian_day)
nutrients$cycle[grep("296", nutrients$julian_day)] = "1"
nutrients$cycle[grep("297", nutrients$julian_day)] = "1"
nutrients$cycle[grep("298", nutrients$julian_day)] = "1"
nutrients$cycle[grep("299", nutrients$julian_day)] = "1"
nutrients$cycle[grep("300", nutrients$julian_day)] = "1"
nutrients$cycle[grep("301", nutrients$julian_day)] = "1"
nutrients$cycle[grep("302", nutrients$julian_day)] = "1"
nutrients$cycle[grep("305", nutrients$julian_day)] = "2"
nutrients$cycle[grep("306", nutrients$julian_day)] = "2"
nutrients$cycle[grep("307", nutrients$julian_day)] = "2"
nutrients$cycle[grep("308", nutrients$julian_day)] = "2"
nutrients$cycle[grep("309", nutrients$julian_day)] = "2"
nutrients$cycle[grep("311", nutrients$julian_day)] = "3"
nutrients$cycle[grep("312", nutrients$julian_day)] = "3"
nutrients$cycle[grep("313", nutrients$julian_day)] = "3"
nutrients$cycle[grep("315", nutrients$julian_day)] = "4"
nutrients$cycle[grep("316", nutrients$julian_day)] = "4"
nutrients$cycle[grep("317", nutrients$julian_day)] = "4"
nutrients$cycle[grep("319", nutrients$julian_day)] = "5"
nutrients$cycle[grep("320", nutrients$julian_day)] = "5"

nutrients <- nutrients %>%
  filter(!is.na(cycle)) %>%
  mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3"))  %>%
  mutate(cycle_name_2 = case_when(julian_day == "296" ~ "SA1-A",
                                  julian_day == "297" ~ "SA1-A",
                                  julian_day == "298" ~ "SA1-A",
                                  julian_day == "299" ~ "SA1-A",
                                  julian_day == "300" ~ "SA1-B",
                                  julian_day == "301" ~ "SA1-B",
                                  julian_day == "302" ~ "SA1-B",
                                  TRUE ~ as.character(cycle_name))) %>%
  # filter(cycle_name_2 != "SA1-B") %>% #  SA1 separated into two sub cycles. C14 exp only includes SA1-A.
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3"))

check <- nutrients  %>% 
  select(CTD, date, cycle_name_2) %>%
  distinct()
check


depth_check <- nutrients %>%
  select(cycle_name, depth) %>%
  distinct() %>%
  group_by(cycle_name) %>%
  arrange(cycle_name,depth) 

depth_check
```

#Summary table
```{r}
summary <-   nutrients %>%
  mutate(nitrate_ammonia = NO3_uM/NH4_uM) %>%
   mutate(si_nitrate=DRSi_uM/NO3_uM) %>%
  pivot_longer(cols = c("DRP_uM", "NH4_uM", "NO3_uM", "DRSi_uM", "nitrate_ammonia", "si_nitrate"), names_to = "nutrients", values_to = "conc") %>%
  group_by(cycle_name, nutrients) %>%
  summarise(conc_mean = round(mean(conc), 2),
            conc_sd= round(sd(conc),2)) %>%
  unite("mean_sd", conc_mean:conc_sd, sep = " ± ") %>%
  pivot_wider(names_from = nutrients,  values_from = mean_sd) %>%
  ungroup() %>%
  select(cycle_name,  "NH4_uM", "NO3_uM","DRP_uM","DRSi_uM", "nitrate_ammonia", "si_nitrate")
summary
# writexl::write_xlsx(summary, "summary_nutrients.xlsx")

summary_all <- full_join(summary_ctd, summary)
summary_all
writexl::write_xlsx(summary_all, "summary_ctdnut.xlsx")

library(xtable)
summary <- readxl::read_excel("data_used/C14_studies.xlsx", sheet = "Sheet3") %>%
  unite("CO2 fixation rate", Lower:Upper, sep = " – ")
print(xtable(summary),
      comment = FALSE,
      include.rownames=FALSE)
```

```{r}
nutrients_sub <- nutrients %>%
  mutate(depth_cat = case_when(depth == "12" ~ "SUR",
                              (depth == "40" & cycle_name == "ST1") ~ "DCM",
                               (depth == "25" & cycle_name == "ST1") ~ "DCM",
                               (depth == "30" & cycle_name == "ST2") ~ "DCM",
                               (depth == "40" & cycle_name == "ST2") ~ "DCM",
                               (depth == "40" & cycle_name == "SA1") ~ "DCM",
                               (depth == "40" & cycle_name == "SA2") ~ "DCM",
                               (depth == "70" & cycle_name == "SA3") ~ "DCM",
                                  TRUE ~as.character(cycle_name))) %>%
  filter(depth_cat %in% c("SUR", "DCM"))

summary <-   nutrients_sub %>%
  mutate(nitrate_ammonia = NO3_uM/NH4_uM) %>%
   mutate(si_nitrate=DRSi_uM/NO3_uM) %>%
  pivot_longer(cols = c("DRP_uM", "NH4_uM", "NO3_uM", "DRSi_uM", "nitrate_ammonia", "si_nitrate"), names_to = "nutrients", values_to = "conc") %>%
  group_by(cycle_name, nutrients) %>%
  summarise(conc_mean = round(mean(conc), 2),
            conc_sd= round(sd(conc),2)) %>%
  unite("mean_sd", conc_mean:conc_sd, sep = " ± ") %>%
  pivot_wider(names_from = nutrients,  values_from = mean_sd) %>%
  ungroup() %>%
  select(cycle_name,  "NH4_uM", "NO3_uM","DRP_uM","DRSi_uM", "nitrate_ammonia", "si_nitrate")
summary

summary_all <- full_join(summary_sst, summary)
summary_all
writexl::write_xlsx(summary_all, "summary_ctdnut_2.0.xlsx")
```


Plot nitrate

```{r}

nitrate_plot <- nutrients %>%
    arrange(cycle_name, CTD, depth)%>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=NO3_uM, y=depth, colour=cycle_name)) + 
  geom_point(size=0.2, alpha = 0.6) +
  # geom_path(size=0.2)+
  geom_smooth(orientation = "y",
             se = FALSE
              ) +
  scale_y_reverse(limits = c(100,0))+
  # scale_y_reverse()+
  ylab("Depth (m)")+
  xlab(expression(paste("Nitrate (uM)")))+
  labs(colour = "Cycle name") +
  scale_colour_manual(values = colours_cycle)
 
nitrate_plot


ammonia_plot <- nutrients %>%
    arrange(cycle_name, CTD, depth)%>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=NH4_uM, y=depth, colour=cycle_name)) + 
  geom_point(size=0.1, alpha = 0.6) +
  # geom_path(size=0.2)+
  geom_smooth(orientation = "y",
             se = FALSE
              ) +
  scale_y_reverse(limits = c(100,0))+
  # scale_y_reverse()+
  ylab("Depth (m)")+
  xlab(expression(paste("Ammonia (uM)")))+
  labs(colour = "Cycle name") +
  scale_colour_manual(values = colours_cycle)
 
ammonia_plot

```

Plot phosphorus

```{r}
p_plot <- nutrients %>%
  arrange(cycle_name, CTD, depth)%>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=DRP_uM, y=depth, colour=cycle_name)) + 
  geom_point(size=0.1, alpha = 0.6) +
  # geom_path(size=0.2)+
  geom_smooth(orientation = "y",
              se = FALSE
              ) +
  scale_y_reverse(limits = c(100,0))+
  ylab(NULL)+
  xlab(expression(paste("Phosphorus (uM)")))+
  labs(colour = "Cycle name")+
  scale_colour_manual(values = colours_cycle)
 
p_plot

```
#combine phosphorus and nitrate
```{r}
scale=10
p <- nutrients %>%
  ggplot(aes(y=depth)) + 
 # geom_point(aes(x= NO3_uM, colour = cycle_name), shape = 1, size = 0.1) +
  geom_smooth(aes(x= NO3_uM, colour = cycle_name), method="loess", orientation = "y", se = FALSE) +  
#  geom_point(aes(x= DRP_uM * scale, colour = cycle_name), shape = 1, size = 0.1) + 
  geom_smooth(aes(x=DRP_uM * scale, colour = cycle_name), method="loess", orientation = "y",  linetype="dashed", se = FALSE)+
  scale_x_continuous(name="Nitrate (uM)", sec.axis=sec_axis(~./scale, name="Phosphate (uM)")) +
  scale_y_reverse(limits = c(100,0))+
  ylab("Depth (m)")+
  labs(colour = "Cycle name") +
  scale_colour_manual(values = colours_cycle)
 
p

```

Plot silicate

```{r}

si_plot <- nutrients %>%
  # group_by(cycle_name, CTD) %>%
  # group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=DRSi_uM, y=depth, colour=cycle_name)) + 
  geom_point(size=0.1, alpha = 0.6) +
  # geom_path(size=0.2) +
  geom_smooth(orientation = "y",
              se = FALSE,
              fill = "lightgrey"
              ) +
  scale_y_reverse(limits = c(100,0))+
  ylab(NULL)+
  xlab(expression(paste("Silicate (uM)")))+
  labs(colour = "Cycle name")  +
  scale_colour_manual(values = colours_cycle)
 
si_plot

```

```{r}
library(patchwork)


plot <- temp_plot + s_plot + nitrate_plot + p_plot + si_plot  + ammonia_plot +  plot_annotation(tag_levels = 'A') + plot_layout(guides = 'collect')
plot
pdf("figures/4_ctd nutrients/ctd nut all.pdf", height=7, width=9) ; plot(plot) ; dev.off()

```


```{r}
nutrients_figure <- plot_grid(
  nitrate_plot+ theme(legend.position="none"), 
  ammonia_plot+ theme(legend.position="none") + ylab(NULL),
  p_plot+ theme(legend.position="none"), 
  si_plot+ theme(legend.position="none"),
  labels = c("A", "B", "C", "D"), 
  align = 'vh',
  hjust = -1,
  nrow = 1) 

# extract a legend that is laid out horizontally
legend_b <- get_legend(
  nitrate_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
nutrients_figure <- plot_grid(nutrients_figure, legend_b, ncol = 1, rel_heights = c(1, .1))
nutrients_figure
 pdf("figures/4_ctd nutrients/nutrients all depth.pdf", height=6, width=8) ; plot(nutrients_figure) ; dev.off()

```

#Nitrate: silicate ratio
```{r}


#nitrate:ammonia plot by depth
p <-  nutrients %>%
    arrange(cycle_name, CTD, depth)%>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  mutate(ratio = NO3_uM/NH4_uM) %>%
  ggplot(aes(x=ratio, y=depth, colour=cycle_name)) + 
  geom_point(size=0.5, alpha = 0.6) +
  # geom_path(size=0.2)+
  geom_smooth(orientation = "y",
             se = FALSE
              ) +
  scale_y_reverse(limits = c(100,0))+
  ylab("Depth (m)")+
  xlab(expression(paste("Nitrate:Ammonia")))+
  labs(colour = "Cycle name") +
  scale_colour_manual(values = colours_cycle)
p


#nitrate: ammonia plot boxplot
p <-  nutrients %>%
  mutate(ratio = NO3_uM/NH4_uM) %>%
  ggplot(aes(x=cycle_name, y=ratio)) + 
  # geom_point(size=0.1, alpha = 0.6) +
  geom_boxplot() +
  ylab(expression(paste("Nitrate:Ammonia"))) +
  geom_hline(yintercept=1, linetype="dashed")
p

p <- nutrients %>%
  mutate(ratio=DRSi_uM/NO3_uM) %>%
  ggplot(aes(x=ratio, y=depth, colour=cycle_name)) + 
  geom_point(size=0.1, alpha = 0.6) +
  geom_smooth(orientation = "y") +
  scale_y_reverse()+
  theme_bw() +
  ylab(NULL)+
  xlab(expression(paste("Nitrate:Silicate")))+
  labs(colour = "Cycle name") +
  scale_colour_manual(values = colours_cycle) +
    geom_vline(xintercept=1, linetype="dashed") 

 
p

p <- nutrients %>%
  mutate(ratio=DRSi_uM/NO3_uM) %>%
  ggplot(aes(y=ratio, x=cycle_name)) + 
  geom_boxplot() +
  geom_point()+
  xlab(expression(paste("Silicate:Nitrate")))+
  labs(colour = "Cycle name") +
  geom_hline(yintercept=1, linetype="dashed") 
p
```

##  check for ST1, exp 7 vs exp 8
7: U9142
8: U9145

7>8  for pp but has less nutrients. Similar temp and salinity profile. Similar community.

overall 7 has slightly less nutrients than 8
same community

```{r}

ST1 <-nutrients %>%
  filter(CTD %in% c("9142", "9145"))
p <- ST1 %>%
  ggplot(aes(x=NO3_uM, y=depth, colour=CTD)) + 
    geom_point(size=0.1, alpha = 0.6) +
  geom_path(orientation = "y") +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Nitrate (uM)")))+
  labs(colour = "Cycle name") 
 
p

p <- ST1 %>%
  ggplot(aes(x=DRP_uM, y=depth, colour=CTD)) + 
    geom_point(size=0.1, alpha = 0.6) +
  geom_path(orientation = "y") +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Phosphorus (uM)")))+
  labs(colour = "Cycle name") +
  geom_hline(yintercept=1, linetype="dashed")
 
p

p <- ST1 %>%
  ggplot(aes(x=DRSi_uM, y=depth, colour=CTD)) + 
    geom_point(size=0.1, alpha = 0.6) +
  geom_path(orientation = "y") +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Silicate (uM)")))+
  labs(colour = "Cycle name") +
  geom_hline(yintercept=1, linetype="dashed")
 
p
```

