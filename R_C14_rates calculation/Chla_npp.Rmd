---
title: "NPP and Chlorophyll"
author: "Denise Ong"
date: "10/25/2022"
output: html_document
---
Data exploration only. Figures are in 2.0
- TAN1810_NPP_areal.xlsx has some gaps in data. I checked with the excel Copy of Chla NPP Raw TAN1810 V5 and created a new column for few calculated values. For future calculations will use the excel TAN1810_NPP_areal_2.0.
- TAN1810_SFChla.xls I added cycle number and int chla. I am not using chla readings in the TAN1810_NPP_areal.xlsx excel because there are many rows that do not correspond to the CTD cast number. Not sure how the chla values are deduced in the NPP excel. I am using the TAN1810_SFChla.xls because it is direct from the chla readings. 
-u9104 why are the depths sampled 3,4,5,10,25, 100? 

anything with less than 5 depth measurements does not get caluclated as integrated PP and chla?

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("init_files", "init.R")) #for libraries
source(here("init_files", "init_markdown.R")) #for markdown libraries
```

#Colours for cycle
```{r}
colours_cycle <- readxl::read_excel("init_files/colours_cycle.xlsx")
colours_cycle <- structure(colours_cycle$colour,.Names=colours_cycle$cycle)
```

#NPP data
```{r}
npp_raw <- readxl::read_excel("data_used/TAN1810_NPP_areal_2.0.xlsx")  %>%
  select(Cycle, Station, Depth, U_Cast, mean_NPP, sd_NPP, areal_PP) %>%
  distinct() %>%
  mutate(cycle_name = recode(Cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  rename(cycle = `Cycle`,
         station = `Station`,
         depth = `Depth`,
         CTD = `U_Cast`)
npp_raw$CTD <- sub("^", "U", npp_raw$CTD)

#use the "complete data TAN1810" sheet for the experiment details.
C14_hot <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.2.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `CTD#`,`STN`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            CTD = `CTD#`, 
            station = `STN`)%>%
    distinct() %>%
  filter(!is.na(cycle))
C14_hot$cycle <- as.character(C14_hot$cycle)
C14_hot$exp <- as.character(C14_hot$exp)

npp <- full_join(npp_raw, C14_hot) %>%
  unite(station_exp, c(station, exp), sep = "_", remove = FALSE) %>%
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3"))
```
for depth group incubations.
```{r}
C14_hot_depth <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.2.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `CTD#`, `SAMPLE`, `STN`, `DEPTH`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            CTD = `CTD#`,
            sample = `SAMPLE`, 
            station = `STN`,
            depth = `DEPTH`)%>%
    distinct() %>%
  filter(!is.na(cycle))
C14_hot$cycle <- as.character(C14_hot$cycle)
C14_hot$exp <- as.character(C14_hot$exp)
```
## NPP integrated figure
```{r}
p <- npp %>%
  select(-mean_NPP, -sd_NPP, -depth) %>%
  distinct() %>%
  ggplot(aes(x = station_exp, y = areal_PP)) +
  geom_point() +
  #geom_errorbar(data = plyr::ddply(npp, c("cycle_name"), summarize, mean = mean(areal_PP, na.rm=TRUE)), aes(y=mean, ymin = mean, ymax = mean))+
  geom_hline(data = plyr::ddply(npp, c("cycle_name"), summarize, mean = mean(areal_PP, na.rm=TRUE)), aes(yintercept = mean))+
  facet_grid(.~cycle_name, scales = "free_x", space = "free")+
  xlab("Cycle") +
  ylab("Integrated pp (mgC/m2/day)")  +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  #geom_text(hjust=0.5, vjust=1.5) 

p
pdf("figures/NPP chla/int_pp.pdf", height=4, width=6) ; plot(p) ; dev.off()
```
Have NPP for most experiments except 1 and 5. 

## NPP across depth plot
```{r}
p <-npp %>%
  ggplot(aes(x=mean_NPP, y= depth, colour=station_exp)) + 
    geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("NPP (mgC/m3/day)") #+
  #scale_color_manual(values = colours_cycle)
p

#only npp measured with C14 rates
p <-npp %>%
  filter(!is.na(exp)) %>%
  ggplot(aes(x=mean_NPP, y= depth, colour=station_exp)) + 
    geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  geom_text(aes(label=exp), vjust = 1.5, hjust=1.5)+
  facet_grid(.~cycle_name, scales = "free_x")+
  #facet_grid(.~cycle_name, scales = "free_x", space = "free")+
  ylab("Depth (m)")+
  xlab("NPP (mgC/m3/day)") +
  ggtitle("NPP")#+
  #scale_color_manual(values = colours_cycle)
p
#pdf("figures/NPP chla/npp_exp.pdf", height=4, width=6) ; plot(p) ; dev.off()
```

## average NPP across depth plot
```{r}
p <- npp %>%
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(mean_NPP),
            sd = sd(mean_NPP)) %>%
  ggplot(aes(x=mean, y= depth)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("NPP (mgC/m3/day)")
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
#pdf("figures/NPP chla/npp_depth_avg.pdf", height=4, width=6) ; plot(p) ; dev.off()

p1 <- npp %>%
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(mean_NPP),
            sd = sd(mean_NPP)) %>%
  ggplot(aes(x=mean, y= depth, colour=cycle_name)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  ylim(100,0)+
  #facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("NPP (mgC/m3/day)")+
  scale_colour_manual(values = colours_cycle)+
   theme_classic()+
    theme(legend.position = "none",
          legend.background = element_rect(colour="black", fill = NA),
          panel.grid.major.x = element_line(colour="lightgrey", size=0.25))+
    guides(colour=guide_legend(title="Cycle"))
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p1
```


# Chlorophyll data
ADD AM/PM COLUMN FOR THE CTD. plot AM and PM separately. - DONE
remove rows where there are some missing measurements for the SF? I think this is better so that the values are more accurate. change the way int chla is calculated? decide later.

the depth for U9104, exp 1 does not correspond to the depth usually collected. not sure what the true depth of the samples are. Might be better to exclude from analysis
 no corresponding chla values for the same CTD for experiment 1,2,3. Cannot use the same day values collected at noon, because noon is always much higher than 1am readings. should I use 1am chla? or 12pm?
## Read data
```{r}
chl <- readxl::read_excel("data_used/TAN1810_SFChla_2.0.xls", sheet = "chla_int") %>%
  select(NIWA_ID, U_Cast, cycle, cycle_2, time, exp, Depth, depth_corrected, Chla_0.2:Chla_20_pct)%>%
  filter(!is.na(cycle)) %>%
  rename(depth = `Depth`,
         CTD = `U_Cast`) %>%
  mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(cycle_name_2 = recode(cycle_2, "1a" = "SA1-a",
                                    "1b" = "SA1-b",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3")) %>%
  mutate(cycle_name_2 = fct_relevel(cycle_name_2, "ST1", "ST2", "SA1-a", "SA1-b", "SA2", "SA3")) %>%
  filter(NIWA_ID!= "AD145") %>% # measured twice?
 # filter(!(CTD == "9104")) %>% # depth indicated are wrong but I cannot tell what are the correct depths.
  na_if(0) %>% # replace 0% as NA as these values were not measured.
  drop_na(Chla_0.2,Chla_2, Chla_20) #remove rows where there are some missing measurements for the SF? I think this is better so that the values are more accurate. change the way int chla is calculated? decide later.

chl$cycle <- as.character(chl$cycle)
chl$CTD <- sub("^", "U", chl$CTD)

#add details for corresponding c14 exp number.
#chl <- full_join(chl, C14_hot) 
chl$exp <- as.character(chl$exp)
#chl <- chl %>%
#  filter(!is.na(NIWA_ID)) %>%
# unite(CTD_exp, c(CTD, exp), sep = "_", remove = FALSE)

#filter out missing measurements?
#chl_subset <- chl%>%
#  filter(!is.na(Chla_2)) %>%
#  filter(!is.na(Chla_20))
#chl_subset
```

## plot chla raw data- across depth for all individual ctd
```{r}
p <-chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "am") %>%
  ggplot(aes(x=SumSFChla, y= depth, colour=CTD)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("am")#+
  #scale_color_manual(values = colours_cycle)
p
p <-chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "noon") %>%
  ggplot(aes(x=SumSFChla, y= depth, colour=CTD)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("noon")#+
  #scale_color_manual(values = colours_cycle)
p

```
## average and SD per cycle
```{r}
p <- chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "am") %>%
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(SumSFChla),
            sd = sd(SumSFChla)) %>%
  ggplot(aes(x=mean, y= depth)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  ggtitle("am")
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p

pdf("figures/NPP chla/chla_am_depth.pdf", height=4, width=6) ; plot(p) ; dev.off()
p <- chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "noon") %>%
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(SumSFChla),
            sd = sd(SumSFChla)) %>%
  ggplot(aes(x=mean, y= depth)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  ggtitle("noon")
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
pdf("figures/NPP chla/chla_noon_depth.pdf", height=4, width=6) ; plot(p) ; dev.off()

p2 <- chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "am") %>%
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(SumSFChla),
            sd = sd(SumSFChla)) %>%
  ggplot(aes(x=mean, y= depth, colour = cycle_name)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
   ylim(100,0)+
  #facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  ggtitle("am") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
   scale_colour_manual(values = colours_cycle)+
   theme_classic()+
    theme(legend.position = c(0.8,0.25),
          legend.background = element_rect(colour="black", fill = NA),
          panel.grid.major.x = element_line(colour="lightgrey", size=0.25))+
    guides(colour=guide_legend(title="Cycle"))
p2
pdf("chla_am.pdf", height=5, width=4) ; plot(p2) ; dev.off()

library(patchwork)
plot<- p1+p2
plot

pdf("chla_am.pdf", height=5, width=7) ; plot(plot) ; dev.off()

```
```{r}
#am
chl_filt <- chl %>%
  filter(!(CTD == "U9104"))
p <- chl_filt %>%
  select(CTD, CTD_exp, time, cycle, cycle_name, areal_chl) %>%
  #select(CTD, CTD_exp, cycle_2, cycle_name_2, areal_chl) %>%
  distinct() %>%
  ggplot(aes(x = CTD_exp, y = areal_chl)) +
  geom_point() +
  geom_hline(data = plyr::ddply(chl_filt, c("cycle_name", "time"), summarize, mean = mean(areal_chl, na.rm=TRUE)), aes(yintercept = mean))+
  facet_grid(time~cycle_name, scales = "free_x", space = "free")+
  xlab("CTD_exp") +
  ylab("Integrated chl (mg/m2)")  +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  #geom_text(hjust=0.5, vjust=1.5) 

p

pdf("figures/NPP chla/int_chla.pdf", height=4, width=6) ; plot(p) ; dev.off()


```

## check chl to corresponding hot rates to npp rates
```{r}
p <-chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "am") %>%
  filter(!is.na(exp)) %>%
  ggplot(aes(x=SumSFChla, y= depth_corrected, colour=exp)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  geom_text(aes(label=exp), vjust = 0.5, hjust=1)+
  scale_y_reverse()+
  facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 1.5, hjust=1.5))+
  ggtitle("Chla - am")
p
#pdf("figures/NPP chla/chla_exp.pdf", height=4, width=6) ; plot(p) ; dev.off()

p <-chl %>%
  filter(!(CTD == "U9104")) %>%
  filter(time == "noon") %>%
  filter(!is.na(exp)) %>%
  ggplot(aes(x=SumSFChla, y= depth_corrected)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  geom_text(aes(label=exp), vjust = 0.5, hjust=1)+
  scale_y_reverse()+
  facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 1.5, hjust=1.5))+
  ggtitle("Chla - noon")
p

pdf("figures/2_NPP chla/chla_exp_depth_noon.pdf", height=4, width=6) ; plot(p) ; dev.off()


```
#SF Chla
## separate all
```{r fig.height=10, fig.width=15, eval=FALSE}
sf_chl_long <- chl %>%
  pivot_longer(cols = "Chla_0.2_pct":"Chla_20_pct", names_to = "size", values_to = "pct") %>%
  unite(cycle_CTD_exp, c(cycle_name,CTD, exp), sep = "_", remove = FALSE)
p <- sf_chl_long %>%
  filter(depth <= 100) %>%
  #filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=pct, y= depth, colour = size)) + 
    #geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_CTD_exp)+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (%)") +
  xlim(0,100) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
```
## Only experiment noon - percent
```{r}
sf_chl_long <- chl %>%
  pivot_longer(cols = "Chla_0.2_pct":"Chla_20_pct", names_to = "size", values_to = "pct") %>%
  unite(cycle_CTD_exp, c(cycle_name,CTD, exp), sep = "_", remove = FALSE) %>%
  filter(time == "noon") %>%
  filter(!(is.na(exp)))
p <- sf_chl_long %>%
  filter(depth <= 100) %>%
  #filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=pct, y= depth, colour = size)) + 
    #geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_CTD_exp)+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (%)") +
  xlim(0,100) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
```
## Only experiment noon 
```{r}
sf_chl_long <- chl %>%
  pivot_longer(cols = "Chla_0.2":"Chla_20", names_to = "size", values_to = "chla") %>%
  unite(cycle_exp, c(cycle_name,exp), sep = "_", remove = FALSE) %>%
  filter(time == "noon") %>%
  filter(!(is.na(exp)))
p <- sf_chl_long %>%
  filter(depth <= 100) %>%
  #filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=chla, y= depth, colour = size)) + 
    #geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_exp, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (mgC/m3)") +
  ggtitle("Noon") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
pdf("figures/2_NPP chla/SFchla_exp_depth_noon.pdf", height=4, width=6) ; plot(p) ; dev.off()
```
## proportion of size fraction - average percent - separate SA1-a and SA1-b
```{r,eval=FALSE}
sf_mean <- chl %>%
  filter(!(CTD == "U9104")) %>%
  group_by(cycle_2, cycle_name_2, depth) %>%
  summarise("0.2" = mean(Chla_0.2_pct),
            "2" = mean(Chla_2_pct),
            "20" = mean(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "mean")

sf_sd <- chl %>%
  filter(!(CTD == "U9104")) %>%
  group_by(cycle_2, cycle_name_2, depth) %>%
  summarise("0.2" = sd(Chla_0.2_pct),
            "2" = sd(Chla_2_pct),
            "20" = sd(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "sd")

sf_pct <- full_join(sf_mean, sf_sd)

p <- sf_pct %>%
  filter(depth <= 100) %>%
  filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=mean, y= depth, colour = size)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name_2)+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (%)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
```

##  proportion of size fraction - average percent - SA1 together - separate am and noon - ignore.
Looks the same. will combine from now.
```{r, eval=FALSE}
sf_mean <- chl %>%
  filter(!(CTD == "U9104")) %>%
  group_by(cycle, cycle_name, depth, time) %>%
  summarise("0.2" = mean(Chla_0.2_pct),
            "2" = mean(Chla_2_pct),
            "20" = mean(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "mean")

sf_sd <- chl %>%
  filter(!(CTD == "U9104")) %>%
  group_by(cycle, cycle_name, depth, time) %>%
  summarise("0.2" = sd(Chla_0.2_pct),
            "2" = sd(Chla_2_pct),
            "20" = sd(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "sd")

sf_pct <- full_join(sf_mean, sf_sd)

p <- sf_pct %>%
  filter(depth <= 100) %>%
  filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=mean, y= depth, colour = size)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(time~cycle_name)+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (%)") +
  xlim(0,100) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
```

##  proportion of size fraction - average percent - SA1 together 
Looks the same. will combine from now.
```{r}
sf_mean <- chl %>%
  # filter(!(CTD == "U9104")) %>%
  group_by(cycle, cycle_name, depth) %>%
  summarise("0.2" = mean(Chla_0.2_pct),
            "2" = mean(Chla_2_pct),
            "20" = mean(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "mean")

sf_sd <- chl %>%
  # filter(!(CTD == "U9104")) %>%
  group_by(cycle, cycle_name, depth) %>%
  summarise("0.2" = sd(Chla_0.2_pct),
            "2" = sd(Chla_2_pct),
            "20" = sd(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "sd")

sf_pct <- full_join(sf_mean, sf_sd)

p <- sf_pct %>%
  filter(depth <= 100) %>%
  filter(!is.na(mean)) %>% #so that the lines can connect over NA values.
  ggplot(aes(x=mean, y= depth, colour = size)) + 
    geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name)+
  ylab("Depth (m)")+
  xlab("Size Fraction Chla (%)") +
  xlim(0,100) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p

# pdf("figures/NPP chla/SFchla_avg_depth.pdf", height=4, width=6) ; plot(p) ; dev.off()
```

#barplot average
```{r}
p <- sf_pct %>%
  filter(depth <= 100) %>%
  ggplot()+
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd, x= cycle_name), width=.1) +
  geom_bar(aes(x=cycle_name, y= mean, fill=factor(size, levels = c("20", "2", "0.2"))), stat="identity", position = "fill")+
  ylab("Size Fraction Chla (%)")+
  xlab("Cycle")+
  labs(fill="Size fraction")

p

# pdf("figures/NPP chla/SFchla_avg_barplot.pdf", height=4, width=6) ; plot(p) ; dev.off()

```

