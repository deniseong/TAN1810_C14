---
title: "C14 cold data"
author: "Denise Ong"
date: "2/28/2021"
output: pdf_document
---
```{r setup, include=FALSE}
  knitr::opts_chunk$set(message=FALSE,
                        warning=FALSE,
                        cache=TRUE,
                        tidy=FALSE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(broom)
library(ggpubr)
library(stringr)
library(RColorBrewer)
library(dplyr)
```

Denise - Comments on 10 March 2021: 
- The units is (mgC/m3/day).
- cycle 3: exp 7 dark values are very high.
- How to calculate integrated PP rates??

# Read table for C14 cold values, merge for cycle and experiment number. Add new column to indicate dark. Added missing cycle and experiment information based on voyage report.
```{r}
C14_cold_raw <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.1.xlsx", sheet = "Cold 14C - Pico Results", skip = 5,  n_max = 93) %>%
  select (`Unique code or sample identifier`,`Station`,`Depth m`, `Sample ID`, `DPM to full volume`, `SA_dpm_mL`, `DIC`, `NPP_cold`, `NPP_standard`)  %>%
  dplyr::rename(name = `Unique code or sample identifier`,
            station = `Station`,
            depth = `Depth m`,
            sample_id = `Sample ID`,
            DPM_full = `DPM to full volume`,
            SA = `SA_dpm_mL`) %>%
   add_column(dark = NA) %>% #mutate(dark = case_when (str_detect(name,"D") ~ TRUE, TRUE~FALSE))
  filter(!(depth == 200))


#use the "complete data TAN1810" sheet for the experiment details.
C14_hot <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.0.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `SAMPLE`, `STN`, `DEPTH`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            sample = `SAMPLE`, 
            station = `STN`,
            depth = `DEPTH`)%>%
    distinct()

C14_cold <- right_join(C14_hot, C14_cold_raw) %>%
  na_if("missing")
C14_cold$cycle <- as.character(C14_cold$cycle) 
C14_cold$exp <- as.character(C14_cold$exp)
C14_cold$NPP_standard <- as.double(C14_cold$NPP_standard)
# Dark column. Create empty col then use grep to fill in.
C14_cold$dark <- as.character(C14_cold$dark)
C14_cold$dark[grep("D", C14_cold$name)] = "dark"
C14_cold$dark <- ifelse(is.na(C14_cold$dark), 
             'light', C14_cold$dark)
#C14_cold$dar[is.na(C14_cold$dar)] <- "light"
#Add missing cycle and sample details, based on the voyage report.
C14_cold$cycle[grep("U9106", C14_cold$name)] = "1"
C14_cold$exp[grep("U9106", C14_cold$name)] = "2"
C14_cold$sample[grep("40", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9164", C14_cold$name)] = "5"
C14_cold$sample[grep("70", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9167", C14_cold$name)] = "5"
C14_cold$sample[grep("12", C14_cold$name)] = "SUR"
C14_cold$sample[grep("60", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9136", C14_cold$name)] = "2"
C14_cold$exp[grep("U9136", C14_cold$name)] = "6"

C14_cold
```
Calculations for NPP_cold and NPP_standard have already been done. Assume that the values are correct.

# remove dark values
```{r}
cold_dark_NPP <- C14_cold %>% 
  filter(dark == "dark") %>%
  filter(!(cycle ==3 & exp == 7)) %>% #very high values. Check if it is a dark vial?
  dplyr::rename(NPP_cold_dark = NPP_cold)  %>%
  dplyr::rename(NPP_standard_dark = NPP_standard)%>%
  select(cycle, exp, sample,NPP_cold_dark, NPP_standard_dark)
cold_dark_NPP
# Check the values of dpm dark with histogram. The values are normally distributed, concentrated around the mean.
hist(cold_dark_NPP$NPP_cold_dark)
hist(cold_dark_NPP$NPP_standard_dark)
mean(cold_dark_NPP$NPP_cold_dark)
mean(cold_dark_NPP$NPP_standard_dark, na.rm = TRUE) #na.rm function to ignore NA values
```
Means are ok, dark values are low.

# Corrected values = light - dark (same method as C14 hot calculations)
```{r}
cold_corrected <- full_join(C14_cold,cold_dark_NPP) %>% 
  filter (dark == "light") %>% 
  # DV - The next line replace dpm_dark to average dpm_dark if no value. Checked with histogram above.
  mutate(NPP_cold_dark = case_when (is.na(NPP_cold_dark) ~ mean(NPP_cold_dark, na.rm = TRUE),
                               TRUE ~ NPP_cold_dark)) %>%
 
  mutate(NPP_standard_dark = case_when (is.na(NPP_standard_dark) ~ mean(NPP_standard_dark, na.rm = TRUE), TRUE ~ NPP_standard_dark))  %>%
  mutate(NPP_cold_corrected = NPP_cold - NPP_cold_dark)%>%
  mutate(NPP_standard_corrected = NPP_standard - NPP_standard_dark) %>%
  select(cycle, exp, sample,  station, depth, name, NPP_cold_corrected,NPP_standard_corrected)

cold_corrected
```

#Rename and reorganise the table. The NPP of each experiment is the mean of the replicates.
```{r}
cold_mean_vial<- cold_corrected %>%
  group_by(cycle, exp, sample) %>%
  dplyr::summarise(NPP_cold_mean = mean(NPP_cold_corrected, na.rm = TRUE))%>%
  ungroup()

cold_mean_standard <- cold_corrected %>%
  group_by(cycle, exp, sample) %>%
  dplyr::summarise(NPP_standard_mean = mean(NPP_standard_corrected, na.rm = TRUE))

cold_mean <- full_join (cold_mean_standard,cold_mean_vial)%>%
  mutate(difference = NPP_standard_mean - NPP_cold_mean) %>%
  mutate(cycle_name = recode(cycle, "1" = "Subantarctic 1",
                                    "2" = "Subantarctic 2",
                                    "3" = "Subtropical 1",
                                    "4" = "Subtropical 2",
                                    "5" = "Subantarctic 3")) %>% 
  mutate(exp_name = recode(exp, "2" = "SA1, exp 2",
                                "3" = "SA2, exp 3",
                                "4" = "SA2, exp 4",
                                "5" = "SA2, exp 5",
                                "6" = "SA2, exp 6",
                                "7" = "ST1, exp 7",
                                "8" = "ST1, exp 8",
                                "9" = "ST2, exp 9",
                                "10" = "ST2, exp 10",
                                "11" = "SA3, exp 11"))%>%
  mutate(exp_name = case_when (is.na(exp_name) ~ "SA3",
                               TRUE ~ exp_name)) %>%
  dplyr::rename(standard=NPP_standard_mean)%>%
  dplyr::rename(cold=NPP_cold_mean) %>%
  select(cycle, cycle_name, exp, exp_name, sample, standard, cold, difference)%>%
  arrange(exp_name)

cold_mean_pivot <- cold_mean %>%
  pivot_longer(standard:cold,
               names_to = "type",
               values_to = "NPP")
cold_mean
cold_mean_pivot
```

#summary statistics - something wrong here. Object cold not found
```{r, eval=FALSE}
cold_mean$sample<- as.character(cold_mean$sample)
summary_table <- cold_mean %>% 
  group_by(cycle, sample) %>% 
  summarise(standard_mean = mean(standard))%>%
  summarise(cold_mean = mean(cold)) 
summary_table
```

## Cold vs standard between cycles. Data is using the means of each experiment. Error bars are the differences between each experiment, do not reflect the differences between replicates.
```{r}
#for error bars
data_summary_1 <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

df1 <- data_summary_1(cold_mean_pivot, varname="NPP", 
                    groupnames=c("type", "cycle_name"))
df1$cycle_name=as.factor(df1$cycle_name)
head(df1)

cold_mean_bar <- ggplot(data=df1, aes(x=cycle_name, y=NPP, fill=type))+
  geom_bar(stat="identity", color="black", position=position_dodge()) +
  theme_bw()+  
  geom_errorbar(aes(ymin=NPP, ymax=NPP+sd), width=.2,
                 position=position_dodge(.9)) +
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Cycle") +
  labs(fill="Experiment type")+
  scale_fill_brewer(palette = "Set2")


#ggsave("../figures/c14_cold_all.png", width = 7, height = 4)


cold_mean_bar               
```
Overall difference betwen cold and standard. In this graph the difference does not look too big, but it is masked by combining the surface and DCM together, and some experiments in the same cycle have very large differences between them 

## Cold vs standard between experiments. Data is using the means of each experiment. Error bars are the differences between surface and DCM, do not reflect the differences between replicates. Difficult to see, not useful diagram.
```{r}
#for error bars
data_summary_2 <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

df2 <- data_summary_2(cold_mean_pivot, varname="NPP", 
                    groupnames=c("type", "exp_name"))
df2$exp=as.factor(df2$exp)

head(df2)

cold_mean_pivot$exp <- factor(cold_mean_pivot$exp,levels = c("3", "4", "5", "6", "7", "8", "1", "2", "9", "10", "11"))
cold_exp_bar <- ggplot(data=df2, aes(x=exp_name, y=NPP, fill=type))+
  geom_bar(stat="identity", position=position_dodge()) +
  theme_bw()+  
  geom_errorbar(aes(ymin=NPP-sd, ymax=NPP+sd), width=.2,
                 position=position_dodge(.9)) +
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Experiment") +
  labs(fill="Experiment type")+
  scale_fill_brewer(palette = "Set2")

cold_exp_bar
```
Looking at experiments, the difference does not look big either.

#Comparing standard vs cold experiment, keeping either surface or DCM constant. Use cold_corrected for error bars of replicates.

```{r}
#Edit data frame "cold_corrected" with replicates
cold_corrected_1 <- cold_corrected %>%
  mutate(difference = NPP_standard_corrected - NPP_cold_corrected) %>%
  mutate(cycle_name = recode(cycle, "1" = "Subantarctic 1",
                                    "2" = "Subantarctic 2",
                                    "3" = "Subtropical 1",
                                    "4" = "Subtropical 2",
                                    "5" = "Subantarctic 3")) %>% 
  mutate(exp_name = recode(exp, "2" = "SA1, exp 2",
                                "3" = "SA2, exp 3",
                                "4" = "SA2, exp 4",
                                "5" = "SA2, exp 5",
                                "6" = "SA2, exp 6",
                                "7" = "ST1, exp 7",
                                "8" = "ST1, exp 8",
                                "9" = "ST2, exp 9",
                                "10" = "ST2, exp 10",
                                "11" = "SA3, exp 11"))%>%
  mutate(exp_name = case_when (is.na(exp_name) ~ "SA3",
                               TRUE ~ exp_name))%>%
  select(cycle, cycle_name, exp, exp_name, sample, NPP_standard_corrected, NPP_cold_corrected)%>%
  arrange(exp_name)
cold_corrected_pivot <- cold_corrected_1 %>%
  pivot_longer(NPP_standard_corrected:NPP_cold_corrected,
               names_to = "type",
               values_to = "NPP")
```

# Cold vs standard at surface
```{r}
cold_surface <- cold_corrected_pivot %>%
  filter(sample == "SUR")

data_summary_3 <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

df3 <- data_summary_3(cold_surface, varname="NPP", 
                    groupnames=c("type", "exp_name"))
df3$exp=as.factor(df3$exp)

head(df3)

surface_plot <- ggplot(data=df3, aes(x=exp_name, y= NPP, fill = type))+
  geom_bar(stat="identity", position=position_dodge())+
  theme_bw()+
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Experiment") +
  labs(fill="Experiment type", title = "NPP at surface")+
  scale_fill_brewer(palette = "Set2")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_errorbar(aes(ymin=NPP-sd, ymax=NPP+sd), width=.2,
                 position=position_dodge(.9))
surface_plot

#ggsave("../figures/c14_cold_surface.png", width = 7, height = 4)
```

#Cold vs standard at DCM
```{r}

cold_dcm <- cold_corrected_pivot %>%
  filter(sample =="DCM")

data_summary_4 <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

df4 <- data_summary_4(cold_dcm, varname="NPP", 
                    groupnames=c("type", "exp_name"))
df4$exp=as.factor(df4$exp)

head(df4)


DCM_plot <- ggplot(data=df4, aes(x=exp_name, y= NPP, fill = type))+
  geom_bar(stat="identity", position=position_dodge())+
  theme_bw()+
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Experiment") +
  labs(fill="Experiment type", title = "NPP at DCM")+
  scale_fill_brewer(palette = "Set2")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  geom_errorbar(aes(ymin=NPP-sd, ymax=NPP+sd), width=.2,
                 position=position_dodge(.9))
DCM_plot

#ggsave("../figures/c14_cold_DCM.png", width = 7, height = 4)
```

surface vs DCM, keeping the type of experiment (standard vs cold) constant.
```{r}
cold_mean$sample <- factor(cold_mean$sample,levels = c("SUR", "DCM"))

#standard values only
cold_standard_plot <- 
  ggplot(data=cold_mean, aes(x=exp_name, y= standard, fill = sample))+
  geom_bar(stat="identity", position=position_dodge())+
  theme_bw()+
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Experiment") +
  labs(fill="Depth", title = "NPP of standard cold experiment")+
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
cold_standard_plot

ggsave("../figures/c14_cold_standard.png", width = 7, height = 4)

#cold values only
cold_plot <- ggplot(data=cold_mean, aes(x=exp_name, y= cold, fill = sample))+
  geom_bar(stat="identity", position=position_dodge())+
  theme_bw()+
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Experiment") +
  labs(fill="Depth", title = "NPP of cold experiment")+
  scale_fill_brewer(palette = "Set2")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
cold_plot

#ggsave("../figures/c14_cold_cold.png", width = 7, height = 4)
```


Only standard cold
```{r}
#for error bars
data_summary_w <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

df2 <- data_summary_w(cold_mean, varname="standard", 
                    groupnames=c("sample", "cycle_name"))
df2$cycle_name=as.factor(df2$cycle_name)

head(df2)
#standard values only
cold_standard_cycle_plot <- 
  ggplot(data=df2, aes(x=cycle_name, y= standard, fill = sample))+
  geom_bar(stat="identity", position=position_dodge())+
  theme_bw()+
  geom_errorbar(aes(ymin=standard-sd, ymax=standard+sd), width=.2,
                 position=position_dodge(.9)) +
  ylab("Net Primary Production (mgC/m3/day)")+
  xlab("Cycle") +
  labs(fill="Depth", title = "NPP of standard")+
  scale_fill_brewer(palette = "Set2") 
cold_standard_cycle_plot

#ggsave("../figures/c14_cold_cycle_standard.png", width = 7, height = 4)

```

#compare cold readings against the total sum npp
```{r}
summary_table <- cold_mean %>%
  dplyr::group_by(cycle, exp, sample) %>%
  dplyr::summarise(standard_mean = mean(standard), cold_mean = mean(cold) )
            
summary_table
            
group_npp <- readxl::read_excel("../data_used/C14_sum npp per group.xlsx")
group_npp

npp_compare <- full_join(group_npp, summary_table)
npp_compare
```


cycle 3: exp 7 : surface and DCM have very large differences (22-24) between standard and cold. 
- for DCM standard is too low compared to cold.
- for SUR standard is too high. High size fraction, increases variability.
- all replicates have large difference.

Cycle 4: exp 10 : surface and DCM also have moderate differences (around 8).
- for both standard are lower than cold.
- all replicates have large difference

The rest are similar, usually <1, maximum 5. 
cycle 1: exp 2: SUR, one has difference of 12.9. Cold is higher. - remove?



standard fractionated?- from Andres
- to get standard fractionated NPP 
- nutrients
- pigments
standard is too high compared to the exp. Its on the high size fraction, increase variability
standard is too low. 