---
title: "Calculate group NPP"
author: "Denise Ong"
date: "3/11/2021"
output: html_document
---

C14 group rates. using method 2 - calculate rate per vial. 
create table of npp group rates based on multiplying group-specific rates with cell conc. 
npp units mgC/m3/day


```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("init_files", "init.R")) #for libraries
source(here("init_files", "init_markdown.R")) #for markdown libraries
```


# Read data for group specific rates
```{r}
pp_rates <- readxl::read_excel(here("group_rates_output", "C14_rates per group_method2.xlsx")) %>%
  rename(depth = `sample`) %>%
  mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(water_mass = recode(cycle, "1" = "SA",
                                    "2" = "SA",
                                    "3" = "ST",
                                    "4" = "ST",
                                    "5" = "SA"))
```

# Include experiment details - CTD number
```{r}
#use the "complete data TAN1810" sheet for the experiment details.
C14_hot <- readxl::read_excel(here("data_used", "TAN1810_14C-Pico_25052020_QA_1.2.xlsx"), sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `SAMPLE`, `STN`, `DEPTH`, `CTD#`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            depth = `SAMPLE`, 
            station = `STN`,
            depth_m = `DEPTH`,
            ctd = `CTD#`)%>%
    distinct()%>%
  drop_na()

C14_hot$cycle <- as.character(C14_hot$cycle) 
C14_hot$exp <- as.character(C14_hot$exp)
pp_rates$cycle <- as.character(pp_rates$cycle) 
pp_rates$exp <- as.character(pp_rates$exp)

pp_rates <- full_join(pp_rates, C14_hot) %>%
  filter(!is.na(pp)) 

```


# Add cell conc values
- error in TAN1810_14C-Pico_25052020_QA_1.0.xlsx, U1941 CHANGED TO U9141. excel sheet change to 1.2
- station U9144 has no counts of FCM at 40 m, so using the one at 35 m
- Missing U9133 - cycle 2, experiment 5. julian day 309, 5 nov 2018, station 176. Checked the FCM CTD cast number against Moira "ALL_CTDS_BottleData", missing FCM counts for this day. I have decided to take the average counts of Nov 4 and Nov 6. 

```{r}
fcm_raw <- readxl::read_xlsx(here("data_used", "MD FCM DATA.xlsx"), sheet= "INITS PROFILES_CYCLE", skip = 2) %>%
  select(MD, CTD, CYCLE, DEPTH_C14, `SYN/ML`, `PICO/mL`, `NANO/mL`) %>%
  dplyr::rename(cycle =`CYCLE`,
                ctd = `CTD`,
                depth_m = `DEPTH_C14`, # changed U9144 depth
                Syn = `SYN/ML`,
                Pico = `PICO/mL`,
                Nano = `NANO/mL`) %>% 
  pivot_longer(Syn:Nano, 
               names_to = "population",
               values_to = "conc_ml") %>%
  filter(!is.na(conc_ml))
  
fcm_raw$cycle<-as.character(fcm_raw$cycle)
fcm <- left_join(pp_rates, fcm_raw) %>%
  distinct() #left join creates repeat rows

# round the column conc_ml
fcm$conc_ml <- round(fcm$conc_ml)
```

```{r}
#calculate npp per group
fcm <- fcm %>%
  arrange(exp) %>%
  mutate(conc_m3 = conc_ml*10^6)%>% # change units from ml to m3
  mutate(npp = (pp*conc_m3*24*10^(-12))) # multiply by 24 to change from per hour to day, multiply by 10^-12 to convert from fg to mg

writexl::write_xlsx(fcm, "group_rates_output/Rates_cell_npp_method2.xlsx")

```

# Alternative solution to calculate the mean conc for cycle 2
```{r, eval=FALSE}
#calculate the mean conc for cycle 2, missing data for cycle 2 exp 5.
mean_conc <- fcm %>%
  filter(cycle == 2) %>%
  filter(sample == "SUR") %>%
  select(cycle, exp, sample,  population, conc_ml) %>%
  group_by(cycle, sample, population) %>%
  summarise(mean_conc_ml= mean(conc_ml, na.rm = TRUE)) %>% 
  add_column(exp = 5)
mean_conc$exp <-as.character(mean_conc$exp)

#create new column, include mean conc for missing data
fcm_corrected <- full_join(mean_conc, fcm) %>%
  replace_na(list(mean_conc_ml = 0, conc_ml = 0)) %>%
  mutate(conc_corrected_ml = mean_conc_ml+ conc_ml) %>%
  select(-mean_conc_ml,  -conc_ml)

#calculate npp per group
fcm_corrected$exp <- as.numeric(fcm_corrected$exp)
fcm_corrected <- fcm_corrected %>%
  arrange(exp) %>%
  mutate(conc_m3 = conc_corrected_ml*10^6)%>% # change units from ml to m3
  mutate(npp = (pp*conc_m3*24*10^(-12))) # multiply by 24 to change from per hour to day, multiply by 10^-12 to convert from fg to mg
fcm_corrected$exp <- as.character(fcm_corrected$exp)

#arrange, add cycle names
fcm_corrected$population <- factor(fcm_corrected$population,levels = c("Syn", "Pico", "Nano")) 
fcm_corrected <- fcm_corrected%>% mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(water_mass = recode(cycle, "1" = "SA",
                                    "2" = "SA",
                                    "3" = "ST",
                                    "4" = "ST",
                                    "5" = "SA")) %>%
    mutate(population_name= recode(population, "Syn" = "Synechococcus",
                                             "Pico" = "Picoeukaryotes",
                                             "Nano" = "Nanoeukaryotes"))

writexl::write_xlsx(fcm_corrected, "npp_group.xlsx")

```

## export table for stats
```{r}
pp_stats <- fcm %>%
  group_by(population,cycle_name,depth) %>%
  summarise(mean_pp = mean(pp),
            SD_pp = sd(pp),
            mean_npp = mean(npp),
            SD_npp = sd(npp),
            mean_conc_ml = mean(conc_ml),
            SD_conc_ml = sd(conc_ml)) 
  #mutate(mean_sd = str_c(mean, SD, sep = "_")) %>%
  

pp_stats
writexl::write_xlsx(pp_stats, "group_rates_output/RateM2_summary.xlsx")

```

