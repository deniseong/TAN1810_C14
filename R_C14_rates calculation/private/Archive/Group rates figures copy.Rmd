---
title: "ACOP poster figure"
author: "Denise Ong"
date: "3/11/2021"
output: html_document
---

Poster figure for ACOP. C14 group rates. using method 2 - calculate rate per vial. 
  filter(!(cycle == "4"& exp == "9"& depth == "DCM"& population == "Nano"& vial == "B")) %>%
  filter(!(cycle == "1"& exp == "2"& depth == "SUR"& population == "Pico"& vial == "A")) 



```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("init_files", "init.R")) #for libraries
source(here("init_files", "init_markdown.R")) #for markdown libraries
```


# pp rates per cell
```{r}
pp_rates <- readxl::read_excel("data_used/C14_rates per group_method2.xlsx")  %>%
  mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(water_mass = recode(cycle, "1" = "SA",
                                    "2" = "SA",
                                    "3" = "ST",
                                    "4" = "ST",
                                    "5" = "SA")) %>%
  mutate(depth_cat = recode(sample, "SUR" = "Surface",
                                "DCM" = "DCM")) %>%
  mutate(population_name= recode(population, "Syn" = "Synechococcus",
                                             "Pico" = "Picoeukaryotes",
                                             "Nano" = "Nanoeukaryotes")) 

pp_rates <- pp_rates %>%
  filter(!(cycle == "4"& exp == "9"& sample == "DCM"& population == "Nano"& vial == "B")) %>%
  filter(!(cycle == "1"& exp == "2"& sample == "SUR"& population == "Pico"& vial == "A")) %>%
  mutate(water_depth = str_c(water_mass, depth_cat, sep = "_"))
```

#Colours for cycle
```{r}
colours_cycle <- readxl::read_excel("colours_cycle.xlsx")
colours_cycle <- structure(colours_cycle$colour,.Names=colours_cycle$cycle)
```

```{r}
pp_rates$water_mass <- factor(pp_rates$water_mass, levels = c("ST", "SA"))
pp_rates$cycle_name <- factor(pp_rates$cycle_name, levels = c("ST1", "ST2", "SA1", "SA2", "SA3"))
pp_rates$population_name <- factor(pp_rates$population_name, levels = c("Synechococcus", "Picoeukaryotes", "Nanoeukaryotes"))
pp_rates$population <- factor(pp_rates$population, levels = c("Syn", "Pico", "Nano"))
#pp_rates$depth_cat <- factor(pp_rates$depth_cat, levels = c("Surface", "DCM"))
p1 <- pp_rates %>%
  ggplot(aes(x = population, y = pp, color = cycle_name, shape = depth_cat))  +
  geom_jitter(width = 0.05) +
  xlab("Phytoplankton group") +
  ylab(expression(Primary~Production~(fgC~cell^-1~h^-1))) +
  theme_bw() +
  #facet_grid(.~ water_mass) +
  scale_color_manual(values = colours_cycle, name = "Station") +
  scale_shape_discrete(name = "Depth") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l") 
p1

p2 <- pp_rates %>%
  ggplot(aes(x = population, y = pp))  +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = cycle_name, shape = depth_cat), width = 0.1) +
  xlab("Phytoplankton group") +
  ylab(expression(Primary~Production~(fgC~cell^-1~h^-1))) +
  theme_bw() +
  facet_grid(.~ water_mass) +
  scale_color_manual(values = colours_cycle, name = "Station") +
  scale_shape_discrete(name = "Depth") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l") 

p2

p3 <- pp_rates %>%
  ggplot(aes(x = water_mass, y = pp))  +
#  geom_violin()+
# geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = cycle_name, shape = depth_cat), width = 0.1) +
  geom_boxplot(width=0.5, alpha = 0)+
  #geom_boxplot(width=0.5, alpha = 0, color = "#424242")+
  xlab("Water mass") +
  ylab(expression(Primary~Production~(fgC~cell^-1~h^-1))) +
  theme_bw() +
  facet_grid(.~ population) +
  scale_color_manual(values = colours_cycle, name = "Station") +
  scale_shape_discrete(name = "Depth") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l") +
  theme(legend.position="bottom", 
       panel.spacing.x = unit(0,"line"))

p3
#pdf("figures/GRC/pp_rates_group_2.pdf", height=4, width=6) ; plot(p3) ; dev.off()


p4 <- pp_rates %>%
  ggplot(aes(x = sample, y = pp))  +
#  geom_violin()+
# geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = cycle_name, shape = depth_cat), width = 0.2) +
  geom_boxplot( alpha = 0)+
  #geom_boxplot(width=0.5, alpha = 0, color = "#424242")+
  xlab("Water mass") +
  ylab(expression(Primary~Production~(fgC~cell^-1~day^-1))) +
  theme_bw() +
  facet_grid(.~ population) +
  scale_color_manual(values = colours_cycle, name = "Station") +
  scale_shape_discrete(name = "Depth") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l") +
  theme(legend.position="bottom", 
       panel.spacing.x = unit(0,"line"))
p4

#pdf("figures/GRC/pp_rates_group.pdf", height=4, width=6) ; plot(p4) ; dev.off()

```

# NPP rates per group
error in TAN1810_14C-Pico_25052020_QA_1.0.xlsx, U1941 CHANGED TO U9141. excel sheet change to 1.2
Missing U9133 - cycle 2, experiment 5
```{r}
fcm_raw <- readxl::read_xlsx("data_used/MD FCM DATA.xlsx", skip = 2) %>%
  select(MD, CTD, DEPTH, `SYN/ML`, `PICO/mL`, `NANO/mL`) %>%
  dplyr::rename(ctd = `CTD`,
         depth_m = `DEPTH`,
         Syn = `SYN/ML`,
         Pico = `PICO/mL`,
         Nano = `NANO/mL`) %>% 
  pivot_longer(Syn:Nano, 
               names_to = "population",
               values_to = "conc") %>%
  filter(!is.na(conc))

#use the "complete data TAN1810" sheet for the experiment details.
C14_hot <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.2.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `SAMPLE`, `STN`, `DEPTH`, `CTD#`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            depth = `SAMPLE`, 
            station = `STN`,
            depth_m = `DEPTH`,
            ctd = `CTD#`)%>%
    distinct()%>%
  drop_na()

C14_hot$cycle <- as.character(C14_hot$cycle) 
C14_hot$exp <- as.character(C14_hot$exp)
pp_rates$cycle <- as.character(pp_rates$cycle) 
pp_rates$exp <- as.character(pp_rates$exp)

pp_rates <- full_join(pp_rates, C14_hot) %>%
  filter(!is.na(pp)) 

fcm <- left_join(pp_rates, fcm_raw) 
fcm$exp<-as.character(fcm$exp)

#calculate the mean conc for cycle 2, missing data for cycle 2 exp 5.
mean_conc <- fcm %>%
  filter(cycle == 2) %>%
  filter(sample == "SUR") %>%
  select(cycle, exp, sample,  population, conc) %>%
  group_by(cycle, sample, population) %>%
  summarise(mean_conc= mean(conc, na.rm = TRUE)) %>% 
  add_column(exp = 5)
mean_conc$exp <-as.character(mean_conc$exp)

#create new column, include mean conc for missing data
fcm_corrected <- full_join(mean_conc, fcm) %>%
  replace_na(list(mean_conc = 0, conc = 0)) %>%
  mutate(conc_corrected = mean_conc+ conc) %>%
  select(-mean_conc,  -conc)

#calculate npp per group
fcm_corrected$exp <- as.numeric(fcm_corrected$exp)
fcm_corrected <- fcm_corrected %>%
  arrange(exp) %>%
  mutate(conc_m3 = conc_corrected*10^6)%>% # change units from ml to m3
  mutate(npp = (pp*conc_m3*24*10^(-12))) # multiply by 24 to change from per hour to day, multiply by 10^-12 to convert from fg to mg
fcm_corrected$exp <- as.character(fcm_corrected$exp)

#arrange, add cycle names
fcm_corrected$population <- factor(fcm_corrected$population,levels = c("Syn", "Pico", "Nano")) 
fcm_corrected <- fcm_corrected%>% mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(water_mass = recode(cycle, "1" = "SA",
                                    "2" = "SA",
                                    "3" = "ST",
                                    "4" = "ST",
                                    "5" = "SA")) %>%
    mutate(population_name= recode(population, "Syn" = "Synechococcus",
                                             "Pico" = "Picoeukaryotes",
                                             "Nano" = "Nanoeukaryotes"))

writexl::write_xlsx(fcm_corrected, "npp_group.xlsx")

```

## export table for stats
```{r}
pp_stats <- fcm_corrected %>%
  group_by(population_name,cycle_name) %>%
  summarise(mean = mean(pp),
            SD = sd(pp)) 
  #mutate(mean_sd = str_c(mean, SD, sep = "_")) %>%
  

pp_stats


npp_stats <- fcm_corrected %>%
  group_by(population_name,cycle_name) %>%
  summarise(mean = mean(npp),
            SD = sd(npp)) 
  #mutate(mean_sd = str_c(mean, SD, sep = "_")) %>%
  

npp_stats


#writexl::write_xlsx(stats, "subclade_stats.xlsx")
```

```{r}
library(xtable)
print(xtable(stats_join),
      comment = FALSE)


table<-  readxl::read_excel(here("subclade_stats_2.0.xlsx")) %>%
  mutate_if(is.numeric,round,digits=2)

table <- read.csv("filt_subclade_percent_wide_summary_2.0.txt", sep = "\t")
library(xtable)
print(xtable(table),
      comment = FALSE,
      include.rownames=FALSE,
      digits=-3)

```


```{r}
fcm_corrected$cycle_name<-as.character(fcm_corrected$cycle_name)
fcm_corrected$cycle_name <- factor(fcm_corrected$cycle_name, levels = c("ST1", "ST2", "SA1", "SA2", "SA3"))
fcm_corrected$population_name <- factor(fcm_corrected$population_name, levels = c("Synechococcus", "Picoeukaryotes", "Nanoeukaryotes"))
fcm_corrected$population <- factor(fcm_corrected$population, levels = c("Syn", "Pico", "Nano"))
fcm_corrected$water_mass <- factor(fcm_corrected$water_mass, levels = c("ST", "SA"))

p5 <- fcm_corrected %>%
  ggplot(aes(x = population_name, y = npp, color = cycle_name, shape = sample))  +
  geom_jitter(width = 0.05) +
  xlab("Phytoplankton group") +
  ylab(expression(Net~Primary~Production~(mgC~m^3~day^-1))) +
  theme_bw() +
  #facet_grid(.~ water_mass) +
  scale_color_manual(values = colours_cycle) +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l")

p5

p4 <- fcm_corrected %>%
  ggplot(aes(x = population_name, y = npp)) +
  geom_boxplot() + 
  geom_jitter(aes(color = cycle_name, shape = sample), width = 0.1) +
  scale_color_manual(values = colours_cycle) +
  ylab(expression(Net~Primary~Production~(mgC~m^3~day^-1)))+
  theme_bw() +
  facet_grid(.~ water_mass) +
  #xlab("Cycle")+
  scale_y_continuous(trans='log10')+
  annotation_logticks(sides = "l")
p4

p6 <- fcm_corrected %>%
  ggplot(aes(x = water_mass, y = npp))  +
 # geom_violin()+
  #geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = cycle_name, shape = sample), width = 0.1) +
  geom_boxplot(width=0.5, alpha = 0, color = "#424242")+
#  stat_summary(fun.y=median, geom="point", size=2, color="#424242")+
  xlab("Water mass") +
  ylab(expression(Net~Primary~Production~(mgC~m^3~day^-1))) +
  theme_bw() +
  facet_grid(.~ population) +
  scale_color_manual(values = colours_cycle, name = "Station") +
  scale_shape_discrete(name = "Depth") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l") +
  theme(legend.position="bottom")

p6
pdf("figures/pp_total.pdf", height=4, width=6) ; plot(p6) ; dev.off()
```

```{r, eval=FALSE}

library(cowplot)

prow<- plot_grid(p3 + theme(legend.position="none"),
              p9 + theme(legend.position="none"),
              p6 + theme(legend.position="none"),
              align = 'vh',
              hjust = -1,
              labels = c("A", "B", "C"),
          ncol = 3,
          nrow = 1)
legend <- get_legend(
  # create some space to the left of the legend
  p3 + theme(legend.box.margin = margin(0, 0, 0, 12))
)

g <- plot_grid(prow, legend, rel_widths = c(3, .4))
g

#pdf("figures/ACOP_figures/pp rates and total.pdf", height=4, width=8) ; plot(g) ; dev.off()


legend_b <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
g2<- plot_grid(prow, legend_b, ncol = 1, rel_heights = c(1, .1))
g2
#pdf("figures/ACOP_figures/pp rates and total3.pdf", height=4, width=10) ; plot(g2) ; dev.off()


```
# concentration of cells

```{r}
fcm_corrected$cycle_name<-as.character(fcm_corrected$cycle_name)
fcm_corrected$cycle_name <- factor(fcm_corrected$cycle_name, levels = c("ST1", "ST2", "SA1", "SA2", "SA3"))

p7 <- fcm_corrected %>%
  ggplot(aes(x = population, y = conc_))  +
  geom_boxplot()+
  geom_jitter(aes(color = cycle_name, shape = sample), width = 0.05) +
  xlab("Phytoplankton group") +
  theme_bw() +
  #facet_grid(.~ water_mass) +
  scale_color_manual(values = colours_cycle) +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l")

p7



p8 <- fcm_corrected %>%
  ggplot(aes(x = population, y = conc_m3)) +
  geom_boxplot() + 
  geom_jitter(aes(color = cycle_name, shape = sample), width = 0.1) +
  scale_color_manual(values = colours_cycle) +
  theme_bw() +
  facet_grid(.~ water_mass) +
  #xlab("Cycle")+
  scale_y_continuous(trans='log10')+
  annotation_logticks(sides = "l")
p8

p9 <- fcm_corrected %>%
  ggplot(aes(x = water_mass, y = conc_corrected))  +
    #geom_violin()+
  geom_jitter(aes(color = cycle_name, shape = sample), width = 0.1) +
  geom_boxplot(width=0.5, alpha = 0, color = "#424242") + 
  xlab("Water mass") +
  ylab("Cell concentration (No. of cells ml)")+
  theme_bw() +
  facet_grid(.~ population) +
  scale_color_manual(values = colours_cycle) +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides = "l")

p9
pdf("figures/ACOP_figures/cell_conc.pdf", height=4, width=6) ; plot(p9) ; dev.off()
```