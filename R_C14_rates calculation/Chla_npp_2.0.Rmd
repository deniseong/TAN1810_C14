---
title: "chla_npp 2.0"
author: "Denise Ong"
date: "11/28/2022"
output: html_document
---

#init
```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("init_files", "init.R")) #for libraries
source(here("init_files", "init_markdown.R")) #for markdown libraries

colours_cycle <- readxl::read_excel("init_files/colours_cycle.xlsx")
colours_cycle <- structure(colours_cycle$colour,.Names=colours_cycle$cycle)
```

#NPP data
```{r}
npp_raw <- readxl::read_excel("data_used/TAN1810_NPP_areal_2.0.xlsx")  %>%
  select(Cycle, Station, Depth, U_Cast, mean_NPP, sd_NPP, areal_PP) %>%
  distinct() %>%
  mutate(cycle_name = recode(Cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  rename(cycle = `Cycle`,
         station = `Station`,
         depth = `Depth`,
         CTD = `U_Cast`)
npp_raw$CTD <- sub("^", "U", npp_raw$CTD)

#use the "complete data TAN1810" sheet for the experiment details.
C14_hot <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.2.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `CTD#`,`STN`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            CTD = `CTD#`, 
            station = `STN`)%>%
    distinct() %>%
  filter(!is.na(cycle))
C14_hot$cycle <- as.character(C14_hot$cycle)
C14_hot$exp <- as.character(C14_hot$exp)

npp <- full_join(npp_raw, C14_hot) %>%
  unite(station_exp, c(station, exp), sep = "_", remove = FALSE) %>%
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3")) 
```

for depth group incubations.
```{r}
C14_hot_depth <- readxl::read_excel("data_used/TAN1810_14C-Pico_25052020_QA_1.2.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `CTD#`, `SAMPLE`, `STN`, `DEPTH`) %>%   
     dplyr::rename(cycle = `Cycle#`,
            exp = `EXP#`,
            CTD = `CTD#`,
            sample = `SAMPLE`, 
            station = `STN`,
            depth = `DEPTH`)%>%
    distinct() %>%
  filter(!is.na(cycle))
C14_hot$cycle <- as.character(C14_hot$cycle)
C14_hot$exp <- as.character(C14_hot$exp)
```

# Chlorophyll data
Only using PM chla as an indicator for phytoplankton biomass. 
- ADD AM/PM COLUMN FOR THE CTD. plot AM and PM separately. Only using PM chla as an indicator for phytoplankton biomass. 
- remove rows where there are some missing measurements for the SF? I think this is better so that the values are more accurate. change the way int chla is calculated? decide later.

the depth for U9104, exp 1 does not correspond to the depth usually collected. I have changed to what I think is the right depth. values are similar to the other ctds for the same cyle. - using depth_corrected
AD145 - 2 depths measured at 30 m. one should be 20 and one should be 30m. using depth_corrected values

Based on fluoresence, separate SA1-A and SA1-B. SA1-B has lower flourescence. As the exps for C14 only come from SA1-A, use SA1-A only for SA1. 
 no corresponding chla values for the same CTD for experiment 1,2,3.
## Read data
```{r}
chl <- readxl::read_excel("data_used/TAN1810_SFChla_2.0.xls", sheet = "chla_int") %>%
  select(NIWA_ID, U_Cast, cycle, cycle_2, time, exp, depth_corrected, Chla_0.2:Chla_20_pct)%>%
  filter(!is.na(cycle)) %>%
  rename(depth = `depth_corrected`,
         CTD = `U_Cast`) %>%
  mutate(cycle_name = recode(cycle, "1" = "SA1",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(cycle_name_2 = recode(cycle_2, "1a" = "SA1-a",
                                    "1b" = "SA1-b",
                                    "2" = "SA2",
                                    "3" = "ST1",
                                    "4" = "ST2",
                                    "5" = "SA3")) %>%
  mutate(cycle_name = fct_relevel(cycle_name, "ST1", "ST2", "SA1", "SA2", "SA3")) %>%
  mutate(cycle_name_2 = fct_relevel(cycle_name_2, "ST1", "ST2", "SA1-a", "SA1-b", "SA2", "SA3")) %>%
  na_if(0) %>% # replace 0% as NA as these values were not measured.
  drop_na(Chla_0.2,Chla_2, Chla_20) #remove rows where there are some missing measurements for the SF? I think this is better so that the values are more accurate. change the way int chla is calculated? decide later.

chl$cycle <- as.character(chl$cycle)
chl$CTD <- sub("^", "U", chl$CTD)
chl$exp <- as.character(chl$exp)

```

## plot chla raw data- across depth for all individual ctd
```{r}
p <-chl %>%
  filter(time == "noon") %>%
  ggplot(aes(x=SumSFChla, y= depth, colour=CTD)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  scale_y_reverse()+
  facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("noon")#+
  #scale_color_manual(values = colours_cycle)
p

```
## average and SD per cycle
```{r}
# test plot overall - facet grid by cycle
p <- chl %>%
  filter(time == "noon") %>%
  ggplot(aes(x=SumSFChla, y= depth)) + 
    geom_point() +
  geom_smooth(orientation = "y") +
  scale_y_reverse()+
  facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  ggtitle("noon") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  #scale_color_manual(values = colours_cycle)
p
#pdf("figures/NPP chla/chla_noon_depth.pdf", height=4, width=6) ; plot(p) ; dev.off()

```

## check chl to corresponding hot rates to npp rates
```{r}
p <-chl %>%
  filter(time == "noon") %>%
  filter(!is.na(exp)) %>%
  ggplot(aes(x=SumSFChla, y= depth, colour=exp)) + 
    #geom_errorbar(aes(xmin=mean_NPP-sd_NPP, xmax=mean_NPP+sd_NPP), width=.1) +
    geom_path() +
    geom_point() +
  geom_text(aes(label=exp), vjust = 0.5, hjust=1)+
  scale_y_reverse(limits = c(100,0))+
  # facet_grid(.~cycle_name_2, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
  ggtitle("Chla - noon")
p

#pdf("figures/2_NPP chla/chla_exp_depth_noon.pdf", height=4, width=6) ; plot(p) ; dev.off()


```

#integrated chla and integrated npp plot

## prepare dataframe
```{r}
#list of integrated chla and max depth sampled. 
depth <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  group_by(cycle_name, exp, CTD) %>%
  count(CTD)

check <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  group_by(cycle_name, exp, CTD) %>%
  slice_tail() %>%
  select(CTD, cycle_name, exp, depth, areal_chl) %>%
  distinct() %>%
  full_join(depth)

# to add size fraction. calculate mean pct per cycle -> calculate mean int chla per cycle
sf_mean <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  group_by(cycle_name) %>%
  summarise("0.2" = mean(Chla_0.2_pct),
            "2" = mean(Chla_2_pct),
            "20" = mean(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "mean")
sf_sd <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  group_by(cycle_name) %>%
  summarise("0.2" = sd(Chla_0.2_pct),
            "2" = sd(Chla_2_pct),
            "20" = sd(Chla_20_pct)) %>%
  pivot_longer(cols = "0.2":"20", names_to = "size", values_to = "sd")

sf_pct <- full_join(sf_mean, sf_sd)

int_chl <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  select(cycle_name, CTD, areal_chl) %>%
  distinct() %>%
  group_by(cycle_name) %>%
  summarise(mean_int = mean(areal_chl),
            sd_int = sd(areal_chl))
sf_chl <- full_join(sf_pct, int_chl) %>%
  mutate(sf_int = mean_int*mean/100) %>%
  mutate(size = fct_relevel(size, "20", "2", "0.2")) 

```


##plot
```{r}
theme_set(theme_classic())
# two separate graphs for int chla and npp, combine tgt
p1 <- sf_chl %>%
  ggplot(aes(x=cycle_name, y=sf_int, fill = size)) +
  geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=mean_int, ymax=mean_int+sd_int), width=.1)+
  scale_fill_viridis_d() +
  xlab(NULL) +
  ylab("Integrated chla (mg/m2)") +
  theme(legend.position="top") 
p1
# pdf("figures/2_NPP chla/20221129_int chla.pdf", height=7, width=6) ; plot(p) ; dev.off()

p2<- npp %>%
  select(cycle_name, areal_PP) %>%
  distinct() %>%
  filter(!is.na(areal_PP)) %>%
  ggplot(aes(x=cycle_name, y = areal_PP)) +
  stat_summary(fun.data=mean_cl_boot, geom = "pointrange") +
  xlab(NULL) +
  ylab("Integrated NPP (mgC/m2/day)") 
p2
library(patchwork)
plot <- p1/p2 +  plot_annotation(tag_levels = 'A')
plot
pdf("figures/2_NPP chla/20221129_int chla npp combine.pdf", height=7, width=4) ; plot(plot) ; dev.off()


# test - combine integrated chla and npp together on one graph
scale =5
p <- npp %>%
  select(cycle_name, areal_PP) %>%
  distinct() %>%
  filter(!is.na(areal_PP)) %>%
  ggplot(aes(x=cycle_name, y = areal_PP/scale)) +
  stat_summary(fun.data=mean_cl_boot, geom = "pointrange", colour = "red") +
  geom_bar(data = sf_chl, aes(x=cycle_name, y=sf_int, fill = size), stat="identity") +
  #geom_errorbar(data = sf_chl, aes(ymin=mean_int-sd_int, ymax=mean_int+sd_int), width=.2)+
  scale_fill_viridis_d() +
  xlab(NULL) +
  ylab("Integrated chla (mg/m2)") +
 scale_y_continuous(sec.axis = sec_axis(~.*scale, name="Integrated NPP (mgC/m2/day)"))+
  theme(legend.position="bottom") 
p
# pdf("figures/2_NPP chla/20221129_int chla_npp.pdf", height=7, width=6) ; plot(p) ; dev.off()

#proportion of sf
p <- sf_chl %>%
  ggplot(aes(x=cycle_name, y=sf_int, fill = size)) +
  geom_bar(stat="identity", position = "fill") +
  scale_fill_viridis_d() +
  xlab(NULL) +
  ylab("Proportion of chla (%)") +
  theme(legend.position="top") 
p
pdf("figures/2_NPP chla/20221129_chla proportion.pdf", height=7, width=6) ; plot(p) ; dev.off()
```

# chla and npp by depth

## chla stacked area chart - combine sf chla and chla by depth
```{r}
library(viridis)
p <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  pivot_longer(Chla_0.2:Chla_20, names_to = "size_fraction", values_to = "chla") %>%
  group_by(cycle_name, depth, size_fraction) %>%
  summarise(mean_chla = mean(chla)) %>%
  # summarise(mean_chla = list(as_tibble(approx(mean_chla, depth, n = 1)))) %>% 
  # unnest() %>% 
  mutate(size_fraction = fct_relevel(size_fraction, "Chla_20", "Chla_2", "Chla_0.2")) %>%
  ggplot(aes(x=mean_chla, y=depth, fill=size_fraction)) +
  geom_area(size=0.25, colour = "white", orientation = "y") +
  facet_grid(cycle_name~., scales = "free", space = "free") +
  scale_y_reverse(limits = c(100,0)) +
  xlim(0,1.5) +
  ylab("Depth (m)") +
  xlab("Average chla (mg/m3)") +
  # geom_hline(yintercept = 40,linetype=2) +
  # geom_hline(yintercept = 12,linetype=2) +
  # geom_hline(yintercept = 25,linetype=2) +
  # geom_hline(yintercept = 30,linetype=2) +
  # geom_hline(yintercept = 70,linetype=2) +
  theme(strip.text.y.right = element_text(angle = 0),
        legend.position="top",
        strip.background = element_blank()) +
  scale_fill_viridis_d()

p
pdf("figures/2_NPP chla/chla_sf_depth.pdf", height=7, width=6) ; plot(p) ; dev.off()

```

## plot separate
```{r}

# plot all cycles together
p1 <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 !="SA1-b") %>%
  group_by(cycle_name, CTD) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=SumSFChla, y= depth, colour = cycle_name)) + 
  # geom_path(size=0.1) +
  geom_point(size=0.15, alpha=0.7) +
  geom_smooth(method = "loess", orientation = "y", se= FALSE) +
  scale_y_reverse()+
   # scale_x_continuous(trans='log10') +
   #  annotation_logticks(sides = "b")+
   ylim(100,0)+
  xlim(0,NA) +
  ylab("Depth (m)")+
  xlab("Chla (mg/m3)") +
   scale_colour_manual(values = colours_cycle) +
  theme(legend.position="none")
  #  geom_hline(yintercept = 40) +
  # geom_hline(yintercept = 12) +
  # geom_hline(yintercept = 25) +
  # geom_hline(yintercept = 30) +
  #  geom_hline(yintercept = 70)
p1

# pdf("chla_am.pdf", height=5, width=4) ; plot(p2) ; dev.off()

p2 <- npp %>%
  filter(station !="15") %>%
    filter(!is.na(mean_NPP)) %>% #so that the lines can connect over NA values.
  group_by(cycle_name, station) %>%
  group_modify(~ add_row(.x,.before=0)) %>% # add gaps in the dataframe for geom_path linebreaks
  ggplot(aes(x=mean_NPP, y= depth, colour = cycle_name)) + 
  # geom_path(size=0.1) +
  geom_smooth(method = "loess", orientation = "y", se= FALSE) +
  geom_point(size=0.15, alpha=0.7) +
  scale_y_reverse()+
  # scale_x_continuous(trans='log10') +
  #   annotation_logticks(sides = "b")+
  ylim(100,0)+
  xlim(0,NA)+
  ylab(NULL)+
  xlab("NPP (mgC/m3/day)")+
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))#+
  scale_color_manual(values = colours_cycle) +
  theme(legend.position="bottom")

p2
#pdf("figures/NPP chla/npp_depth_avg.pdf", height=4, width=6) ; plot(p) ; dev.off()

library(patchwork)
plot <- (p1+p2) +  plot_annotation(tag_levels = 'A') + plot_layout (guides = "collect") & theme (legend.position = "top") 
plot
pdf("figures/2_NPP chla/20221213_depth chla npp combine.pdf", height=6, width=6) ; plot(plot) ; dev.off()


# npp no smoothing - ignore
p <- npp %>%
  filter(station !="15") %>%
      filter(!is.na(mean_NPP)) %>% #so that the lines can connect over NA values.
  group_by(cycle, cycle_name, depth) %>%
  #group_by(cycle_2, cycle_name_2, depth) %>%
  summarise(mean=mean(mean_NPP)) %>%
  ggplot(aes(x=mean, y= depth, colour=cycle_name)) + 
 #   geom_errorbar(aes(xmin=mean-sd, xmax=mean+sd), width=.1) +
    geom_path() +
  scale_y_reverse()+
  ylim(100,0)+
  #facet_grid(.~cycle_name, scales = "free_x")+
  ylab("Depth (m)")+
  xlab("NPP (mgC/m3/day)")+
  scale_colour_manual(values = colours_cycle)
p
```

```{r}
test <- npp %>%
      filter(!is.na(mean_NPP)) %>%  #so that the lines can connect over NA values
   group_by(cycle_name, station) %>%
  group_modify(~ add_row(.x,.before=0))
  # group_by(cycle, cycle_name, depth) %>%
  # #group_by(cycle_2, cycle_name_2, depth) %>%
  # summarise(mean=mean(mean_NPP))
scale =10
p <- chl %>%
  filter(time == "noon") %>%
  filter(cycle_name_2 != "SA1-b") %>%
  pivot_longer(Chla_0.2:Chla_20, names_to = "size_fraction", values_to = "chla") %>%
  group_by(cycle_name, depth, size_fraction) %>%
  summarise(mean_chla = mean(chla)) %>%
  # summarise(mean_chla = list(as_tibble(approx(mean_chla, depth, n = 1)))) %>% 
  # unnest() %>% 
  mutate(size_fraction = fct_relevel(size_fraction, "Chla_20", "Chla_2", "Chla_0.2")) %>%
  ggplot(aes(y=depth)) + 
  geom_area(aes(x=mean_chla, fill=size_fraction), size=0.5, colour = "white", orientation = "y") +
  geom_smooth(data=test, aes(x=mean_NPP/scale), method = "loess", orientation = "y", se= FALSE, colour = "black") +
#  geom_path(data=test, aes(x=mean/scale)) +
  facet_grid(cycle_name~., scales = "free", space = "free") +
  scale_x_continuous(limits = c(0,1.5), sec.axis = sec_axis(~.*scale, name="NPP (mgC/m3/day)"))+
  scale_y_reverse(limits = c(100,0)) +
  ylab("Depth (m)") +
  xlab("Average chla (mg/m3)") +
  theme(strip.text.y.right = element_text(angle = 0),
        legend.position="bottom") +
  scale_fill_viridis_d()
  #scale_fill_manual(values = cbp1)

p

# pdf("figures/2_NPP chla/20221129_chla npp double axis.pdf", height=7, width=5) ; plot(p) ; dev.off()

```

