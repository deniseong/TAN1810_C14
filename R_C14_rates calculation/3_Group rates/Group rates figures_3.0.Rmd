---
title: "Group rates figure"
author: "Denise Ong"
date: "3/11/2021"
output: html_document
---


```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("0_init_files", "init.R")) #for libraries
source(here("0_init_files", "init_markdown.R")) #for markdown libraries
library(FSA)
library(ggeffects)
library(gghalves)
#Colours
colours_cycle <- readxl::read_excel("0_init_files/colours_cycle.xlsx", sheet = "cycle")
colours_cycle <- structure(colours_cycle$colour,.Names=colours_cycle$cycle)

colours_exp <- readxl::read_excel("0_init_files/colours_cycle.xlsx", sheet = "exp")
colours_exp <- structure(colours_exp$colour,.Names=colours_exp$exp)

# For consistency between scatterplot
set.seed(1)
```

# Read data
```{r}
cold_standard <- readxl::read_excel("Output/Raw data/NPP_cold_standard.xlsx") %>% 
  rename(depth_m = `depth`,
         depth = `sample`)
cold_standard$exp <- as.character(cold_standard$exp)

pp_rates <- readxl::read_excel("Output/Raw data/Rates_cell_npp_method2.xlsx")

#set factor levels
pp_rates$water_mass <- factor(pp_rates$water_mass, levels = c("ST", "SA"))
pp_rates$cycle_name <- factor(pp_rates$cycle_name, levels = c("ST1", "ST2", "SA1", "SA2", "SA3"))
pp_rates$population <- factor(pp_rates$population, levels = c("Syn", "Pico", "Nano"))
pp_rates$depth <- factor(pp_rates$depth, levels = c("SUR", "DCM"))
```


# Plots for paper
## Figure 4 
```{r}


# water mass by population
p1 <- pp_rates %>%
    ggplot() +
      geom_jitter(aes(x=cycle_name, y=pp, colour = depth), width = 0.2, alpha = 0.5, size = 1.5)+
      geom_boxplot(aes(x=water_mass, y= pp, fill=water_mass))+
      scale_colour_manual(values =  c("#009292", "#DB6D00"))+
      scale_fill_manual(values = c("#C62828", "#1565C0")) +
      facet_grid(population~water_mass, scales = "free", space = "free_x") +
      theme(strip.text.y.right = element_blank(),
            legend.position = "none",
            panel.spacing = unit(1, "lines"))+
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l", outside = TRUE)+
      coord_cartesian(clip = "off")+
      ylab("Carbon fixation rate (fgC/cell/hr)") +
      xlab("Cycle")
p1

p2 <- pp_rates %>%
  ggplot() +
    geom_jitter(aes(x=cycle_name, y=npp, colour = depth), width = 0.2, alpha = 0.5, size = 1.5)+
    geom_boxplot(aes(x=water_mass, y= npp, fill=water_mass))+
    scale_colour_manual(values =  c("#009292", "#DB6D00"))+
    scale_fill_manual(values = c("#C62828", "#1565C0")) +
    facet_grid(population~water_mass, scales = "free", space = "free_x") +
    theme(panel.spacing = unit(1,"lines"),
          legend.position = "top",
          strip.text.y.right = element_text(angle = 0))+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l", outside = TRUE)+
    coord_cartesian(clip = "off") +
    ylab("NPP (mgC/m3/day)")+
    xlab("Cycle")
p2

library(patchwork)
plot <- p1 + p2 +  plot_annotation(tag_levels = 'A') +  plot_layout(guides = 'collect')  &
  theme(legend.position='top')
plot
pdf("pp_npp v2.pdf", height=7, width=8) ; plot(plot) ; dev.off()

```

## Supplementary figures - Figures S6, S7, S8.
```{r}

# Figure S6 - PP by experiment
  p <- pp_rates %>%
  ggplot() +
    geom_jitter(aes(x=exp, y=pp, shape = depth), width = 0.2, alpha = 0.5) +
    scale_fill_manual (values = colours_cycle)+
    facet_grid(population~cycle_name, scales = "free", space = "free_x") +
        theme(panel.spacing.x = unit(0,"lines"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              strip.background = element_blank(),
              strip.text.y.right = element_text(angle = 0),
              panel.border = element_rect(colour = "black", fill = NA),
              legend.position = "top")+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    ylab("Carbon fixation rate (fgC/cell/hr)")
p
pdf("figures/1_group rates/202231130_pp_group_exp.pdf", height=6, width=6) ; plot(p) ; dev.off()



# Figure S7 - cell conc by experiment
  p <- pp_rates %>%
  select(cycle_name, exp, conc_ml, population, depth) %>%
  filter(exp!="5") %>%
  distinct() %>%
  ggplot() +
    # geom_point(aes(x=exp, y=npp), alpha = 0.5)+
    geom_jitter(aes(x=exp, y=conc_ml, shape = depth), width = 0.2, alpha = 0.5) +
    facet_grid(population~cycle_name, scales = "free", space = "free_x") +
        theme_minimal()+
        theme(panel.spacing.x = unit(0,"lines"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              strip.background = element_blank(),
              strip.text.y.right = element_text(angle = 0),
              panel.border = element_rect(colour = "black", fill = NA),
              legend.position = "top")+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    ylab("Cell concentration (mL)") +
  xlab("Experiment") +
  labs(shape = "Depth")
p
pdf("figures/1_group rates/supp_cell conc_group_exp.pdf", height=6, width=6) ; plot(p) ; dev.off()


# Figure S8- npp by experiment
  p <- pp_rates %>%
  ggplot() +
    # geom_point(aes(x=exp, y=npp), alpha = 0.5)+
    geom_jitter(aes(x=exp, y=npp, shape = depth), width = 0.2, alpha = 0.5) +
    facet_grid(population~cycle_name, scales = "free", space = "free_x") +
        theme_minimal()+
        theme(panel.spacing.x = unit(0,"lines"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              strip.background = element_blank(),
              strip.text.y.right = element_text(angle = 0),
              panel.border = element_rect(colour = "black", fill = NA),
              legend.position = "top")+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    ylab("NPP (mgC/m3/day)")
p
pdf("figures/1_group rates/202231130_npp_group_exp.pdf", height=6, width=6) ; plot(p) ; dev.off()


```


## Table 2 - summary for paper - pp, npp, cell conc
```{r}
# General summary
summary <- pp_rates %>%
  select(population, cycle_name, pp, npp, conc_ml) %>%
  pivot_longer(pp:conc_ml, names_to = "data", values_to = "value") %>%
  group_by(data, population, cycle_name) %>%
  summarize(mean = round(mean(value), 2),
            sd = round(sd(value),2), 
             # n = n()
            ) %>%
   unite("mean_sd", mean:sd, sep = " ± ") %>%
  pivot_wider(names_from = "cycle_name", values_from = "mean_sd") %>%
  arrange(factor(data, levels = c('pp', 'npp', 'conc_ml')))
summary

# writexl::write_xlsx(summary, path = "group_summary.xlsx")

# cell conc summary - only change for SA2
summary <- pp_rates %>%
  filter(exp != "5") %>%
  select(water_mass, population, cycle_name, conc_ml) %>%
  distinct() %>%
  pivot_longer(conc_ml, names_to = "data", values_to = "value") %>%
  group_by(data, population, water_mass) %>%
  summarize(mean = round(mean(value), 0),
            sd = round(sd(value),0), 
            n = n(),
            min = round(min(value), 0),
            max = round(max(value), 0)
            ) %>%
   unite("mean_sd", mean:sd, sep = " ± ") %>%
  unite("range", min:max, sep = "-")

summary

# Small phyto NPP
summary <- pp_rates %>%
  select(population, cycle_name, npp, exp, depth) %>%
  group_by(population, cycle_name, exp, depth) %>%
  summarize(mean = round(mean(npp), 2)) %>%
  group_by(cycle_name, exp,depth) %>%
  summarise(sum = sum(mean)) %>%
  group_by(cycle_name) %>%
  summarise(mean = round(mean(sum), 2),
             sd = round(sd(sum),2)
            ) %>%
   unite("mean_sd", mean:sd, sep = " ± ") %>%
  pivot_wider(names_from = "cycle_name", values_from = "mean_sd")
summary
```

Mean of pp and npp between water mass and depth
```{r}
summary <- pp_rates %>%
  group_by(population, water_mass) %>%
  summarize(mean = round(mean(pp), 2),
            sd = round(sd(pp),2), n = n()) %>%
   unite("mean_sd", mean:sd, sep = "±") 
summary

summary <- pp_rates %>%
  group_by(population, water_mass) %>%
  summarize(median = round(median(npp), 2),
            mean = round(mean(npp), 2),
            sd = round(sd(npp),2), n = n()) %>%
   unite("mean_sd", mean:sd, sep = " ± ") 
summary


summary <- pp_rates %>%
  group_by(population, depth) %>%
  summarize(mean = round(mean(pp), 2),
            sd = round(sd(pp),2), n = n()) %>%
   unite("mean_sd", mean:sd, sep = "±") 
summary
```


#Statistical tests
## PP
### surface and DCM - remove this as a factor to check
#### plot
```{r}
for (i in c("Syn", "Pico", "Nano")) {
  p <- pp_rates %>%
  filter(population == i) %>%
    ungroup() %>%
    complete(exp, depth) %>%
  ggplot() +
    geom_point(aes(x=depth, y=pp))+
    facet_grid(.~exp, scales = "free_x", space = "free") +
    #scale_colour_manual(values = colours_exp)+
    #scale_fill_manual (values = colours_cycle)+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    ylab("PP rate (fgC/cell/hr)") +
    ggtitle(i)
  print(p)
  # pdf(here(str_c("pp_depth_", i, ".pdf")), height=5, width=8) ; plot(p) ; dev.off()
}

```

#### t test to check if surface is different from DCM
surface is not different from DCM for all groups
not significantly different, from here on combine surface and DCM

Syn: t-test t = -1.9885, df = 40, p-value = 0.05363
Pico: t = -1.3297, df = 41, p-value = 0.191
Nano: t = -0.28573, df = 21.247, p-value = 0.7778
```{r}
library("ggpubr")

# For syn and pico, t.test var.equal=TRUE. For nano, var.equal = FALSE

i = "Syn"
# i = "Pico"
# i = "Nano"

t_test_df<- pp_rates %>%
  filter(population == i) %>%
  select(depth, water_mass, pp)

summary <- t_test_df %>%
  group_by(depth) %>%
  summarise(count = n(),
    mean = mean(pp, na.rm = TRUE),
    sd = sd(pp, na.rm = TRUE))
print(summary)

 p <- t_test_df %>%
   ggplot(aes(x=depth, y=pp))  +geom_boxplot() + geom_point() +
    facet_grid(~depth, scales = "free") +
    scale_y_continuous(trans='log10') + annotation_logticks(sides = "l")  + ggtitle(i)
 print(p)

# checks, all groups meet assumptions of normality and homoskedasticity
hist(log10(t_test_df$pp))
qqnorm(log10(t_test_df$pp))
p<-with(t_test_df, shapiro.test(log10(pp[depth == "SUR"])))
print(p)
p<-with(t_test_df, shapiro.test(log10(pp[depth == "DCM"])))
print(p)

# check for variance. If variance sig different, use var.equal = FALSE
var.test(log10(pp) ~ depth, t_test_df)

res <- t.test(log10(pp) ~ depth, data =  t_test_df, var.equal = TRUE)
print(res)

# create lm and check residuals
lm <- lm(log10(pp) ~ depth, data=pp_rates)
plot(lm) 


# Calculate model estimated means and CIs
library(ggeffects)
lm_emm <- ggemmeans(lm, 
                    terms = c("depth"),
                    type = "fixed")

lm_emm
plot(lm_emm)

```

### Overall between groups
based on anova analysis and model means and CI, all groups are different from each other. 

population | Predicted |         95% CI
Syn        |      0.71 | [ 0.53,  0.96]
Pico       |      1.72 | [ 1.28,  2.31]
Nano       |     47.18 | [35.25, 63.14]

```{r}
# check between groups, not normally distributed.
hist(pp_rates$pp)
qqnorm(pp_rates$pp)
shapiro.test(pp_rates$pp)

# transform the data and check again.
hist(log10(pp_rates$pp))
qqnorm(log10(pp_rates$pp))
shapiro.test(log10(pp_rates$pp)) # still not significant. 

# create lm and check residuals
lm <- lm(log10(pp) ~ population, data=pp_rates)
plot(lm) 
# based on diagnostic plots, lm is suitable.
Anova(lm, type = "3") # p< 0.0001

# Calculate model estimated means and CIs
library(ggeffects)
lm_emm <- ggemmeans(lm, 
                    terms = c("population"),
                    type = "fixed")

lm_emm

# Plot 
pp_all <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = population,
                            y = pp),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = pp_rates) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(width = 1),
                        data = lm_emm) +
        labs(x = "Population",
             y = "PP"
             # colour = "Water mass",
             # shape = "Cycle",
             # title = i
             ) +
      # scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      # scale_colour_manual(values = c("#C62828", "#1565C0"))+ 
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
pp_all


# interaction plot population and water mass?
# lm <- lm(log10(pp) ~ population*water_mass, data=pp_rates)
# plot(lm) 
# Anova(lm, type = "3") # p< 0.0001
# 
# lm_emm <- ggemmeans(lm, 
#                     terms = c("population", "water_mass"),
#                     type = "fixed")
# 
# lm_emm
# plot(lm_emm) + scale_y_continuous(trans='log10') +
#       annotation_logticks(sides = "l", outside = TRUE)
```
In each water mass compare between groups. Because values do not fit the assumptions of anova, using non-parametric equivalent of Kruskal wallis test. 
In  ST, Syn=pico<nano
In SA, all groups different from each other.
```{r}
#ST is not normally distributed. Use kruskal wallis test.
# in ST cycles only.
df <- pp_rates %>%
  filter(water_mass == "ST")
hist(log10(df$pp))
qqnorm(log10(df$pp))
shapiro.test(log10(df$pp)) # not normally distributed. 

# checking diagnostic plots of lm. Not fitted to assumptions of linear model. Use non-parametric test
lm <- lm(log10(pp) ~ population, data=df)
plot(lm)
Anova(lm, type = "3")
lm_emm <- ggemmeans(lm,
                    terms = c("population"),
                    type = "fixed")

lm_emm
plot(lm_emm) + scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l", outside = TRUE)

# skewed data, run non parametric test
print(kruskal.test(pp~population, data = df)) # significant
print(
dunnTest(pp~population, data = df,
       method="bonferroni")
)


#SA is not normally distributed. Use kruskal wallis test.
df <- pp_rates %>%
  filter(water_mass == "SA")
hist(log10(df$pp))
qqnorm(log10(df$pp))
shapiro.test(log10(df$pp))

# checking diagnostic plots of lm. Not fitted to assumptions of linear model. Use non-parametric test
lm <- lm(log10(pp) ~ population, data=df)
plot(lm)
#load lmtest package
library(lmtest)
#perform Breusch-Pagan Test
bptest(lm) # according to BP test, residuals are not homoscedastic (evenly spread). 
# Anova(lm, type = "3")

print(kruskal.test(pp~population, data = df)) # not significant
print(
dunnTest(pp~population, data = df,
       method="bonferroni")
)

```



### within each group - ST vs SA
#### ignore - plot
```{r}
for (i in c("Syn", "Pico", "Nano")) {
  p <- pp_rates %>%
  filter(population == i) %>%
  ggplot() +
    geom_point(aes(x=exp, y=pp, fill=exp), pch = 21, colour = "black", alpha = 0.5)+
    scale_fill_manual (values = colours_exp)+
    #geom_jitter(aes(x=exp, y=pp, shape = depth, fill=exp), width = 0.1, alpha = 0.5) +
    geom_boxplot(aes(x=cycle_name, y= pp, fill=cycle_name))+
    scale_fill_manual (values = colours_cycle)+
        scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    facet_grid(.~cycle_name, scales = "free_x", space = "free") +
        theme(panel.spacing.x = unit(0,"lines"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              strip.background = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA))+

    ylab("PP rate (fgC/cell/hr)") +
    ggtitle(i)
  print(p)
}

```

#### t test to check if ST is different from SA within each group
ST is different from SA for syn and pico, not different for nano.
Syn: t = 6.224, df = 40, p-value = 2.289e-07
water_mass | Predicted |       95% CI
ST         |      1.73 | [1.19, 2.51]
SA         |      0.39 | [0.29, 0.53]

pico: t = 2.4321, df = 41, p-value = 0.01946
water_mass | Predicted |       95% CI
ST         |      2.76 | [1.67, 4.57]
SA         |      1.26 | [0.84, 1.90]

nano: t = 0.72648, df = 42, p-value = 0.4716
water_mass | Predicted |         95% CI
ST         |     52.71 | [35.83, 77.52]
SA         |     44.28 | [33.08, 59.28]
```{r}

# i = "Syn"
# i = "Pico"
i = "Nano"

t_test_df<- pp_rates %>%
  filter(population == i) %>%
  select(water_mass, pp, population,cycle_name)

summary <- t_test_df %>%
  group_by(water_mass) %>%
  summarise(count = n(),
    mean = mean(pp, na.rm = TRUE),
    sd = sd(pp, na.rm = TRUE))
print(summary)

 p <- t_test_df %>%
   ggplot(aes(x=water_mass, y=pp)) + geom_point() +geom_boxplot()+ scale_y_continuous(trans='log10') + annotation_logticks(sides = "l")  
 print(p)
 
# checks, all groups meet assumptions of normality and homoskedasticity
hist(log10(t_test_df$pp))
qqnorm(log10(t_test_df$pp))
p<-with(t_test_df, shapiro.test(log10(pp[water_mass == "ST"])))
print(p)
p<-with(t_test_df, shapiro.test(log10(pp[water_mass == "SA"])))
print(p)

lm <- lm(log10(pp) ~ water_mass, data=t_test_df)
plot(lm) 

# check for variance. If variance sig different, use var.equal = FALSE
var.test(log10(pp) ~ water_mass, t_test_df)

#var.equal = TRUE
res <- t.test(log10(pp) ~ water_mass, data =  t_test_df, var.equal = TRUE)

print(res)

lm_emm <- ggemmeans(lm, 
                    terms = c("water_mass"),
                    type = "fixed")

lm_emm

plot(lm_emm)
######### Plot #######
library(gghalves)
pp_syn <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = pp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(width = 1),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "PP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0"))+ 
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
pp_syn

pp_pico <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = pp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(0.25),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "PP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0"))+
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
pp_pico

pp_nano<- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = pp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(0.25),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "PP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0")) +
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
  
pp_nano

# layout <- '
# AA#
# BCD
# '
# 
# p<- pp_all+pp_syn+pp_pico+pp_nano + plot_annotation(tag_levels = 'A') + plot_layout(design = layout)+ plot_layout(guides = 'collect')  & theme(legend.position='top')
p <- ((pp_all+ plot_spacer())/(pp_syn|pp_pico|pp_nano)) + plot_annotation(tag_levels = 'A') +  plot_layout(guides = 'collect')  &
  theme(legend.position='right')
p
pdf("pp_mean and CI.pdf", height=7, width=8) ; plot(p) ; dev.off()

```


## NPP
### surface and DCM
#### plot -ignore
```{r}
for (i in c("Syn", "Pico", "Nano")) {
  p <- pp_rates %>%
  filter(population == i) %>%
  ggplot() +
    geom_point(aes(x=depth, y=npp, shape = depth, colour=exp))+
    facet_grid(.~exp, scales = "free_x", space = "free") +
    scale_colour_manual(values = colours_exp)+
    scale_fill_manual (values = colours_cycle)+
    scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    #ylab("PP rate (fgC/cell/hr)") +
    ggtitle(i)
  print(p)
}

```

#### t test to check if surface is different from DCM
not using wilcoxon test output, but all not significant.
syn: t-test t = -1.5679, df = 40, p-value = 0.1248
wilcoxon test W = 136, p-value = 0.1124

pico t = -1.4587, df = 41, p-value = 0.1523
W = 148, p-value = 0.1171

nano t = 0.92363, df = 19.711, p-value = 0.3668
W = 255, p-value = 0.4568
```{r}
library("ggpubr")


# For syn and pico, t.test var.equal=TRUE. For nano, var.equal = FALSE

# i = "Syn"
# i = "Pico"
i = "Nano"

t_test_df<- pp_rates %>%
  filter(population == i) %>%
  select(depth, water_mass, npp)

summary <- t_test_df %>%
  group_by(depth) %>%
  summarise(count = n(),
    mean = mean(npp, na.rm = TRUE),
    sd = sd(npp, na.rm = TRUE))
print(summary)

 p <- t_test_df %>%
   ggplot(aes(x=depth, y=npp))  +geom_boxplot() + geom_point() +
    facet_grid(~depth, scales = "free") +
    scale_y_continuous(trans='log10') + annotation_logticks(sides = "l")  + ggtitle(i)
 print(p)

# checks, all groups meet assumptions of normality and homoskedasticity
hist(log10(t_test_df$npp))
qqnorm(log10(t_test_df$npp))
p<-with(t_test_df, shapiro.test(log10(npp[depth == "SUR"])))
print(p)
p<-with(t_test_df, shapiro.test(log10(npp[depth == "DCM"])))
print(p)

lm <- lm(log10(npp) ~ depth, data=t_test_df)
plot(lm) 

# check for variance. If variance sig different, use var.equal = FALSE
var.test(log10(npp) ~ depth, t_test_df)

# parametric
res <- t.test(log10(npp) ~ depth, data =  t_test_df, var.equal = FALSE)
print(res)

#non-parametric - not using.
# res <- wilcox.test(npp ~ depth, data = t_test_df,
#                    exact = FALSE)
# print(res)


```

### Overall between groups
normally distributed after log transformation. Using ANOVA.
```{r}

hist(pp_rates$npp)
qqnorm(pp_rates$npp)
shapiro.test(pp_rates$npp)

hist(log10(pp_rates$npp))
qqnorm(log10(pp_rates$npp))
shapiro.test(log10(pp_rates$npp)) # significant. Meet assumptions, using ANOVA

lm <- lm(log10(npp) ~ population, data=pp_rates)
plot(lm)
# based on diagnostic plots, lm is suitable.
Anova(lm, type = "3")
# pairwise.t.test(log10(pp_rates$pp), pp_rates$population, p.adj='bonferroni')


# Calculate model estimated means and CIs
library(ggeffects)
lm_emm <- ggemmeans(lm, 
                    terms = c("population"),
                    type = "fixed")

lm_emm
plot(lm_emm)

# Plot 
npp_all <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = population,
                            y = npp),
                        side = 'l', alpha = 0.6,
                        size = 1, range_scale = 0.5,
                        data = pp_rates) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(width = 1),
                        data = lm_emm) +
        labs(x = "Population",
             y = "NPP"
             # colour = "Water mass",
             # shape = "Cycle",
             # title = i
             ) +
      # scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      # scale_colour_manual(values = c("#C62828", "#1565C0"))+ 
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
npp_all


# interaction plot population and water mass?
lm <- lm(log10(npp) ~ population*water_mass, data=pp_rates)
plot(lm)
Anova(lm, type = "3") # p< 0.0001

lm_emm <- ggemmeans(lm,
                    terms = c("population", "water_mass"),
                    type = "fixed")

lm_emm
plot(lm_emm) + scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l", outside = TRUE)
```
### Within each water mass check between groups
same for both water masses
ST
Anova Table (Type III tests)

Response: log10(npp)
             Sum Sq Df F value Pr(>F)
(Intercept)  0.0840  1  0.2878 0.5942
population   1.3067  2  2.2379 0.1179
Residuals   13.7220 47        

population | Predicted |       95% CI
-------------------------------------
Syn        |      1.18 | [0.64, 2.16]
Pico       |      0.92 | [0.50, 1.68]
Nano       |      2.24 | [1.20, 4.18]

SA
Anova Table (Type III tests)

Response: log10(npp)
             Sum Sq Df F value    Pr(>F)    
(Intercept)  2.5359  1  14.599   0.00027 ***
population   8.4950  2  24.453 6.322e-09 ***
Residuals   13.2014 76                      
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

```{r}

#ST is not normally distributed. Use kruskal wallis test.
df <- pp_rates %>%
  filter(water_mass == "ST")
hist(log10(df$npp))
qqnorm(log10(df$npp))
shapiro.test(log10(df$npp)) # not normally distributed. 

# checking diagnostic plots of lm. Not fitted to assumptions of linear model. Use non-parametric test
lm <- lm(log10(npp) ~ population, data=df)
plot(lm)
print(Anova(lm, type = "3"))
lm_emm <- ggemmeans(lm,
                    terms = c("population"),
                    type = "fixed")
lm_emm
plot(lm_emm)

# skewed data, run non parametric test
print(kruskal.test(npp~population, data = df)) # significantly different between the three groups.p =0.02
print(
dunnTest(npp~population, data = df, #perform Dunn's Test with Bonferroni correction for p-values
       method="bonferroni")
)




df <- pp_rates %>%
  filter(water_mass == "SA")
hist(log10(df$npp))
qqnorm(log10(df$npp))
print(shapiro.test(log10(df$npp)))

lm <- lm(log10(npp) ~ population, data=df)
plot(lm)
print(Anova(lm, type = "3"))

# Calculate model estimated means and CIs
lm_emm <- ggemmeans(lm, 
                    terms = c("population"),
                    type = "fixed")

lm_emm

# Plot 
plot(lm_emm) 



```

### within each group - ST vs SA
#### ignore- plot
```{r}
for (i in c("Syn", "Pico", "Nano")) {
  p <- pp_rates %>%
  filter(population == i) %>%
  ggplot() +
    geom_point(aes(x=exp, y=npp, fill=exp), pch = 21, colour = "black", alpha = 0.5)+
    scale_fill_manual (values = colours_exp)+
    geom_boxplot(aes(x=cycle_name, y= npp, fill=cycle_name))+
    scale_fill_manual (values = colours_cycle)+
        scale_y_continuous(trans='log10') +
    annotation_logticks(sides = "l")+
    facet_grid(.~cycle_name, scales = "free_x", space = "free") +
        theme(panel.spacing.x = unit(0,"lines"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              strip.background = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA))+
    ylab("NPP rate") +
    ggtitle(i)
  print(p)
}

```

#### t test to check if ST is different from SA
ST is different from SA for pico. 

Syn:t-test, different. t = 2.4056, df = 40, p-value = 0.02086
wilcox test, not different. W = 276, p-value = 0.1064
water_mass | Predicted |       95% CI
-------------------------------------
ST         |      1.18 | [0.66, 2.10]
SA         |      0.48 | [0.30, 0.78]

Pico:t-test, t = 3.1731, df = 41, p-value = 0.002857
W = 349, p-value = 0.00154
water_mass | Predicted |       95% CI
ST         |      0.92 | [0.56, 1.51]
SA         |      0.34 | [0.22, 0.50]

Nano:t-test, not different t = 0.52716, df = 42, p-value = 0.6009
water_mass | Predicted |       95% CI
-------------------------------------
ST         |      2.24 | [1.33, 3.76]
SA         |      1.89 | [1.27, 2.79]
```{r}

i = "Syn"
# i = "Pico"
# i = "Nano"

t_test_df<- pp_rates %>%
  filter(population == i) %>%
  select(water_mass, npp, population,cycle_name)

summary <- t_test_df %>%
  group_by(water_mass) %>%
  summarise(count = n(),
    mean = mean(npp, na.rm = TRUE),
    sd = sd(npp, na.rm = TRUE))
print(summary)

 p <- t_test_df %>%
   ggplot(aes(x=water_mass, y=npp)) +geom_boxplot()+ geom_point() +scale_y_continuous(trans='log10') + annotation_logticks(sides = "l")  
 print(p)
 
# checks, all groups meet assumptions of normality and homoskedasticity
hist(log10(t_test_df$npp))
qqnorm(log10(t_test_df$npp))
shapiro.test(log10(t_test_df$npp))
# p<-with(t_test_df, shapiro.test(log10(npp[water_mass == "ST"])))
# print(p)
# p<-with(t_test_df, shapiro.test(log10(npp[water_mass == "SA"])))
# print(p)

lm <- lm(log10(npp) ~ water_mass, data=t_test_df)
plot(lm) 

#  variance equal for all.
var.test(log10(npp) ~ water_mass, t_test_df)

res <- t.test(log10(npp) ~ water_mass, data =  t_test_df, var.equal = TRUE)
print(res)

lm_emm <- ggemmeans(lm, 
                    terms = c("water_mass"),
                    type = "fixed")
lm_emm

plot(lm_emm) 
#non-parametric- wilcox test = mann-whitney test, wilcoxon rank sum test (independednt samples)
res <- wilcox.test(npp ~ water_mass, data = t_test_df,
                   exact = FALSE)
print(res)

######### Plot #######
library(gghalves)
npp_syn <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = npp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(width = 1),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "NPP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0"))+ 
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
npp_syn

npp_pico <- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = npp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(0.25),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "NPP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0"))+
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
npp_pico

npp_nano<- ggplot() +
        # Raw data
        geom_half_point_panel(aes(x = water_mass,
                            y = npp,
                            colour = water_mass,
                            shape = cycle_name),
                        side = 'l', alpha = 0.6,
                        size = 2, range_scale = 0.5,
                        data = t_test_df) +
        # Line of model predicted means
        geom_pointrange(aes(x = x,
                            y = predicted,
                            ymin = conf.low,
                            ymax = conf.high,
                            colour = x),
                        size = 0.6,
                        lwd = 1.3, 
                        position = position_dodge(0.25),
                        data = lm_emm) +
        labs(x = "Water mass",
             y = "NPP",
             colour = "Water mass",
             shape = "Cycle",
             title = i) +
      scale_shape_manual(values=c(0,1, 15, 17, 19)) +
      scale_colour_manual(values = c("#C62828", "#1565C0")) +
      scale_y_continuous(trans='log10') +
      annotation_logticks(sides = "l")
  
npp_nano

# layout <- '
# AA#
# BCD
# '
# 
# p<- pp_all+pp_syn+pp_pico+pp_nano + plot_annotation(tag_levels = 'A') + plot_layout(design = layout)+ plot_layout(guides = 'collect')  & theme(legend.position='top')
p <- ((npp_all+ plot_spacer())/(npp_syn|npp_pico|npp_nano)) + plot_annotation(tag_levels = 'A') +  plot_layout(guides = 'collect')  &
  theme(legend.position='right')
p
pdf("npp_mean and CI.pdf", height=7, width=8) ; plot(p) ; dev.off()


```

