---
title: "20220331_C14 18S"
author: "Denise Ong"
date: "3/31/2022"
output: html_document
---
# Initialize
```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("phyloseq", "init_files", "init.R")) #for libraries
source(here("phyloseq", "init_files", "init_markdown.R")) #for markdown libraries
source(here("phyloseq", "init_files", "define_functions.R")) #functions to 1.transform to dataframe, 2.normalise and 3.create treemaps
source(here("phyloseq", "trophic_mode", "trophic_function.R"))  #function to assign trophic level for phyloseq objects
source(here("phyloseq", "init_files", "colours_18sv4.R")) # predetermined colours
source(here("phyloseq", "init_files", "colours_random.R")) #random colours
```

#Functions to deal with low abundance taxa
```{r}
#set threshold for how many percent (out of 100) of barplot should be classified as "others" from long form
ps_threshold <- function(ps_long, taxa, threshold) {
    ps_long <- ps_long %>% 
        group_by(file_code) %>% 
        mutate(pct_reads =  n_reads / sum(n_reads) * 100) %>% #calculate pct of reads per sample for every ASV
        group_by(file_code, {{taxa}}) %>% #select the taxa level that you want to summarise
        mutate(sum_pct_reads = sum(pct_reads)) %>% # sum of pct of reads for each taxa
        ungroup() %>%
        mutate(taxa = case_when(sum_pct_reads <= {{threshold}} ~ '.Others', #if reads below threshold, taxa assigned as others
               TRUE ~ as.character({{taxa}}))) #else taxa remains the same

    return(ps_long)
}

#select top n taxa
ps_top <- function(ps_long, taxa, top_n) {
  ps_long <- ps_long %>%
  group_by({{taxa}}) %>%
  summarise(sum_n_reads = sum(n_reads)) %>%
  slice_max(order_by = sum_n_reads, n = {{top_n}}) %>%
  left_join(ps_long) %>%
    select(-sum_n_reads) %>%
    ungroup()
}

# Only take asvs that represent at least 10% of reads in any given sample
ps_abund <- function(ps, fraction) {
  total = median(sample_sums(ps))
  ps <- filter_taxa(ps, function(x) sum(x > total*fraction) > 0, TRUE)
}
```

# Sorted pico
## Read data
```{r}
source(here("phyloseq", "init_files", "read_pico.R"))
ps_pico_1 <- phyloseq_assign_trophic(ps_pico)
# Do normalizations and transformation
ps_pico_1 <- phyloseq_normalize_median(ps_pico_1)
long_pico_1 <- phyloseq_transform_to_long(ps_pico_1) 

#create levels for factors
long_pico_1$cycle_exp <- factor(long_pico_1$cycle_exp, levels = c("ST1_7", "ST1_8", "ST2_9", "ST2_10", "SA1_1", "SA1_2", "SA2_3", "SA2_4", "SA2_5", "SA2_6", "SA3_11"))
long_pico_1$trophic_mode <- factor(long_pico_1$trophic_mode, levels = c("photosynthetic", "mixotrophic", "heterotrophic", "dinophyceae"))
long_pico_1$cycle_name_2 <- factor(long_pico_1$cycle_name_2, levels = c("ST1", "ST2", "SA1","SA2","SA3"))

# remove extra groups
ps_pico_2 <- ps_pico %>% 
    subset_taxa(!(supergroup %in% c("Opisthokonta")))%>%
    subset_taxa(!(division %in% c("Pseudofungi")))%>%
    subset_taxa(!(class %in% c("Syndiniales")) )
ps_pico_2 <- phyloseq_normalize_median(ps_pico_2)
long_pico_2 <- phyloseq_transform_to_long(ps_pico_2)


```



## General plot - by experiment and depth
```{r}
#pdf(here("phyloseq", "paper_c14", "20220406", "sorted pico treemap.pdf"), height=5, width=5) ; plot(phyloseq_long_treemap(long_pico_1, division, class, "Sorted Pico")) ; dev.off()

#plot all at division and class level to check the difference between all vials
p1 <- long_pico_1 %>%
  # mutate(class = fct_infreq(taxa))%>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1

pdf(here("phyloseq", "paper_c14", "20220406", "sorted pico class_all.pdf"), height=5, width=8) ; plot(p1) ; dev.off()

p2 <- long_pico %>%
   ps_threshold(species, 10) %>%
   mutate(class = fct_infreq(taxa))%>%
 # mutate(class = fct_lump_prop(class, 0.10)) %>%
#  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
  ggplot(aes(x=vial, y=n_reads, fill=taxa, color = taxa)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p2

# check cycle 2 experiment 3 initial - pico-15,  dominated by dinophyceae
p2 <- long_pico_1 %>%
  filter(file_code =="pico-15") %>%
  ggplot(aes(x=file_code, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        ggtitle("Check pico-15") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
p2
pdf(here("phyloseq", "paper_c14", "20220406", "check pico-15.pdf"), height=5, width=8) ; plot(p2) ; dev.off()

```

```{r}
# trophic mode for everything. Dinophyceae and Syndiniales looks patchy and distracts from the  pattern.
p <- long_pico_1 %>%
  ggplot(aes(x=vial, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - trophic mode") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220406", "pico_trophic mode_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()

#plot trophic mode without Dinophyceae and Syndiniales
p <- long_pico_1 %>%
  filter(vial_type == "light") %>%
  filter(!(trophic_mode %in% c("dinophyceae", "syndiniales"))) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Sorted pico light - trophic wo Dinophyceae and Syndiniales") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220406", "pico_trophic mode_filter.pdf"), height=6, width=9) ; plot(p) ; dev.off()

#plot for light vials, average of all light vials
p3<- long_pico_1 %>%
  filter(vial_type == "light") %>%
  filter(trophic_mode == "mixotrophic") %>%
  #filter(file_code != "pico-56") %>%
  ps_top(species, 10) %>%
  mutate(species = fct_infreq(species))%>%
  #mutate(species = fct_lump_n(species, 10, other_level = "Others")) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - mixotrophic top 10 species") +
        scale_colour_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps") +
        scale_fill_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps")
        #scale_color_manual(values=speciesPalette, limits = force) + 
        #scale_fill_manual(values=speciesPalette, limits = force) 
p3

pdf(here("phyloseq", "paper_c14", "20220406", "pico_mixo species.pdf"), height=6, width=9) ; plot(p3) ; dev.off()
  
#check for all light vials, only one trophic mode
p2<- long_pico_1 %>%
  filter(vial_type == "light") %>%
  filter(trophic_mode == "mixotrophic") %>% #change here for trophic mode
  #filter(file_code != "pico-56") %>%
  mutate(species = fct_lump_n(species, 10, other_level = "Others")) %>%
  mutate(species = fct_infreq(species))%>%
  ggplot(aes(x=vial, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - mixotrophic - check") +
       # scale_color_manual(values=speciesPalette, limits = force) + 
       # scale_fill_manual(values=speciesPalette, limits = force) 
        scale_colour_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps") +
        scale_fill_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps")
p2
pdf(here("phyloseq", "paper_c14", "20220406", "pico_mixo species_2.pdf"), height=6, width=9) ; plot(p2) ; dev.off()
```
#remove low abundance ASV
load phyloseq > remove low abund? > normalise median > assign trophic> transform to long?
```{r}
ps_pico_abund <- ps_abund(ps_pico, 0.10)
ps_pico_abund <- phyloseq_normalize_median(ps_pico_abund)
ps_pico_abund <- phyloseq_assign_trophic(ps_pico_abund)
junk <- data.frame(ps_pico_abund@tax_table)
long_pico_abund <- phyloseq_transform_to_long(ps_pico_abund) %>%
  replace_na(list(trophic_mode = "photosynthetic"))
long_pico_abund$trophic_mode <- factor(long_pico_abund$trophic_mode, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))

p1 <- long_pico_abund %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
p1

p1 <- long_pico_abund %>%
    filter(trophic_mode %in% c("photosynthetic", "mixotrophic","heterotrophic")) %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p1

for (i in c("photosynthetic", "mixotrophic","heterotrophic","dinophyceae", "syndiniales" )) {
  p<- long_pico_abund %>%
  filter(trophic_mode== i) %>%
  mutate(species = fct_infreq(species))%>%
  ggplot(aes(x=vial, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle(str_c("Sorted Pico abundant ASVs - ", i)) +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
  print(p)
}


```

# Sorted nano
## Read data
```{r}
source(here("phyloseq", "init_files", "read_nano.R"))

ps_nano_1 <- phyloseq_assign_trophic(ps_nano)
# Do normalizations and transformation
ps_nano_1 <- phyloseq_normalize_median(ps_nano_1)
long_nano_1 <- phyloseq_transform_to_long(ps_nano_1)

# create a new column for trophic mode, separate dinophyceae
long_nano_1$trophic_mode_2 <- long_nano_1$trophic_mode
long_nano_1$trophic_mode_2<-ifelse(long_nano_1$class=="Dinophyceae","dinophyceae",long_nano_1$trophic_mode_2)


long_nano_1$cycle_exp <- factor(long_nano_1$cycle_exp, levels = c("ST1_7", "ST1_8", "ST2_9", "ST2_10", "SA1_1", "SA1_2", "SA2_3", "SA2_4", "SA2_5", "SA2_6", "SA3_11"))
long_nano_1$trophic_mode <- factor(long_nano_1$trophic_mode, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))
long_nano_1$trophic_mode_2 <- factor(long_nano_1$trophic_mode_2, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))
long_nano_1$cycle_name_2 <- factor(long_nano_1$cycle_name_2, levels = c("ST1", "ST2", "SA1","SA2","SA3"))

#pdf(here("phyloseq", "paper_c14", "20220406", "sorted nano treemap.pdf"), height=5, width=5) ; plot(phyloseq_long_treemap(long_nano_1, division, class, "Sorted Nano")) ; dev.off()

ps_nano_2 <- ps_nano %>% 
    subset_taxa(!(supergroup %in% c("Opisthokonta")))%>%
    subset_taxa(!(division %in% c("Pseudofungi")))%>%
    subset_taxa(!(class %in% c("Syndiniales")))
ps_nano_2 <- phyloseq_normalize_median(ps_nano_2)
long_nano_2 <- phyloseq_transform_to_long(ps_nano_2)

```


## General plot - by experiment and depth
```{r}
#plot all at division and class level to check the difference between all vials
p1 <- long_nano_1 %>%
    # ps_threshold(class, 10) %>%
 #  ps_top(division,5) %>%
  mutate(division = fct_infreq(division))%>%
  mutate(division = fct_lump_n(division, 5, other_level = "Others")) %>%
  ggplot(aes(x=vial, y=n_reads, fill=division, color = division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted nano - division level") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) 
p1

pdf(here("phyloseq", "paper_c14", "20220406", "sorted nano division_all.pdf"), height=6, width=8) ; plot(p1) ; dev.off()
```

```{r}
# trophic mode for everything.
p <- long_nano_1 %>%
  ggplot(aes(x=vial, y=n_reads, fill=trophic_mode_2, color = trophic_mode_2)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted nano - trophic mode") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220406", "nano_trophic mode_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()


#plot trophic mode light vials
p <- long_nano_1 %>%
  filter(vial_type == "light") %>%
  #filter(!(trophic_mode_2 %in% c("dinophyceae", "syndiniales"))) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Sorted Nano light - trophic") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220406", "nano_trophic mode_light.pdf"), height=5, width=8) ; plot(p) ; dev.off()

#species level for all trophic groups. Combined vials A-C. Not very good.
for (i in c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales" )) {
  p2<- long_nano_1 %>%
  filter(trophic_mode_2 == i) %>%
  mutate(species = fct_infreq(species))%>%
  mutate(species = fct_lump_n(species, 10, other_level = "Others")) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle(str_c("Sorted Nano - ", i)) +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
print(p2)
pdf(here("phyloseq", "paper_c14", "20220406", str_c("nano_trophic species", i,".pdf")), height=5, width=8) ; plot(p2) ; dev.off()
}

#species level for all trophic groups. Combined vials A-C. Not very good.
for (i in c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales" )) {
  p2<- long_nano_1 %>%
  filter(trophic_mode_2 == i) %>%
  mutate(species = fct_infreq(species))%>%
  ps_top(species, 15) %>%
  #mutate(species = fct_lump_n(species, 10, other_level = "Others")) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle(str_c("Sorted Nano - top 10 species ", i)) +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
print(p2)
}

```

## Only for Dinophyceae
```{r}
#plot trophic mode for Dinophyceae light vials
p <- long_nano_1 %>%
  filter(vial_type == "light") %>%
  filter(class=="Dinophyceae") %>%
  filter(order != "Dinophyceae_X")%>%
  #filter(!(trophic_mode_2 %in% c("dinophyceae", "syndiniales"))) %>%
  ggplot(aes(x=vial, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted Nano light - Dinophyceae without Dinophyceae X") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220406", "nano_dino trophic mode_sub.pdf"), height=5, width=8) ; plot(p) ; dev.off()

#alot of dinophyceae X is classified as photosynthetic. Cannot see trends.
p <- long_nano_1 %>%
  filter(vial_type == "light") %>%
  mutate(taxa = case_when(order == "Dinophyceae_X"  ~ "Dinophyceae_X",
                          
               TRUE ~ as.character(order))) #else taxa remains the same


dino_trophic_list <- long_nano_1 %>%
  filter(vial_type == "light") %>%
  filter(trophic_mode_2 == "dinophyceae") %>%
  select(asv_code:trophic_mode, n_reads) %>%
  group_by(asv_code) %>%
  mutate(sum_n_reads = sum(n_reads))  %>%
  select(-n_reads) %>%
  distinct() %>%
  group_by(species) %>%
  arrange(desc(sum_n_reads))

dino_trophic_photo <- dino_trophic_list %>%
  filter(trophic_mode == "photosynthetic")
dino_trophic_mixo <- dino_trophic_list %>%
  filter(trophic_mode == "mixotrophic")
dino_trophic_hetero <- dino_trophic_list %>%
  filter(trophic_mode == "heterotrophic")

p2<- long_nano_1 %>%
  filter(class=="Dinophyceae") %>%
  filter(order != "Dinophyceae_X")%>%
  filter(trophic_mode =="heterotrophic") %>%
  mutate(species = fct_infreq(species))%>%
 # ps_top(species, 10) %>%
  mutate(species = fct_lump_n(species, 7, other_level = "Others")) %>%
  ggplot(aes(x=cycle_exp, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(fct_rev(SAMPLE)~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Sorted Nano - Dinophyceae") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
        #scale_colour_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps") +
        #scale_fill_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps")
        #scale_fill_viridis_d()+
       #   scale_color_viridis_d()
p2
pdf(here("phyloseq", "paper_c14", "20220406", "nano_dino hetero.pdf"), height=5, width=8) ; plot(p2) ; dev.off()
```


##remove low abundance ASV
load phyloseq > remove low abund? > normalise median > assign trophic> transform to long?
```{r}
ps_nano_abund <- ps_abund(ps_nano, 0.10)
ps_nano_abund <- phyloseq_normalize_median(ps_nano_abund)
ps_nano_abund <- phyloseq_assign_trophic(ps_nano_abund)
junk <- data.frame(ps_nano_abund@tax_table)
long_nano_abund <- phyloseq_transform_to_long(ps_nano_abund) %>%
  replace_na(list(trophic_mode = "photosynthetic"))
long_nano_abund$trophic_mode <- factor(long_nano_abund$trophic_mode, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))

p1 <- long_nano_abund %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle("Sorted nano - class level") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
p1

p1 <- long_nano_abund %>%
   # filter(trophic_mode %in% c("photosynthetic", "mixotrophic","heterotrophic")) %>%
  ggplot(aes(x=vial, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle("Sorted nano - class level") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p1

for (i in c("photosynthetic", "mixotrophic","dinophyceae", "syndiniales" )) {
  p<- long_nano_abund %>%
  filter(trophic_mode== i) %>%
  mutate(species = fct_infreq(species))%>%
  ggplot(aes(x=vial, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(fct_rev(SAMPLE)~cycle_exp_location_name, scales = "free_x") +
        ggtitle(str_c("Sorted nano abundant ASVs - ", i)) +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
  print(p)
}


```


# Filtered 18S
## Read data
```{r}
source(here("phyloseq", "init_files", "read_18s_filt.R"))

ps_filt <- phyloseq_assign_trophic(ps_18s_filt)
# Do normalizations and transformation
ps_filt <- phyloseq_normalize_median(ps_filt)
long_filt <- phyloseq_transform_to_long(ps_filt)


#order levels
long_filt <- long_filt %>%
  mutate(trophic_mode = fct_relevel(trophic_mode, "photosynthetic", "mixotrophic","heterotrophic", "syndiniales")) %>%
  mutate(trophic_mode_2 = fct_relevel(trophic_mode_2, "photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales")) %>%
  mutate(cycle_name_2 = fct_relevel(cycle_name_2, "ST1", "ST2", "SA1","SA2","SA3"))


```

```{r}
#pdf(here("phyloseq", "paper_c14", "20220406", "sorted filt18s treemap.pdf"), height=5, width=5) ; plot(phyloseq_long_treemap(long_filt_1, division, class, "Filtered sample")) ; dev.off()


p1 <- long_filt_1 %>%
  filter(sample_name != "CTD-18S-neg") %>%
   #ps_threshold(class, 5) %>%
   mutate(division = fct_infreq(division))%>%
 # mutate(class = fct_lump_prop(class, 0.10)) %>%
  mutate(division = fct_lump_n(division, 10, other_level = "Others")) %>%
  ggplot(aes(x=cycle_station, y=n_reads, fill=division, color = division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(depth~cycle_station, scales = "free_x") +
        ggtitle("Filtered 18SV4 - division level") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) 
p1

pdf(here("phyloseq", "paper_c14", "20220406", "filt_division all.pdf"), height=5, width=8) ; plot(p1) ; dev.off()


long_filt_1 <- long_filt_1 %>%
  filter(sample_name != "CTD-18S-neg") %>%
  mutate(depth_category_2 = recode(depth_category, "1" = "surface",
                                    "2" = "surface",
                                    "3" = "mid",
                                    "4" = "mid",
                                    "5" = "DCM",
                                    "6" = "DCM"))

long_filt_1$depth_category_2 <- factor(long_filt_1$depth_category_2, levels = c("surface", "mid", "DCM"))
p1 <- long_filt_1 %>%
  filter(sample_name != "CTD-18S-neg") %>%
   #ps_threshold(class, 5) %>%
   mutate(class = fct_infreq(class))%>%
 # mutate(class = fct_lump_prop(class, 0.10)) %>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, color = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        facet_grid(depth_category_2~cycle_name_2, scales = "free_x") +
        ggtitle("Filtered 18SV4 - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) 
p1
pdf(here("phyloseq", "paper_c14", "20220406", "filt_class depth cat.pdf"), height=5, width=8) ; plot(p1) ; dev.off()


p <- long_filt_1 %>%
  ggplot(aes(x=cycle_station, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")
        facet_grid(depth~cycle_station, scales = "free_x") +
        ggtitle("Sorted pico - trophic") +
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p

```
```{r}
ps_filt_abund <- ps_abund(ps_18s_filt, 0.10)
ps_filt_abund <- phyloseq_normalize_median(ps_filt_abund)
ps_filt_abund <- phyloseq_assign_trophic(ps_filt_abund)
junk <- data.frame(ps_filt_abund@tax_table)
long_filt_abund <- phyloseq_transform_to_long(ps_filt_abund) 

# create a new column for trophic mode, separate dinophyceae
long_filt_abund$trophic_mode_2 <- long_filt_abund$trophic_mode
long_filt_abund$trophic_mode_2<-ifelse(long_filt_abund$class=="Dinophyceae","dinophyceae",long_filt_abund$trophic_mode_2)
long_filt_abund$trophic_mode <- factor(long_filt_abund$trophic_mode, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))

long_filt_abund$cycle_name_2 <- factor(long_filt_abund$cycle_name_2, levels = c("ST1", "ST2", "SA1","SA2","SA3"))


long_filt_abund <- long_filt_abund %>%
  filter(sample_name != "CTD-18S-neg") %>%
  mutate(depth_category_2 = recode(depth_category, "1" = "surface",
                                    "2" = "surface",
                                    "3" = "mid",
                                    "4" = "mid",
                                    "5" = "DCM",
                                    "6" = "DCM"))

long_filt_abund$depth_category_2 <- factor(long_filt_abund$depth_category_2, levels = c("surface", "mid", "DCM"))

long_filt_1$trophic_mode_2 <- factor(long_filt_1$trophic_mode_2, levels = c("photosynthetic", "mixotrophic","heterotrophic", "dinophyceae", "syndiniales"))

p1 <- long_filt_abund %>%
    mutate(species = fct_infreq(species))%>%
  ggplot(aes(x=station, y=n_reads, fill=trophic_mode, color = trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")+
        facet_grid(depth_category_2~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("CTD - ASVs with 10% of reads per sample") +
        #scale_color_manual(values=speciesPalette, limits = force) + 
        #scale_fill_manual(values=speciesPalette, limits = force) 
        scale_colour_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps") +
        scale_fill_paletteer_d("colorBlindness::ModifiedSpectralScheme11Steps")
p1

pdf(here("phyloseq", "paper_c14", "20220406", "filt_to pASVs.pdf"), height=5, width=8) ; plot(p1) ; dev.off()

p1 <-  long_filt_abund
```

```{r}
#check unassigned
p2<- long_filt_abund %>%
  mutate(trophic_mode == replace_na(trophic_mode, "unassigned")) %>%
  filter(trophic_mode == "unassigned") %>%
  ggplot(aes(x=vial, y=n_reads, fill=species, color = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(depth_category_2~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Sorted nano - unassigned trophic") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) 
p2
#pdf("phyloseq/figures_20211021/sorted pico class_vial.pdf", height=5, width=8) ; plot(p1) ; dev.off()

```
