---
title: "Separate phyloseq sorted syn initials"
author: "Denise Ong"
date: "3/24/2022"
output: html_document
---

```{r}

library(here)
library(phyloseq)
library(dplyr)

ps_sorted <- read_rds(here("output_petb_2x300", "output_petb_Denise", "merged_v2", "petB_Denise primer_phyloseq_sortedsyn.RDS"))

otus <- data.frame(otu_table(ps_sorted))
taxa <- data.frame(tax_table(ps_sorted)) 
samples <- data.frame(sample_data(ps_sorted)) %>%
      filter(vial == "i") %>%
      filter(sample_name != "syn-02-5") %>%
      filter(sample_name != "syn-01-20") %>%
        mutate(sample_name = recode (sample_name, "syn-01-10" = "syn-01",
                                                "syn-02-10" = "syn-02"))
    
#preserve ASV before merging
taxa$asv_code <-rownames(taxa)

#put sample name back as sample's rowname
row.names(samples)<-samples$sample_name


#rename column for otus, to replace . with _
otus <- otus %>%
  rename_all(funs(stringr::str_replace_all(., '\\.', '-'))) %>%
   # rename("syn-01" = "syn-01-10",
    #       "syn-02" = "syn-02-10") %>%
    select("syn-01", "syn-02", "syn-07", "syn-08", "syn-23", "syn-30", "syn-33", "syn-38", "syn-43", "syn-46", "syn-50", "syn-55", "syn-60", "syn-64", "syn-69", "syn-74", "syn-79", "syn-84" )

# merge otus, taxa and samples table to form phyloseq object
otus <- as.matrix(otus)
taxa <- as.matrix(taxa)

otus= otu_table(otus, taxa_are_rows = TRUE)
taxa = tax_table(taxa)
samples = sample_data(samples)
ps_sorted <- merge_phyloseq(otus, taxa, samples)

ps_sorted <- ps_sorted %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 


ps_sorted

saveRDS(ps_sorted, here("output_petb_2x300", "output_petb_Denise", "merged_v2", "paper_sorted_initials", "petB_Denise primer_phyloseq_sortedsyn_initials.RDS"))

```

