---
title: "TAN1810 - petB R2 phyloseq"
author: "Denise Ong"
date: "9/6/2021"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---
The data is from the 2x250 petB run, so only the R2 sequences were processed here. There are 3 phyloseq files here:
1) "output_sorted_syn_unpaired/phyloseq_asv_set_D1.1.RDS"
2) "output_sorted_syn_unpaired/phyloseq_asv_set_D1.1_ESTU.RDS"
3) "output_CTD_petB_nested_unpaired/phyloseq_asv_set_D1.2.RDS"
4) "output_CTD_petB_normal_unpaired/phyloseq_asv_set_D1.3.RDS"


# Initialize
```{r, echo=TRUE, message=FALSE, warning=FALSE}

source("phyloseq/init.R") #for libraries
source("phyloseq/init_markdown.R") #for markdown libraries
source("phyloseq/define_functions.R") #functions to 1.transform to dataframe, 2.normalise and 3.create treemaps 
```

#C14 syn - to Subclade level
```{r}
# Read data

# Load the phyloseq files
ps <- read_rds("output_petb_2x250/output_sorted_syn_R2/D1.4_phyloseq_asv_set.RDS") 

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps)$water_mass <- sample_data(ps)$Cycle.
sample_data(ps)$water_mass = str_replace(sample_data(ps)$water_mass, "1|2|5", "SA") 
sample_data(ps)$water_mass = str_replace(sample_data(ps)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps)$cycle_location <- sample_data(ps)$Cycle.
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "1", "C")
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "2", "D") 
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "5", "E") 
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "3", "A")
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "4", "B")

sample_data(ps)$cycle_name <- sample_data(ps)$Cycle.
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps)$cycle_location_name <- str_c(sample_data(ps)$cycle_location, sample_data(ps)$cycle_name, sep ="_")


#vial type
sample_data(ps)$vial_type <- sample_data(ps)$vial
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "i", "initial") 
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "A|B|C", "light")
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "D", "dark")

# Remove ASVs that are not present in the dataset
ps <- ps %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps <- phyloseq_normalize_median(ps)
long <- phyloseq_transform_to_long(ps)
source("phyloseq/colours.R") # for colours, using Rcolourbrewer
```


```{r}
p <- long %>%
    filter(sample_name != "syn-negr1-2") %>%
    filter(sample_name != "syn-11") %>%
    filter(sample_name != "syn-12") %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("C14 sorted syn R2") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p

pdf("phyloseq/figures/20210916_C14 syn R2.pdf", height=5, width=8) ; plot(p) ; dev.off()
```


```{r}
# Check clade level
p <- long %>%
    mutate(Clade = fct_infreq(Clade))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Clade, fill=Clade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("C14 sorted syn R1 clade") +
        scale_color_manual(values=cladePalette, limits = force) + 
        scale_fill_manual(values=cladePalette, limits = force)
p

pdf("phyloseq/figures/20210909_C14 subclade_clade.pdf", height=5, width=8) ; plot(p) ; dev.off()

# Check genus level
p <- long %>%
    mutate(Genus = fct_infreq(Genus))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Genus, fill=Genus)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("C14 sorted syn R1 subclade level - clade") +
        scale_color_manual(values=genusPalette, limits = force) + 
        scale_fill_manual(values=genusPalette, limits = force)
p

```

```{r}
p <- long %>%
  filter(sample_name != "syn-negr1-2") %>%
  filter(sample_name != "syn-11") %>%
  filter(sample_name != "syn-12") %>%
  mutate(Subclade = fct_infreq(Subclade))%>%
  ggplot(aes(x=cycle_name, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~vial_type, scales = "free_x") +
        ggtitle("C14 sorted syn R1 vial type") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p

pdf("phyloseq/figures/20210916_C14 syn_vial type.pdf", height=5, width=8) ; plot(p) ; dev.off()
```


```{r}
p <- long %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name != "syn-negr1-2") %>%
    ggplot(aes(x=cycle_name, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(Incub.Time~cycle_name, scales = "free_x") +
        ggtitle("C14 sorted syn R1 subclade level - incubation time") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p
pdf("phyloseq/figures/20210909_C14 incubation.pdf", height=5, width=8) ; plot(p) ; dev.off()

p <- long %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name != "syn-negr1-2") %>%
    ggplot(aes(x=cycle_name, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(SAMPLE~cycle_name, scales = "free_x") +
        ggtitle("C14 sorted syn R1 subclade level - depth") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p
pdf("phyloseq/figures/20210909_C14 depth.pdf", height=5, width=8) ; plot(p) ; dev.off()
```


# CTD- petB nested Read data
```{r}
# Load the phyloseq files
ps_ctd_nested <- read_rds("output_petb_2x250/output_CTD_petB_nested_R2/D1.5_phyloseq_asv_set.RDS")

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps_ctd_nested)$water_mass <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$water_mass = str_replace(sample_data(ps_ctd_nested)$water_mass, "1|2|5", "SA") 
sample_data(ps_ctd_nested)$water_mass = str_replace(sample_data(ps_ctd_nested)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps_ctd_nested)$cycle_location <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "1", "C")
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "2", "D") 
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "5", "E") 
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "3", "A")
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "4", "B")

sample_data(ps_ctd_nested)$cycle_name <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps_ctd_nested)$cycle_location_name <- str_c(sample_data(ps_ctd_nested)$cycle_location, sample_data(ps_ctd_nested)$cycle_name, sep ="_")


# Remove ASVs that are not present in the dataset
ps_ctd_nested <- ps_ctd_nested %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps_ctd_nested <- phyloseq_normalize_median(ps_ctd_nested)
long_ctd_nested <- phyloseq_transform_to_long(ps_ctd_nested)
```

```{r}
p <- long_ctd_nested %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB nested R2 - subclade") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p

pdf("phyloseq/figures/20210916_CTD nested R2.pdf", height=5, width=8) ; plot(p) ; dev.off()

p <- long_ctd_nested %>%
    mutate(ESTU = fct_infreq(ESTU))%>%
  ggplot(aes(x=file_code, y=n_reads, color=ESTU, fill=ESTU)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("CTD petB nested R1 - ESTU") +
        scale_color_manual(values=ESTUPalette, limits = force) + 
        scale_fill_manual(values=ESTUPalette, limits = force)
p

pdf("phyloseq/figures/20210916_CTD nested R2.pdf", height=5, width=8) ; plot(p) ; dev.off()

```
```{r}
p <- long_ctd_nested %>%
    mutate(Clade = fct_infreq(Clade))%>%
   # filter(sample_name != "syn-negr1-2") %>%
  ggplot(aes(x=file_code, y=n_reads, color=Clade, fill=Clade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("CTD petB nested R1 - Clade") +
        scale_color_manual(values=cladePalette, limits = force) + 
        scale_fill_manual(values=cladePalette, limits = force)
p

pdf("phyloseq/figures/20210909_CTD nested_clade.pdf", height=5, width=8) ; plot(p) ; dev.off()

p <- long_ctd_nested %>%
    mutate(Genus = fct_infreq(Genus))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Genus, fill=Genus)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("CTD nested petB R1 Genus") +
        scale_color_manual(values=genusPalette, limits = force) + 
        scale_fill_manual(values=genusPalette, limits = force)
p

pdf("phyloseq/figures/20210909_CTD nested_genus.pdf", height=5, width=8) ; plot(p) ; dev.off()

```

# CTD- petB normal Read data
```{r}
# Load the phyloseq files
ps_ctd_normal <- read_rds("output_petb_2x250/output_CTD_petB_normal_R2/D1.6_phyloseq_asv_set.RDS")  # adding new component, this case the phyloseq object to the "tag" all

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps_ctd_normal)$water_mass <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$water_mass = str_replace(sample_data(ps_ctd_normal)$water_mass, "1|2|5", "SA") 
sample_data(ps_ctd_normal)$water_mass = str_replace(sample_data(ps_ctd_normal)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps_ctd_normal)$cycle_location <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "1", "C")
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "2", "D") 
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "5", "E") 
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "3", "A")
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "4", "B")

sample_data(ps_ctd_normal)$cycle_name <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps_ctd_normal)$cycle_location_name <- str_c(sample_data(ps_ctd_normal)$cycle_location, sample_data(ps_ctd_normal)$cycle_name, sep ="_")


# Remove ASVs that are not present in the dataset
ps_ctd_normal <- ps_ctd_normal %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps_ctd_normal <- phyloseq_normalize_median(ps_ctd_normal)
long_ctd_normal <- phyloseq_transform_to_long(ps_ctd_normal)
```

```{r}
p <- long_ctd_normal %>%
    filter(sample_name != "CTD-petB-neg2") %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
   # filter(sample_name != "syn-negr1-2") %>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB normal R2 - subclade") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p

pdf("phyloseq/figures/202109016_CTD normal R2.pdf", height=5, width=8) ; plot(p) ; dev.off()


p <- long_ctd_normal %>%
    mutate(ESTU = fct_infreq(ESTU))%>%
  ggplot(aes(x=file_code, y=n_reads, color=ESTU, fill=ESTU)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("CTD petB normal R1 - ESTU") +
        scale_color_manual(values=ESTUPalette, limits = force) + 
        scale_fill_manual(values=ESTUPalette, limits = force)
p

pdf("phyloseq/figures/20210909_CTD normal_ESTU.pdf", height=5, width=8) ; plot(p) ; dev.off()


p <- long_ctd_normal %>%
    mutate(Clade = fct_infreq(Clade))%>%
   # filter(sample_name != "syn-negr1-2") %>%
  ggplot(aes(x=file_code, y=n_reads, color=Clade, fill=Clade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid (.~cycle_name, scales = "free_x") +
        ggtitle("CTD petB normal R1 - clade") +
        scale_color_manual(values=cladePalette, limits = force) + 
        scale_fill_manual(values=cladePalette, limits = force)
p

pdf("phyloseq/figures/20210909_CTD normal_clade.pdf", height=5, width=8) ; plot(p) ; dev.off()
```

```{r}
p <- long_ctd_normal %>%
    mutate(Subclade = fct_infreq(Subclade))%>%
   # filter(sample_name != "syn-negr1-2") %>%
  ggplot(aes(x=cycle_name, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(depth~., scales = "free_x") +
        ggtitle("CTD petB normal R1 - subclade") +
        scale_color_manual(values=subcladePalette, limits = force) + 
        scale_fill_manual(values=subcladePalette, limits = force)
p

p <- long_ctd_normal %>%
    mutate(Genus = fct_infreq(Genus))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Genus, fill=Genus)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~cycle_name, scales = "free_x") +
        ggtitle("CTD normal petB R1 Genus") +
        scale_color_manual(values=genusPalette, limits = force) + 
        scale_fill_manual(values=genusPalette, limits = force)
p

#pdf("phyloseq/figures/20210909_CTD normal_Genus.pdf", height=5, width=8) ; plot(p) ; dev.off()

```

