---
title: "18S filt vs sort"
author: "Denise Ong"
date: "10/27/2022"
output: html_document
---

# Initialize
```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("phyloseq", "init_files", "init.R")) #for libraries
source(here("phyloseq", "init_files", "init_markdown.R")) #for markdown libraries
source(here("phyloseq", "init_files", "define_functions.R")) #functions to 1.transform to dataframe, 2.normalise and 3.create treemaps
source(here("phyloseq", "trophic_mode", "trophic_function.R"))  #function to assign trophic level for phyloseq objects
source(here("phyloseq", "init_files", "colours_18sv4.R")) # predetermined colours
#source(here("phyloseq", "init_files", "colours_random.R")) #random colours
```
#read data
```{r}
source(here("phyloseq", "init_files", "read_18s_filt_sort.R"))

ps_filt_sort <- phyloseq_assign_trophic(ps_filt_sort) %>%
    subset_taxa(trophic_mode_2 != "heterotrophic") #remove heterotrophs
# Do normalizations and transformation
ps_filt_sort <- phyloseq_normalize_median(ps_filt_sort)
long_filt_sort <- phyloseq_transform_to_long(ps_filt_sort) %>%
  mutate(cycle_name_2 = fct_relevel(cycle_name_2, "ST1", "ST2", "SA1", "SA2", "SA3")) %>%
  mutate(sample = fct_relevel(sample, "SUR", "DCM"))
```

```{r, eval= FALSE}
#add experiment number for correspondin filt samples.
exp <- data.frame(ps_filt_sort@sam_data) %>%
  select(ctd_cast, exp) %>%
  distinct() %>%
  filter(!(is.na(exp)))
rownames(exp) <- NULL

long_filt_sort <- full_join(long_filt_sort,exp) %>%
  select(exp, sample_name)

#create levels for factors
long_pico_1$cycle_exp <- factor(long_pico_1$cycle_exp, levels = c("ST1_7", "ST1_8", "ST2_9", "ST2_10", "SA1_1", "SA1_2", "SA2_3", "SA2_4", "SA2_5", "SA2_6", "SA3_11"))
long_pico_1$trophic_mode <- factor(long_pico_1$trophic_mode, levels = c("photosynthetic", "mixotrophic", "heterotrophic", "dinophyceae"))
long_pico_1$cycle_name_2 <- factor(long_pico_1$cycle_name_2, levels = c("ST1", "ST2", "SA1","SA2","SA3"))

```

check overlapping samples
```{r}
sample <- data.frame(ps_filt_sort@sam_data) %>%
    select(ctd_cast, station, depth, sample_type, cycle_name_2) %>%
    distinct() %>%
    pivot_wider(names_from = depth, values_from = sample_type)
```

#check photosynthetic in filt not included in sorted
```{r}
long_sorted_asvhash <- long_filt_sort %>%
    filter(sample_type != "filt") %>%
    select(asv_code) 

long_filt<- long_filt_sort %>%
    filter(sample_type == "filt")

long_filt_anti <- anti_join(long_filt, long_sorted_asvhash) %>%
  distinct() %>%
  # mutate(in_sorted = "no") %>%
    mutate(in_sorted = case_when(class == "Dinophyceae" ~ "dinophyceae",
                               TRUE~ "no"))  %>%
  filter(class != "Syndiniales") %>%
  filter(species != "Dinophyceae_XXX_sp.") %>%
  filter(trophic_mode == "photosynthetic") 

long_filt_sort <- inner_join(long_filt, long_sorted_asvhash) %>%
    distinct() %>%
  mutate(in_sorted = "yes")


long_filt_sort_join <- full_join(long_filt_anti, long_filt_sort) %>%
  filter(class != "Syndiniales") %>%
  filter(species != "Dinophyceae_XXX_sp.") %>%
  filter(trophic_mode == "photosynthetic") 

# check proportion of photosynthetic not in sorted
p  <- long_filt_sort_join %>%
  ggplot(aes(x=station, y=n_reads, fill=in_sorted, colour = in_sorted)) +
  geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") 
p

# check proportion of dinophyceae
p  <- long_filt_anti %>%
  ggplot(aes(x=station, y=n_reads, fill=trophic_mode_2, colour = trophic_mode_2)) +
  geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") 
p

#check composition of not sorted
p1 <- long_filt_anti %>%
  filter(trophic_mode_2 !="dinophyceae") %>%
  mutate(order = fct_lump_n(order, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=order, colour = order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filtered photosynthetic - not in sorted") +
        scale_color_manual(values=orderPalette, limits = force) +
        scale_fill_manual(values=orderPalette, limits = force) +
  ylab("Proportion of reads")
p1

#check diatoms
p <- long_filt_anti %>%
  filter(order == "Bacillariophyta_X") %>%
  # mutate(order = fct_lump_n(order, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=family, colour = family)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filtered photosynthetic - not in sorted - Bacillariophyta_X") +
        scale_color_manual(values=familyPalette, limits = force) +
        scale_fill_manual(values=familyPalette, limits = force) +
  ylab("Proportion of reads")
p

#list

list <- long_filt_anti %>%
  filter(trophic_mode_2 !="dinophyceae") %>%
  group_by(kingdom, supergroup, division, class, order, family, genus, species) %>%
  summarise(sum_reads = sum(n_reads))
  
```

#pico vs filt
```{r}
long_pico_asvhash <- long_filt_sort %>%
    filter(sample_type == "Pico") %>%
    select(asv_code)


long_pico <- long_filt_sort %>%
    filter(sample_type == "Pico") 
%>%
    filter(class != "Dinophyceae")

long_filt<- long_filt_sort %>%
    filter(sample_type == "filt") 
# %>%
#     filter(class != "Dinophyceae")

long_filt_pico <- inner_join(long_filt, long_pico_asvhash) %>%
    distinct()



# pivot longer dataframe
otu_rel_abund <- long_filt_pico %>%
    group_by(file_code) %>%
    mutate(rel_abund = n_reads / sum(n_reads)) %>%
    ungroup() %>%
    select(-n_reads) %>%
    pivot_longer(cols = asv_code:species,
                 names_to = "level",
                 values_to = "taxon") 

taxon_rel_abund <- otu_rel_abund %>%
    filter(level == "class") %>% #choose level here 
    group_by(water_mass, cycle_name_2, file_code, taxon) %>%
    summarise(rel_abund = 100*sum(rel_abund)) %>%
    pivot_wider(names_from = taxon, values_from = rel_abund) %>% #from here is to replace any file_code with NA as 0
    replace(., is.na(.), 0) %>%
    pivot_longer(cols= !water_mass:file_code,
                 names_to = "taxon",
                 values_to = "rel_abund")
## summary for results
summary <- taxon_rel_abund %>%
  filter(taxon %in% c("Mamiellophyceae", "Chrysophyceae","Pelagophyceae","Prymnesiophyceae", "Chloropicophyceae")) %>%
  # filter(cycle_name_2 == "SA1") %>%
  group_by(taxon, water_mass) %>%
  summarise(median = median(rel_abund),
            mean = mean(rel_abund))
summary
```

```{r}

p1 <- long_pico %>%
  # mutate(class = fct_infreq(taxa))%>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1

# pdf("phyloseq/paper_c14/figures/pico_class.pdf", height=5, width=8) ; plot(p1) ; dev.off()

p2 <- long_filt_pico %>%
    mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2

# pdf("phyloseq/paper_c14/figures/filt_pico_class.pdf", height=5, width=8) ; plot(p2) ; dev.off()
```

#also need to check by depth
```{r}
filt_pico_merge <-full_join(long_pico,long_filt_pico) %>%
  distinct()

p <- filt_pico_merge %>%
  filter(sample %in% c("SUR", "DCM")) %>%
  unite("cycle_station", cycle_name_2, station, sep = "_") %>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=sample_type, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(sample~cycle_station, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p

p1 <- long_pico %>%
  # mutate(class = fct_infreq(taxa))%>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(sample~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1

p2 <- long_filt_pico %>%
  filter(class != "Dinophyceae") %>%
  filter(sample %in% c("SUR", "DCM")) %>%
    mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(sample~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2

```


#only filt pico ASVs, surface and DCM
```{r}
p2 <- long_filt_pico %>%
  filter(sample %in% c("SUR", "DCM")) %>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(sample~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2

#chloropicophyceae is alot in station 137 and 371 - check across the depth if it is a sample error or if there are really alot of chloropico
p <-  long_filt_pico %>%
  filter(station %in% c("137", "188", "324", "371")) %>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(depth_category~cycle_name_2, scales = "free_x", space = "free") +
        ggtitle("Filt, overlap ASVs to pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p
pdf("phyloseq/paper_c14/figures/filt_pico_mamiello check.pdf", height=5, width=8) ; plot(p) ; dev.off()
```

#pico vs filt - Chloropicophyceae
```{r}
p1 <- long_pico %>%
  filter(class== "Chloropicophyceae") %>%
  # mutate(class = fct_infreq(taxa))%>%
#  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=species, colour = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        #scale_color_manual(values=classPalette, limits = force) + 
        #scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1

#pdf("phyloseq/paper_c14/figures/pico_class.pdf", height=5, width=8) ; plot(p1) ; dev.off()

p2 <- long_filt_pico %>%
   filter(class== "Chloropicophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=species, colour = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - Chloropicophyceae class") +
        #scale_color_manual(values=classPalette, limits = force) + 
        #scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2

pdf("phyloseq/paper_c14/figures/filt_pico_mamiello.pdf", height=5, width=8) ; plot(p2) ; dev.off()
```
#pico vs filt - Dictyochophyceae
```{r}
p1 <- long_pico %>%
  filter(class== "Dictyochophyceae") %>%
  # mutate(class = fct_infreq(taxa))%>%
#  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=species, colour = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        #scale_color_manual(values=classPalette, limits = force) + 
        #scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1
pdf("phyloseq/paper_c14/figures/pico_Dictyochophyceae.pdf", height=5, width=8) ; plot(p1) ; dev.off()

p2 <- long_filt_pico %>%
   filter(class== "Dictyochophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=species, colour = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - Mamiellophyceae class") +
        #scale_color_manual(values=classPalette, limits = force) + 
        #scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2
pdf("phyloseq/paper_c14/figures/filt_pico_Dictyochophyceae.pdf", height=5, width=8) ; plot(p2) ; dev.off()
```
```{r}
p1 <- long_filt_pico %>%
  filter(class== "Pelagophyceae") %>%
  # mutate(class = fct_infreq(taxa))%>%
#  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=species, colour = species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico") +
        #scale_color_manual(values=classPalette, limits = force) + 
        #scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1
```


#nano vs filt
```{r}
long_nano_asvhash <- long_filt_sort %>%
    filter(sample_type == "Nano") %>%
    select(asv_code)

long_nano <- long_filt_sort %>%
    filter(sample_type == "Nano") 
# %>%
#   filter(class != "Dinophyceae")

long_filt_nano <- inner_join(long_filt, long_nano_asvhash) %>%
    distinct()

# pivot longer dataframe
otu_rel_abund <- long_filt_nano %>%
    group_by(file_code) %>%
    mutate(rel_abund = n_reads / sum(n_reads)) %>%
    ungroup() %>%
    select(-n_reads) %>%
    pivot_longer(cols = asv_code:species,
                 names_to = "level",
                 values_to = "taxon") 

taxon_rel_abund <- otu_rel_abund %>%
    filter(level == "class") %>% #choose level here 
    group_by(water_mass, cycle_name_2, file_code, taxon) %>%
    summarise(rel_abund = 100*sum(rel_abund)) %>%
    pivot_wider(names_from = taxon, values_from = rel_abund) %>% #from here is to replace any file_code with NA as 0
    replace(., is.na(.), 0) %>%
    pivot_longer(cols= !water_mass:file_code,
                 names_to = "taxon",
                 values_to = "rel_abund")

## summary for results
summary <- taxon_rel_abund %>%
  filter(taxon %in% c("Bacillariophyta")) %>%
  # filter(cycle_name_2 %in% c("SA1", "SA2")) %>%
  group_by(taxon, cycle_name_2) %>%
  summarise(median = median(rel_abund),
            mean = mean(rel_abund))
summary
```


```{r}
p1 <- long_nano %>%
  # mutate(class = fct_infreq(taxa))%>%
  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Sorted nano - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p1

# pdf("phyloseq/paper_c14/figures/nano_class.pdf", height=5, width=8) ; plot(p1) ; dev.off()


p2 <- long_filt_nano %>%
    filter(class!= "Mamiellophyceae") %>%
    mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill=class, colour = class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to nano - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p2
# pdf("phyloseq/paper_c14/figures/filt_nano_class.pdf", height=5, width=8) ; plot(p2) ; dev.off()

```


lots of Mamiellophyceae in the filt nano samples. checking
```{r}
p2 <- long_filt_pico %>%
    filter(class == "Mamiellophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill = species, colour =species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to pico - class level") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p2
pdf("phyloseq/paper_c14/figures/filt_pico_mamiello.pdf", height=5, width=8) ; plot(p2) ; dev.off()
p2 <- long_filt_nano %>%
    filter(class == "Mamiellophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill = species, colour =species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to nano - class level") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p2
pdf("phyloseq/paper_c14/figures/filt_nano_mamiello.pdf", height=5, width=8) ; plot(p2) ; dev.off()

```

#also need to check by depth
```{r}
p <-  long_filt_nano %>%
    #filter(vial_type == "light") %>%
  filter(depth_category %in% c("2", "5")) %>%
    #filter(!(cycle_exp =="SA1_2")) %>%
  #mutate(SAMPLE=factor(SAMPLE, levels = c("SUR", "DCM"))) %>%
    #complete(cycle_exp, vial_type, SAMPLE) %>%
    #mutate(order = fct_infreq(order)) %>%
    mutate(order = fct_lump_n(order, 20, other_level = "Others")) %>%
    mutate(order = factor(order, levels = c("Dolichomastigales", "Pyramimonadales","Cryptomonadales", "Dinophyceae_X", "Suessiales", "Gymnodiniales","Peridiniales", "Prorocentrales", "Isochrysidales", "Prymnesiales", "Phaeocystales","Syracosphaerales" , "Bacillariophyta_X", "Dictyochophyceae_X", "MOCH-2_X", "Nephroselmidales", "Haptophyta_Clade_HAP5", "Others"))) %>%
  filter(order != "NA") %>%
  ggplot(aes(x=station, y=n_reads, fill=order, colour=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(depth_category~cycle_name_2, scales = "free_x") +
        ggtitle("Filt overlap sorted nano - class level") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #scale_fill_manual(values=latin_palette('karolg', 15)) +
        scale_fill_manual(values=colours_18s_order, limits = force) +
  scale_colour_manual(values=colours_18s_order, limits = force)+
  ylab("Proportion of reads")
p
pdf("phyloseq/paper_c14/figures/filt_nano_depth_2.pdf", height=5, width=8) ; plot(p) ; dev.off()

```
#nano vs filt - Dictyochophyceae
```{r}
p2 <- long_nano %>%
    filter(class == "Dictyochophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill = species, colour =species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Sorted nano - Dictyochophyceae") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p2
#pdf("phyloseq/paper_c14/figures/filt_pico_mamiello.pdf", height=5, width=8) ; plot(p2) ; dev.off()
p2 <- long_filt_nano %>%
    filter(class == "Dictyochophyceae") %>%
   # mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  ps_top(class, 8) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=station, y=n_reads, fill = species, colour =species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
        facet_grid(.~cycle_name_2, scales = "free_x") +
        ggtitle("Filt, overlap ASVs to nano - Dictyochophyceae") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p2
#pdf("phyloseq/paper_c14/figures/filt_nano_mamiello.pdf", height=5, width=8) ; plot(p2) ; dev.off()

```

