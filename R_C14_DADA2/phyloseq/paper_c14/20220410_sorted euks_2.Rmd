---
title: "20220410_18S C14"
author: "Denise Ong"
date: "4/10/2022"
output: html_document
---
Based on meeting on 8 April, 
- remove Syndiniales
- select top 10 species for each sample, instead of across all samples.
- focus only on sorted samples.
- always plot initial and light beside each other. 

# Initialize
```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(here)
source(here("phyloseq", "init_files", "init.R")) #for libraries
source(here("phyloseq", "init_files", "init_markdown.R")) #for markdown libraries
source(here("phyloseq", "init_files", "define_functions.R")) #functions to 1.transform to dataframe, 2.normalise and 3.create treemaps 
source(here("phyloseq", "init_files", "colours_18sv4.R")) # predetermined colours
#source(here("phyloseq", "init_files", "colours_random.R")) #random colours
# Function to assign trophic function for phyloseq objects
source(here("phyloseq", "trophic_mode", "trophic_function.R"))  
```

```{r}
#select top n taxa in each sample
ps_top <- function(ps_long, taxa, top_n) {
  ps_long <- ps_long %>%
  group_by(file_code, {{taxa}}) %>%
  summarise(sum_n_reads = sum(n_reads)) %>%
  slice_max(order_by = sum_n_reads, n = {{top_n}}) %>%
  left_join(ps_long) %>%
    select(-sum_n_reads) %>%
    ungroup()
}
#select top n ASV in each sample
ps_top_asv <- function(ps_long, top_n) {
  ps_long <- ps_long %>%
  group_by(file_code, asv_code) %>%
  summarise(sum_n_reads = sum(n_reads)) %>%
  slice_max(order_by = sum_n_reads, n = {{top_n}}) %>%
  left_join(ps_long) %>%
    select(-sum_n_reads) %>%
    ungroup()
}
# Only take asvs that represent at least 10% of reads in any given sample
ps_abund <- function(ps, fraction) {
  total = median(sample_sums(ps))
  ps <- filter_taxa(ps, function(x) sum(x > total*fraction) > 0, TRUE)
}
```

# Sorted pico
## Read data
```{r}
source(here("phyloseq", "init_files", "read_pico.R"))

#Assign trophic mode
ps_pico_1 <- phyloseq_assign_trophic(ps_pico)
# Do normalizations and transformation
ps_pico_1 <- phyloseq_normalize_median(ps_pico_1)
long_pico_1 <- phyloseq_transform_to_long(ps_pico_1) 

# create a new column for trophic mode, separate dinophyceae
long_pico_1$trophic_mode_2 <- long_pico_1$trophic_mode
long_pico_1$trophic_mode_2<-ifelse(long_pico_1$class=="Dinophyceae","dinophyceae",long_pico_1$trophic_mode_2)

#create levels for factors
long_pico_1 <- long_pico_1 %>%
    mutate(cycle_exp = fct_relevel(cycle_exp, "ST1_7", "ST1_8", "ST2_9", "ST2_10", "SA1_1", "SA1_2", "SA2_3", "SA2_4", "SA2_5", "SA2_6", "SA3_11")) %>%
    mutate(trophic_mode_2 = fct_relevel(trophic_mode_2, "photosynthetic", "mixotrophic", "heterotrophic", "dinophyceae")) %>%
    mutate(cycle_name_2 = fct_relevel(cycle_name_2, "ST1", "ST2", "SA1", "SA2", "SA3"))

```

## checks
### Duplicates - remove 1-pico-30
1-pico-30 is dominated by  Gyriodinium fusiform, only nano 12 is also dominated. It is a heterotroph.  Also has Caetoceros peruvianus. It is micro size. So probably during high number of sorting will also be sorted. Remove this sample. Rest of the samples are ok and will be combined.
```{r}
check <- data.frame(ps_pico@sam_data) 

p <- long_pico_1 %>%
  filter(file_code %in% c("pico-01-10", "pico-01-30", "pico-02", "pico-02-10", "pico-02-10-1", "pico-03-10", "pico-03-2", "pico-03-4")) %>%
  #filter(species !=  "Gyrodinium_fusiforme") %>%
  ggplot(aes(x=file_code, y=n_reads, fill=species))+
  geom_bar(position="fill", stat="identity", size=0.5) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ggtitle("Sorted pico - repicates check") +
        scale_color_manual(values=speciesPalette, limits = force) + 
        scale_fill_manual(values=speciesPalette, limits = force) +
  ylab("Proportion of reads")
p
```

### check heterotrophs- removed
besides Spumella_elongata in one sample at 50% - dark (only present in this sample). After removing Spumella and Gyrodinium fusiform, average of 1% of heterotrophs in each sample. 
```{r}
#check percentage of heterotrophs in samples.
het <- long_pico_1 %>%
  group_by(file_code) %>%
  mutate(sum_n_reads = sum(n_reads)) %>%
  mutate(pct_n_reads = n_reads/sum_n_reads*100) %>%
  select(file_code, trophic_mode, asv_code, species, pct_n_reads) %>%
  filter(trophic_mode == "heterotrophic") #%>%
  #ungroup() %>%
  #filter(!(species %in% c("Gyrodinium_fusiforme", "Spumella_elongata"))) %>%
  #summarise(mean = mean(pct_n_reads))
  
p <- long_pico_1 %>%
     ps_top_asv(15) %>%
  filter(trophic_mode_2 == "heterotrophic") %>%  
    mutate(species = fct_infreq(species)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - heterotrophic check") +
        scale_fill_manual(values=speciesPalette, limits = force) 
p
```

### check pico-15 - removed
check pico-15 dominated by Dinophyceae XXX sp, 2 ASVs of 39 and 92. Only found in this one sample for pico, but also detected at lower number of reads in nano.
```{r}
p <- long_pico_1 %>%
  filter(sample_name == "pico-15") %>%
  ggplot(aes(x=vial, y=n_reads, fill=asv_code)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted pico-15") +
  ylab("Proportion of reads")
p
#pdf(here("phyloseq", "paper_c14", "20220411", "pico", "pico-15 check.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```

##edit long form after checks
```{r}
#after all the checks,  editing the long form pico.
long_pico_2 <- long_pico_1 %>%
  filter(!(file_code %in% c("pico-01-30", "pico-15"))) %>%
  filter(trophic_mode_2 != "heterotrophic")
```

## plot number of ASVs per sample
average number of ASVs per sample is 20.
```{r}
pico_asv <- long_pico_2 %>%
    select(file_code, asv_code) %>%
    group_by(file_code) %>%
    summarise(n = n())
hist(pico_asv$n)
mean(pico_asv$n)
```
Removing the following samples:
- SA1_1, DCM: only initial
- SA1_2 DCM: only initial
- SA1_2 SUR: only A and initial.
- SA2_3, DCM. only B and dark.

Average number of ASVs per sample is 20, so plot half the number of ASVs
All plots filtered top 10 ASVs per sample. As pico is dominated by few ASVs, the overall community is still well-represented.

## Plot all at division and class level
```{r}
#treemap
p <- phyloseq_long_treemap(long_pico_2, division, class, "Sorted Pico")
#pdf(here("phyloseq", "paper_c14", "20220411", "sorted pico treemap.pdf"), height=5, width=5) ; plot(phyloseq_long_treemap(long_pico_2, division, class, "Sorted Pico")) ; dev.off()

#plot all at division and class level to check the difference between all vials
p <- long_pico_2 %>%
  #ps_top_asv(10) %>% #filter top 10 ASV per sample
  mutate(division = fct_infreq(division)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - division level") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) +
  ylab("Proportion of reads")
p

pdf(here("phyloseq", "paper_c14", "20220411", "pico", "pico_division_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()

p <- long_pico_2 %>%
  ps_top_asv(10) %>% #filter top 10 ASV per sample
  mutate(division = fct_infreq(division)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - division level - top 10 ASV per sample") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) +
  ylab("Proportion of reads")
p

pdf(here("phyloseq", "paper_c14", "20220411", "pico", "pico_division_sub.pdf"), height=5, width=8) ; plot(p) ; dev.off()

p <- long_pico_2 %>%
  #ps_top_asv(10) %>% #filter top 10 ASV per sample
  mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p

p <- long_pico_2 %>%
  ps_top_asv(10) %>% #filter top 10 ASV per sample
  mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted pico - class level - top 10 ASV per sample") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p


#pdf(here("phyloseq", "paper_c14", "20220411", "sorted pico class_all.pdf"), height=5, width=8) ; plot(p1) ; dev.off()
```

## remove few samples and groups, combine light vials.
```{r}
#subset few groups
long_pico_3 <- long_pico_2 %>%
    filter(!(cycle_exp =="SA1_2" & SAMPLE == "DCM")) %>%
    filter(!(cycle_exp == "SA1_1" & SAMPLE == "DCM")) %>%
    filter(vial_type != "dark") %>%
  ps_top_asv(10)
  #ps_top(species, 5)

p <- long_pico_3 %>%
   ps_top_asv(10) %>%
  mutate(division = fct_infreq(division)) %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - division level") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #scale_fill_manual(values=latin_palette('buenavista',6)) +
        ylab("Proportion of reads") +
        scale_fill_manual(values=divisionPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "pico", "sorted pico division_2.pdf"), height=5, width=8) ; plot(p) ; dev.off()

p <- long_pico_3 %>%
    ps_top_asv(10) %>%
    mutate(class = fct_lump_n(class, 7, other_level = "Others")) %>%
    mutate(class = fct_relevel(class, c("Mamiellophyceae", "Chloropicophyceae", "Pyramimonadophyceae", "Trebouxiophyceae", "Prymnesiophyceae", "Haptophyta_Clade_HAP3", "Bolidophyceae", "Bacillariophyta", "Chrysophyceae", "Dictyochophyceae", "Pelagophyceae", "MOCH-2","Dinophyceae", "Prasinodermophyceae", "Cryptophyceae"))) %>%
  #mutate(class = fct_relevel(class, c("Mamiellophyceae", "Chloropicophyceae", "Prymnesiophyceae", "Haptophyta_Clade_HAP3", "Bolidophyceae", "Bacillariophyta", "Chrysophyceae",  "Pelagophyceae", "Dinophyceae", "Cryptophyceae"))) %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - class level") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #scale_fill_manual(values=latin_palette('karolg', 15)) +
        scale_fill_manual(values=colours_18s_class, limits = force) +
  ylab("Proportion of reads")
p
pdf(here("phyloseq", "paper_c14", "20220411", "pico", "pico_class.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```


## trophic mode
```{r}
# trophic mode for everything
p <- long_pico_3 %>%
  ggplot(aes(x=vial, y=n_reads, fill=trophic_mode_2, color = trophic_mode_2)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted pico - trophic mode") +
        #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "pico", "pico_trophic mode_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()

#photo
p3 <- long_pico_3 %>%
    filter(trophic_mode_2 == "photosynthetic") %>%  
    mutate(class = fct_lump_n(class, 6, other_level = "Others")) %>%
    mutate(class = fct_relevel(class, c("Mamiellophyceae", "Chloropicophyceae", "Prymnesiophyceae", "Bacillariophyta", "Bolidophyceae","Pelagophyceae", "Others"))) %>%
  #mutate(class = fct_infreq(class)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - photosynthetic") +
        scale_fill_manual(values=colours_18s_class, limits = force) 
p3

pdf(here("phyloseq", "paper_c14", "20220411", "pico_photo class.pdf"), height=6, width=9) ; plot(p3) ; dev.off()

# top 7 species

p3 <- long_pico_3 %>%
  filter(trophic_mode_2 == "photosynthetic") %>%  
  filter(class == "Prymnesiophyceae")  %>%
  mutate(species = fct_infreq(species)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - photosynthetic") +
        scale_fill_manual(values=speciesPalette, limits = force) 
p3


# mixo
p3 <- long_pico_3 %>%
   filter(trophic_mode_2 == "mixotrophic") %>% 
    #mutate(class = fct_lump_n(class, 7, other_level = "Others")) %>%
    #mutate(class = fct_relevel(class, c("Mamiellophyceae", "Chloropicophyceae", "Prymnesiophyceae", "Bacillariophyta", "Bolidophyceae","Pelagophyceae"))) %>%
  mutate(class = fct_infreq(class)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=genus)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - mixotrophic") +
        scale_fill_manual(values=genusPalette, limits = force) 
p3

pdf(here("phyloseq", "paper_c14", "20220411", "pico_mixo class.pdf"), height=6, width=9) ; plot(p3) ; dev.off()
```

# Pico Dinophyceae 
- not dominant in pico samples
- only present in higher  proportion  in few samples
  - ST1-7 sur initial
  - SA1-1 sur initial
  - SA2-3 sur initial
  
  
```{r}
#plot for light vials, average of all light vials
p3 <- long_pico_2 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  ggplot(aes(x=vial_type, y=n_reads, fill=trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - dinophyceae") +
        scale_fill_manual(values=trophicPalette, limits = force) 
p3
p3 <- long_pico_2 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  ggplot(aes(x=vial_type, y=n_reads, fill=species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted pico - dinophyceae") +
        scale_fill_manual(values=speciesPalette, limits = force) 
p3

#pdf(here("phyloseq", "paper_c14", "20220406", "pico_mixo species.pdf"), height=6, width=9) ; plot(p3) ; dev.off()
```

# Sorted nano
Check nano-12 SA1_2, DCM, vial A.

## Read data
```{r}
source(here("phyloseq", "init_files", "read_nano.R"))

#assign trophic mode
ps_nano_1 <- phyloseq_assign_trophic(ps_nano)
# Do normalizations and transformation
ps_nano_1 <- phyloseq_normalize_median(ps_nano_1)
long_nano_1 <- phyloseq_transform_to_long(ps_nano_1)

# create a new column for trophic mode, separate dinophyceae
long_nano_1$trophic_mode_2 <- long_nano_1$trophic_mode
long_nano_1$trophic_mode_2<-ifelse(long_nano_1$class=="Dinophyceae","dinophyceae",long_nano_1$trophic_mode_2)

#order all the factors
long_nano_1 <- long_nano_1 %>%
  mutate(cycle_exp = fct_relevel(cycle_exp, "ST1_7", "ST1_8", "ST2_9", "ST2_10", "SA1_1", "SA1_2", "SA2_3", "SA2_4", "SA2_5", "SA2_6", "SA3_11")) %>%
  mutate(trophic_mode = fct_relevel(trophic_mode, "photosynthetic", "mixotrophic", "heterotrophic"))  %>%
  mutate(trophic_mode_2 = fct_relevel(trophic_mode_2, "photosynthetic", "mixotrophic",  "heterotrophic", "dinophyceae"))  %>%
  mutate(cycle_name_2 =  fct_relevel(cycle_name_2,"ST1", "ST2", "SA1", "SA2", "SA3"))
```
##check
### check heterotrophics - removed.
```{r}

p <- long_nano_1 %>%
     ps_top_asv(15) %>%
  filter(trophic_mode_2 == "heterotrophic") %>%  
    mutate(species = fct_infreq(species)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=species)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - heterotrophic check") +
        scale_fill_manual(values=speciesPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano-12 check.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```

### check nano-12
Checking nano-12 because from the NMDS the community is very different from other samples. Dominated by one ASV belonging to Gyrodinium_fusiforme, which is a heterotrophic Dinophyceae. Remove this sample.
```{r}
p <- long_nano_1 %>%
  filter(sample_name == "nano-12") %>%
  ggplot(aes(x=vial, y=n_reads, fill=asv_code)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted nano-12") +
       # scale_color_manual(values=divisionPalette, limits = force) + 
       # scale_fill_manual(values=divisionPalette, limits = force) +
  ylab("Proportion of reads")
p
pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano-12 check.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```

##edit long form after checks
```{r}
#after all the checks,  editing the long form pico.
long_nano_2 <- long_nano_1 %>%
  filter(!(file_code %in% c("nano-12"))) %>%
  filter(trophic_mode != "heterotrophic")  

long_nano_3 <- long_nano_2 %>%
  ps_top_asv(15)
```

## plot number of ASVs per sample
```{r}
nano_asv <- long_nano_2 %>%
    select(file_code,asv_code) %>%
    group_by(file_code) %>%
    summarise(n = n())
hist(nano_asv$n)
mean(nano_asv$n)
```
Average number of ASV per sample is 46, so each sample will subset 15 ASV

## plot all at division and class level
```{r}
#phyloseq_long_treemap(long_nano_2, division, class, "Sorted Nano")
#pdf(here("phyloseq", "paper_c14", "20220411", "nano", "sorted nano treemap.pdf"), height=5, width=5) ; plot(phyloseq_long_treemap(long_nano_2, division, class, "Sorted Nano")) ; dev.off()
#plot all at division and class level to check the difference between all vials
p <- long_nano_2 %>%
  #ps_top_asv(10) %>% #filter top 10 ASV per sample
  #mutate(division = fct_infreq(division)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted nano - division level") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) +
  ylab("Proportion of reads")
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_division_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()

p <- long_nano_2 %>%
  ps_top_asv(15) %>% #filter top 10 ASV per sample
  #mutate(division = fct_infreq(division)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=division)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted nano - division level - top 15 ASV per sample") +
        scale_color_manual(values=divisionPalette, limits = force) + 
        scale_fill_manual(values=divisionPalette, limits = force) +
  ylab("Proportion of reads")
p
pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_division_sub.pdf"), height=5, width=8) ; plot(p) ; dev.off()

p <- long_nano_2 %>%
  #ps_top_asv(10) %>% #filter top 10 ASV per sample
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted nano - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p

p <- long_nano_2 %>%
  ps_top_asv(15) %>% #filter top 10 ASV per sample
  mutate(class = fct_lump_n(class, 7, other_level = "Others")) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x", space = "free") +
        ggtitle("Sorted nano - class level") +
        scale_color_manual(values=classPalette, limits = force) + 
        scale_fill_manual(values=classPalette, limits = force) +
  ylab("Proportion of reads")
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_class_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```

## order level
```{r}
long_nano_4 <- long_nano_3 %>%
    filter(!(cycle_exp =="SA1_2" & SAMPLE == "DCM")) %>%
    filter(!(cycle_exp == "SA1_1" & SAMPLE == "DCM")) %>%
    #filter(!(cycle_exp == "SA3_11" & SAMPLE == "DCM" & vial_type  == "initial" & species == "	Haptophyta_Clade_HAP5_XXX_sp."))  %>%
    filter(vial_type != "dark")

p <- long_nano_4 %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=class)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted nano - class level") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #scale_fill_manual(values=latin_palette('buenavista',6)) +
        ylab("Proportion of reads") +
        scale_fill_manual(values=classPalette, limits = force) 
p

p <- long_nano_4 %>%
  mutate(order = fct_lump_n(order, 15, other_level = "Others")) %>%
  mutate(order = factor(order, levels = c("Dolichomastigales", "Pyramimonadales","Cryptomonadales", "Dinophyceae_X", "Suessiales", "Gymnodiniales","Peridiniales",    "Prorocentrales", "Isochrysidales", "Prymnesiales", "Phaeocystales","Syracosphaerales" , "Bacillariophyta_X", "Dictyochophyceae_X", "MOCH-2_X", "Nephroselmidales", "Haptophyta_Clade_HAP5", "Others"))) %>%
  #mutate(class = fct_infreq(class)) %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted nano - order level") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        #scale_fill_manual(values=latin_palette('buenavista',6)) +
        ylab("Proportion of reads") +
      #scale_fill_manual(values=orderPalette, limits = force) 
        scale_fill_manual(values=colours_18s_order, limits = force) 
 p
 
 pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_order_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()
```

## trophic mode
```{r}
# trophic mode for everything
p <- long_nano_4 %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=trophic_mode_2, color = trophic_mode_2)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x") +
        ggtitle("Sorted nano - trophic mode") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        scale_color_manual(values=trophicPalette, limits = force) + 
        scale_fill_manual(values=trophicPalette, limits = force) 
p
pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_trophic mode_all.pdf"), height=5, width=8) ; plot(p) ; dev.off()

#plot for light vials, average of all light vials
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "photosynthetic") %>%  
  mutate(order = factor(order, levels = c("Cryptomonadales","Pyramimonadales", "Coccolithales", "Chlorellales",  "Bacillariophyta_X", "Dictyochophyceae_X", "MOCH-2_X", "Isochrysidales", "Phaeocystales",  "Haptophyta_Clade_HAP3_X", "Haptophyta_Clade_HAP5_X", "Others"))) %>%
   # mutate(order = fct_infreq(order)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - photosynthetic") +
        scale_fill_manual(values=colours_18s_order, limits = force) 
#scale_fill_manual(values=orderPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_photo order.pdf"), height=6, width=9) ; plot(p) ; dev.off()

#plot for light vials, average of all light vials
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "mixotrophic") %>%  
    #mutate(genus = fct_infreq(genus)) %>%
  #filter(file_code != "pico-56") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - mixotrophic") +
        scale_fill_manual(values=orderPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "nano_mixo species.pdf"), height=6, width=9) ; plot(p) ; dev.off()
```
## Nano Dinophyceae
```{r}
# all at order level
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - dinophyceae") +
        scale_fill_manual(values=latin_palette('badbunny1', 6)) 
        #scale_fill_manual(values=orderPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "dino_order.pdf"), height=6, width=9) ; plot(p) ; dev.off()

#trophic mode, remove Dinophyceae X
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  filter(order != "Dinophyceae_X") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=trophic_mode)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - dinophyceae") +
        scale_fill_manual(values=trophicPalette, limits = force) 
p

pdf(here("phyloseq", "paper_c14", "20220411", "nano", "dino_trophic.pdf"), height=6, width=9) ; plot(p) ; dev.off()

# photo
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  filter(order != "Dinophyceae_X") %>%  
  filter(trophic_mode == "photosynthetic") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - dinophyceae -  photosynthetic") +
        scale_fill_manual(values=latin_palette('badbunny1', 6)) 
        #scale_fill_manual(values=orderPalette, limits = force) 
p

# mixo
p <- long_nano_4 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  filter(order != "Dinophyceae_X") %>%  
  filter(trophic_mode == "mixotrophic") %>%
  ggplot(aes(x=vial_type, y=n_reads, fill=order)) + 
        geom_bar(position="fill", stat="identity", size=0.5) + 
        facet_grid(fct_rev(SAMPLE)~cycle_exp, scales = "free_x",space = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
        ggtitle("Sorted nano - dinophyceae -  mixotrophic") +
        scale_fill_manual(values=latin_palette('badbunny1', 6)) 
        #scale_fill_manual(values=orderPalette, limits = force) 
p

dino_trophic_list <- long_nano_4 %>%
  filter(trophic_mode_2 == "dinophyceae") %>%  
  filter(order != "Dinophyceae_X") %>% 
  select(asv_code:trophic_mode, cycle_name_2, n_reads) %>%
  mutate(water_mass = recode(cycle_name_2, "SA1" = "SA-sc",
                             "SA2" = "SA",
                             "SA3" = "SA",
                             "ST1" = "ST",
                             "ST2" = "ST"))%>%
  group_by(kingdom:trophic_mode, asv_code, water_mass) %>%
  summarise(sum_n_reads = sum(n_reads))  %>%
  group_by(species) %>%
  arrange(desc(sum_n_reads))

dino_trophic_photo <- dino_trophic_list %>%
  filter(trophic_mode == "photosynthetic") %>%
  group_by(kingdom:species, asv_code, water_mass)
dino_trophic_mixo <- dino_trophic_list %>%
  filter(trophic_mode == "mixotrophic")
dino_trophic_hetero <- dino_trophic_list %>%
  filter(trophic_mode == "heterotrophic")


```

