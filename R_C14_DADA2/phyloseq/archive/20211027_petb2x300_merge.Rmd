---
title: "20210929_petB_2x300"
author: "Denise Ong"
date: "9/29/2021"
output: html_document
---

Basic plots for final petB merged data.
Using degenerate base join R1 and R2, removing chimeras.
20220914: change file read to be Mazard primer CTD_2.0 for ALL samples.

# Initialize
```{r, echo=TRUE, message=FALSE, warning=FALSE}

source("phyloseq/init_files/init.R") #for libraries
source("phyloseq/init_files/init_markdown.R") #for markdown libraries
source("phyloseq/init_files/define_functions.R") #functions to 1.transform to dataframe, 2.normalise and 3.create treemaps 
source("phyloseq/init_files/colours_petb.R") #colours
```

# Sorted syn -petB Denise primer
## Read data
```{r}
# Load the phyloseq files
ps <- read_rds("output_petb_2x300/output_petb_Denise/merged_v2/petB_Denise primer_phyloseq_sortedsyn.RDS") 

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps)$water_mass <- sample_data(ps)$Cycle.
sample_data(ps)$water_mass = str_replace(sample_data(ps)$water_mass, "1|2|5", "SA") 
sample_data(ps)$water_mass = str_replace(sample_data(ps)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps)$cycle_location <- sample_data(ps)$Cycle.
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "1", "C")
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "2", "D") 
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "5", "E") 
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "3", "A")
sample_data(ps)$cycle_location = str_replace(sample_data(ps)$cycle_location, "4", "B")

sample_data(ps)$cycle_name <- sample_data(ps)$Cycle.
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps)$cycle_name = str_replace(sample_data(ps)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps)$cycle_name_2 <- sample_data(ps)$cycle_name
sample_data(ps)$cycle_name_2 = str_replace(sample_data(ps)$cycle_name_2, "SA-Cycle_1", "SA1")
sample_data(ps)$cycle_name_2 = str_replace(sample_data(ps)$cycle_name_2, "SA-Cycle_2", "SA2") 
sample_data(ps)$cycle_name_2 = str_replace(sample_data(ps)$cycle_name_2, "SA-Cycle_5", "SA3")
sample_data(ps)$cycle_name_2 = str_replace(sample_data(ps)$cycle_name_2, "ST-Cycle_3", "ST1") 
sample_data(ps)$cycle_name_2 = str_replace(sample_data(ps)$cycle_name_2, "ST-Cycle_4", "ST2")

sample_data(ps)$cycle_location_name <- str_c(sample_data(ps)$cycle_location, sample_data(ps)$cycle_name, sep ="_")
sample_data(ps)$cycle_exp_location_name <- str_c(sample_data(ps)$cycle_location, sample_data(ps)$cycle_name, sample_data(ps)$EXP., sep ="_")

#vial type
sample_data(ps)$vial_type <- sample_data(ps)$vial
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "i", "initial") 
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "A|B|C", "light")
sample_data(ps)$vial_type = str_replace(sample_data(ps)$vial_type, "D", "dark")

# Remove ASVs that are not present in the dataset
ps <- ps %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps <- phyloseq_normalize_median(ps)
long <- phyloseq_transform_to_long(ps)

junk <- data.frame(ps@sam_data)
```

```{r}
p1 <- long %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name != "syn-negr1-2") %>%
    filter(sample_name != "syn-11") %>%
    filter(sample_name != "syn-12") %>%
  ggplot(aes(x=vial_type, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
  theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(fct_rev(SAMPLE)~cycle_location_name, scales = "free_x") +
        ggtitle("C14 sorted syn Denise primer- merged (by cycle)") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force) 
p1

#pdf("phyloseq/figures_20211027/C14 syn_merged_depth_vial.pdf", height=5, width=8) ; plot(p1) ; dev.off()
```

## Duplicates
```{r}
p7 <- long %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name %in% c("syn-01-10", "syn-01-20", "syn-02-10", "syn-02-5", "syn-03-10", "syn-03-2", "syn-03-4"))%>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
  theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+
    #    facet_grid(.~water_mass, scales = "free_x") +
        facet_grid(.~sorting_number, scales = "free_x") +
        ggtitle("C14 sorted syn Denise primer- duplicates") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force) 
p7

pdf("phyloseq/figures_20211027/C14 syn_merged_duplicates.pdf", height=5, width=8) ; plot(p7) ; dev.off()

```

## Average of light vials only, by cycle and depth
```{r}
p1 <- long %>%
  filter(vial_type == "light") %>%
#  mutate(class = fct_infreq(class))%>%
#  mutate(class = fct_lump_n(class, 10, other_level = "Others")) %>%
#  mutate(class = factor(class, levels = c("Mamiellophyceae", "Pyramimonadophyceae","Bacillariophyta","Dictyochophyceae","MOCH-2","Pelagophyceae",    "Syndiniales", "Dinophyceae", "Prymnesiophyceae","Cryptophyceae", "Others"))) %>%
    filter(sample_name != "syn-negr1-2") %>%
    filter(sample_name != "syn-11") %>%
    filter(sample_name != "syn-12") %>%
  ggplot(aes(x=cycle_name_2, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),
              axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              panel.border = element_blank(), 
              panel.spacing.x = unit(0,"lines"),
              panel.spacing.y = unit(0,"lines"),
              axis.line.y.left = element_line())+
        #facet_grid(fct_rev(SAMPLE)~vial_type, scales = "free_x")
        facet_grid(fct_rev(SAMPLE)~factor(cycle_name_2, levels = c("ST1", "ST2", "SA1", "SA2", "SA3")), scales = "free_x") +
        ggtitle("Synechococcus") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force) +
  ylab("Percent of reads")
p1

pdf("phyloseq/figures_ACOP/sorted syn class_light.pdf", height=5, width=5) ; plot(p1) ; dev.off()
```

# CTD-petB Denise primer
##Read data
```{r}
# Load the phyloseq files
ps_ctd_nested <- read_rds("output_petb_2x300/output_petb_Denise/merged_v2/petB_Denise primer_phyloseq_CTD.RDS") 

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps_ctd_nested)$water_mass <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$water_mass = str_replace(sample_data(ps_ctd_nested)$water_mass, "1|2|5", "SA") 
sample_data(ps_ctd_nested)$water_mass = str_replace(sample_data(ps_ctd_nested)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps_ctd_nested)$cycle_location <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "1", "C")
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "2", "D") 
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "5", "E") 
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "3", "A")
sample_data(ps_ctd_nested)$cycle_location = str_replace(sample_data(ps_ctd_nested)$cycle_location, "4", "B")

sample_data(ps_ctd_nested)$cycle_name <- sample_data(ps_ctd_nested)$cycle
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps_ctd_nested)$cycle_name = str_replace(sample_data(ps_ctd_nested)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps_ctd_nested)$cycle_location_name <- str_c(sample_data(ps_ctd_nested)$cycle_location, sample_data(ps_ctd_nested)$cycle_name, sep ="_")
sample_data(ps_ctd_nested)$cycle_station_location_name <- str_c(sample_data(ps_ctd_nested)$cycle_location, sample_data(ps_ctd_nested)$cycle_name, sample_data(ps_ctd_nested)$station, sep ="_")

junk <- data.frame(ps_ctd_nested@sam_data)

# Remove ASVs that are not present in the dataset
ps_ctd_nested <- ps_ctd_nested %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps_ctd_nested <- phyloseq_normalize_median(ps_ctd_nested)
long_ctd_nested <- phyloseq_transform_to_long(ps_ctd_nested)
```

```{r}
p3 <- long_ctd_nested %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name != "syn-negr1-2") %>%
  ggplot(aes(x=cycle_station_location_name, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
  theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+ 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB Denise primer - merged") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force)
p3

pdf("phyloseq/figures_20211027/CTD Denise__exp.pdf", height=5, width=8) ; plot(p3) ; dev.off()
```


# CTD- petB Mazard primer
##Read data
```{r}
# Load the phyloseq files
ps_ctd_normal <- read_rds("output_petb_2x300/output_petb_Mazard/merged_v2/petB Mazard primer_phyloseq_CTD_2.0.RDS")  # adding new component, this case the phyloseq object to the "tag" all

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps_ctd_normal)$water_mass <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$water_mass = str_replace(sample_data(ps_ctd_normal)$water_mass, "1|2|5", "SA") 
sample_data(ps_ctd_normal)$water_mass = str_replace(sample_data(ps_ctd_normal)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps_ctd_normal)$cycle_location <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "1", "C")
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "2", "D") 
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "5", "E") 
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "3", "A")
sample_data(ps_ctd_normal)$cycle_location = str_replace(sample_data(ps_ctd_normal)$cycle_location, "4", "B")

sample_data(ps_ctd_normal)$cycle_name <- sample_data(ps_ctd_normal)$cycle
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps_ctd_normal)$cycle_name = str_replace(sample_data(ps_ctd_normal)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps_ctd_normal)$cycle_location_name <- str_c(sample_data(ps_ctd_normal)$cycle_location, sample_data(ps_ctd_normal)$cycle_name, sep ="_")
sample_data(ps_ctd_normal)$cycle_station_location_name <- str_c(sample_data(ps_ctd_normal)$cycle_location, sample_data(ps_ctd_normal)$cycle_name, sample_data(ps_ctd_normal)$station, sep ="_")

junk <- data.frame(ps_ctd_normal@sam_data)

# Remove ASVs that are not present in the dataset
ps_ctd_normal <- ps_ctd_normal %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Do normalizations and transformation
ps_ctd_normal <- phyloseq_normalize_median(ps_ctd_normal)
long_ctd_normal <- phyloseq_transform_to_long(ps_ctd_normal)
```

```{r}
p5 <- long_ctd_normal %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
   # filter(sample_name != "CTD-petB-neg2") %>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+ 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB Mazard primer") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force) 
p5

#pdf("phyloseq/figures_20211027/CTD Mazard_all.pdf", height=5, width=8) ; plot(p5) ; dev.off()
```

# CTD- petB Mazard primer - remove Richellia
##Read data
```{r}
# Load the phyloseq files
ps_ctd_normal_R2 <- read_rds("output_petb_2x300/output_petb_Mazard/merged_v2/petB Mazard primer_phyloseq_CTD_2.0.RDS")  # adding new component, this case the phyloseq object to the "tag" all

#copy the column of interest to create new column, and replacing names for water masses SA and ST
sample_data(ps_ctd_normal_R2)$water_mass <- sample_data(ps_ctd_normal_R2)$cycle
sample_data(ps_ctd_normal_R2)$water_mass = str_replace(sample_data(ps_ctd_normal_R2)$water_mass, "1|2|5", "SA") 
sample_data(ps_ctd_normal_R2)$water_mass = str_replace(sample_data(ps_ctd_normal_R2)$water_mass, "3|4", "ST")

#copy the column of interest, creating new column and replace for cycle names. Not using this column for now. 
sample_data(ps_ctd_normal_R2)$cycle_location <- sample_data(ps_ctd_normal_R2)$cycle
sample_data(ps_ctd_normal_R2)$cycle_location = str_replace(sample_data(ps_ctd_normal_R2)$cycle_location, "1", "C")
sample_data(ps_ctd_normal_R2)$cycle_location = str_replace(sample_data(ps_ctd_normal_R2)$cycle_location, "2", "D") 
sample_data(ps_ctd_normal_R2)$cycle_location = str_replace(sample_data(ps_ctd_normal_R2)$cycle_location, "5", "E") 
sample_data(ps_ctd_normal_R2)$cycle_location = str_replace(sample_data(ps_ctd_normal_R2)$cycle_location, "3", "A")
sample_data(ps_ctd_normal_R2)$cycle_location = str_replace(sample_data(ps_ctd_normal_R2)$cycle_location, "4", "B")

sample_data(ps_ctd_normal_R2)$cycle_name <- sample_data(ps_ctd_normal_R2)$cycle
sample_data(ps_ctd_normal_R2)$cycle_name = str_replace(sample_data(ps_ctd_normal_R2)$cycle_name, "1", "SA-Cycle_1")
sample_data(ps_ctd_normal_R2)$cycle_name = str_replace(sample_data(ps_ctd_normal_R2)$cycle_name, "2", "SA-Cycle_2") 
sample_data(ps_ctd_normal_R2)$cycle_name = str_replace(sample_data(ps_ctd_normal_R2)$cycle_name, "5", "SA-Cycle_5") 
sample_data(ps_ctd_normal_R2)$cycle_name = str_replace(sample_data(ps_ctd_normal_R2)$cycle_name, "3", "ST-Cycle_3")
sample_data(ps_ctd_normal_R2)$cycle_name = str_replace(sample_data(ps_ctd_normal_R2)$cycle_name, "4", "ST-Cycle_4")

sample_data(ps_ctd_normal_R2)$cycle_location_name <- str_c(sample_data(ps_ctd_normal_R2)$cycle_location, sample_data(ps_ctd_normal_R2)$cycle_name, sep ="_")
sample_data(ps_ctd_normal_R2)$cycle_station_location_name <- str_c(sample_data(ps_ctd_normal_R2)$cycle_location, sample_data(ps_ctd_normal_R2)$cycle_name, sample_data(ps_ctd_normal_R2)$station, sep ="_")

# Remove ASVs that are not present in the dataset
ps_ctd_normal_R2 <- ps_ctd_normal_R2 %>% 
    phyloseq::filter_taxa(function(x) sum(x) > 0 , TRUE) 

# Remove Richellia
ps_ctd_normal_R2 <- ps_ctd_normal_R2 %>% 
      subset_taxa(!(Genus == "Rich")) 


# Do normalizations and transformation
ps_ctd_normal_R2 <- phyloseq_normalize_median(ps_ctd_normal_R2)
long_ctd_normal_R2 <- phyloseq_transform_to_long(ps_ctd_normal_R2)
```

```{r}
p6 <- long_ctd_normal_R2 %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
    #filter(sample_name != "CTD-petB-neg2") %>%
    ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),
              axis.text.x = element_text(angle = 45, hjust = 1))+ 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB Mazard primer - remove Rich") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force)
  
p6

#pdf("phyloseq/figures_20211027/CTD Mazard_remove rich_exp.pdf", height=5, width=8) ; plot(p6) ; dev.off()
```

## Normal CTD negative
```{r}
p <- long_ctd_normal %>%
   # mutate(Subclade = fct_infreq(Subclade))%>%
    filter(sample_name == "CTD-petB-neg2") %>%
  ggplot(aes(x=file_code, y=n_reads, color=Subclade, fill=Subclade)) + 
        geom_bar(position="fill", stat="identity") + 
        theme(text=element_text(size=10),axis.text.x = element_text(angle = 45, hjust = 1)) + 
        facet_grid(.~cycle_location_name, scales = "free_x") +
        ggtitle("CTD petB Mazard primer R1 negative") +
        scale_color_manual(values=colours_petb_subclade, limits = force) + 
        scale_fill_manual(values=colours_petb_subclade, limits = force)
p


```

```{r}
library(cowplot)
g<- plot_grid(p1, p2, p3, p4, p5, p6, 
          labels = "AUTO", 
          ncol = 2,
          nrow = 3)
pdf("phyloseq/cowplot test.pdf", height=10, width=11) ; plot(g) ; dev.off()
```

