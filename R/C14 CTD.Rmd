---
title: "C14 CTD"
author: "Denise Ong"
date: "2/28/2021"
output: pdf_document
---

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               tidy = FALSE,
               fig.height=8, 
               fig.width=8,
               results = 'asis')
opts_knit$set(width=75)
```


Denise notes 20210315:
- depth was selected until 200 m
- depth interval selected every 5 m
- cycle 1/subantarctic 1 - 25 Oct to 30 Oct
- cycle 2/subantarctic 2 - 2 Nov to 6 Nov
- cycle 3/subtropical 1 - 8 to 10 Nov
- cycle 4/ subtropical 2 - 12 to 14 Nov
- cycle 5/ subantarctic 3 - 16 to 17 Nov

# Load libraries

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readxl) # Read excel file
library(lubridate) 
library(cowplot)
#library(AquaEnv)
#library(gsw)
```

Plot the cycles together until 100 m

# Read table.
```{r}
CTD_raw <- readxl::read_excel("../data_used/TK_CTD Downcasts.xlsx") %>%
  dplyr::rename(CTD = `cast`) %>%
  mutate(datetime =  dmy_hms(datetime)) %>%
  filter(!is.na(t)) %>%
  mutate(date = date(datetime)) %>%
  mutate(time = hour(datetime)) %>%
  mutate(julian_day = julian(date, origin = date("2018-01-01"))) %>%
  filter(time %in% (9:12) ) %>%
  mutate(t_mean = (t+t2)/2) %>%
  mutate(s_mean = (s+s2)/2) %>%
  mutate(os_mean = (os+os2)/2) %>%
  select(-t, -t2, -s, -s2, -os, -os2) %>%
  filter(p <= 100)
CTD_raw
```

```{r}
CTD <- CTD_raw %>%
  mutate(cycle = NA)

CTD$julian_day <- as.character(CTD$julian_day)
CTD$cycle[grep("297", CTD$julian_day)] = "1"
CTD$cycle[grep("298", CTD$julian_day)] = "1"
CTD$cycle[grep("299", CTD$julian_day)] = "1"
CTD$cycle[grep("300", CTD$julian_day)] = "1"
CTD$cycle[grep("301", CTD$julian_day)] = "1"
CTD$cycle[grep("302", CTD$julian_day)] = "1"
CTD$cycle[grep("305", CTD$julian_day)] = "2"
CTD$cycle[grep("306", CTD$julian_day)] = "2"
CTD$cycle[grep("307", CTD$julian_day)] = "2"
CTD$cycle[grep("308", CTD$julian_day)] = "2"
CTD$cycle[grep("309", CTD$julian_day)] = "2"
CTD$cycle[grep("311", CTD$julian_day)] = "3"
CTD$cycle[grep("312", CTD$julian_day)] = "3"
CTD$cycle[grep("313", CTD$julian_day)] = "3"
CTD$cycle[grep("315", CTD$julian_day)] = "4"
CTD$cycle[grep("316", CTD$julian_day)] = "4"
CTD$cycle[grep("317", CTD$julian_day)] = "4"
CTD$cycle[grep("319", CTD$julian_day)] = "5"
CTD$cycle[grep("320", CTD$julian_day)] = "5"

CTD <- CTD %>% mutate(cycle_name = recode(cycle, "1" = "Subantarctic 1",
                                    "2" = "Subantarctic 2",
                                    "3" = "Subtropical 1",
                                    "4" = "Subtropical 2",
                                    "5" = "Subantarctic 3")) 
#CTD$cycle_name <- factor(CTD$cycle_name,levels = c("Subtropical 1", "Subtropical 2", "Subantarctic 1", "Subantarctic 2", "Subantarctic 3")) 

CTD <- CTD %>%
    filter(!is.na(cycle)) #remove rows without cycle number

#check the dates
check <- CTD  %>% 
  select(date, cycle) %>%
  distinct()
check
```

#Function for summarising the data
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}
```

Plot temperature

```{r}
library(viridis)
#summarise temp data
temp_summary <- summarySE(CTD, measurevar="t_mean", groupvars=c("p","cycle_name"), na.rm=TRUE)
temp_summary

pd <- position_dodge(0.1) # move them .05 to the left and right

temp_plot <- temp_summary %>%
  ggplot(aes(x=t_mean, y=p, colour=cycle_name)) + 
    geom_errorbar(aes(xmin=t_mean-se, xmax=t_mean+se), width=.1, position=pd) +
    geom_path() +
    geom_point(size=0.5) +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab(expression(paste("Temperature (",degree,"C)")))+
  labs(colour = "Cycle name")+
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE) 
 
temp_plot

```

Plot salinity

```{r}
#summarise salinity data
s_summary <- summarySE(CTD, measurevar="s_mean", groupvars=c("p","cycle_name"), na.rm=TRUE)
s_summary

pd <- position_dodge(0.1) # move them .05 to the left and right

s_plot <- s_summary %>%
  ggplot(aes(x=s_mean, y=p, colour=cycle_name)) + 
    geom_errorbar(aes(xmin=s_mean-se, xmax=s_mean+se), width=.1, position=pd) +
    geom_path() +
    geom_point(size=0.5) +
  scale_y_reverse()+
  theme_bw() +
  ylab(NULL)+
  xlab("Salinity")+
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE) 

s_plot

```

Plot oxygen

```{r}
#summarise oxygen data
os_summary <- summarySE(CTD, measurevar="os_mean", groupvars=c("p","cycle_name"), na.rm=TRUE)
os_summary

pd <- position_dodge(0.1) # move them .05 to the left and right

os_plot <- os_summary %>%
  ggplot(aes(x=os_mean, y=p, colour=cycle_name)) + 
    geom_errorbar(aes(xmin=os_mean-se, xmax=os_mean+se), width=.1, position=pd) +
    geom_path() +
    geom_point(size=0.5) +
  scale_y_reverse()+
  theme_bw() +
  ylab("Depth (m)")+
  xlab("Oxygen") +
  scale_fill_viridis_d()

os_plot

```

Plot flourescence

```{r}
#summarise flourescnece data
f_summary <- summarySE(CTD, measurevar="fl", groupvars=c("p","cycle_name"), na.rm=TRUE)
f_summary <- f_summary %>%
  group_by(cycle_name) %>%
  arrange(p)

pd <- position_dodge(0.1) # move them .05 to the left and right

f_plot <- f_summary %>%
  ggplot(aes(x=fl, y=p, colour=cycle_name)) + 
    geom_errorbar(aes(xmin=fl-se, xmax=fl+se), width=.1, position=pd) +
    geom_path() +
    geom_point(size=0.5) +
  scale_y_reverse()+
  theme_bw() +
  ylab(NULL)+
  xlab("Fluorescence") +
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE) 

f_plot

```

```{r}
CTD_figure <- plot_grid(
  temp_plot+ theme(legend.position="none"), 
  s_plot+ theme(legend.position="none"), 
  f_plot+ theme(legend.position="none"),
  labels = c("A", "B", "C"), 
  align = 'vh',
  hjust = -1,
  nrow = 1) 

# extract a legend that is laid out horizontally
legend_b <- get_legend(
  temp_plot + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

# add the legend underneath the row we made earlier. Give it 10%
# of the height of one plot (via rel_heights).
 CTD_figure <- plot_grid(CTD_figure, legend_b, ncol = 1, rel_heights = c(1, .1))

CTD_figure
ggsave("../figures/CTD_line.png")

```

