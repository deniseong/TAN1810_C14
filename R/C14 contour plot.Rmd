---
title: "C14 CTD contour plot"
author: "Denise Ong"
date: "2/28/2021"
output: pdf_document
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               tidy = FALSE,
               fig.height=8, 
               fig.width=8,
               results = 'asis')
opts_knit$set(width=75)
```

# Load libraries

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readxl) # Read excel file
library(lubridate) 
library("cowplot")
library("AquaEnv")
library("gsw")
```

#Read table, combine with C14 hot for the cycle, exp and station number.
```{r}
CTD_raw <- readxl::read_excel("../data_used/TK_CTD Downcasts.xlsx") %>%
  rename(CTD = `cast`) %>%
  mutate(datetime =  dmy_hms(datetime)) %>%
  filter(!is.na(t)) %>%
  mutate(date = date(datetime)) %>%
  mutate(julian_day = julian(date, origin = date("2018-01-01")))
C14_hot <- readxl::read_excel("../data_used/TAN1810_14C-Pico_25052020_QA_1.0.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `STN`, `CTD#`, `Julian Day`)%>%   
     rename(cycle = `Cycle#`,
            exp = `EXP#`,
            station = `STN`)%>%
            #julian_day = `Julian Day`)%>%
  mutate(ctd_char=stringr::str_remove_all(`CTD#`,"U"))%>%
  mutate(CTD=as.double(ctd_char))%>%
      distinct()

CTD <- dplyr::right_join(C14_hot, CTD_raw) %>%
  select(-ctd_char, -`CTD#`)

CTD
```


#Temperature contour plot
```{r}

x <- CTD %>% select (julian_day, p)
y <- CTD$t

scaling_factor=15

#Creating polygon and Grid for Raster 

xmin_gg=as.Date("2018-10-01")
xmax_gg=as.Date("2018-11-30")

xmin <- min(CTD$julian_day) - 2
xmax <- max(CTD$julian_day) + 2
ymax <- max(CTD$t) + 2
ymin <- min(CTD$t) - 2

# Create binding polygon

  x_coord <- c(xmin,
               xmin,
               xmax,
               xmax,
               xmin)
  y_coord <- c(ymin,
               ymax,
               ymax,
               ymin,
               ymin)
  polygon <- cbind(x_coord, y_coord)
  polygon <- sp::Polygon(polygon)
  
  polygons = sp::SpatialPolygons(list(sp::Polygons(list(polygon), "s1")))
  # plot(polygons)
  
  # Create grid
  
  gridint <- 1 # Multiplyong factor to increase the resolution of the grid
  gridx <- (xmax-xmin + 1)*gridint
  gridy <- round((ymax-ymin +1 )*gridint)
  grid <- raster::raster(nrows= gridy, ncols=gridx, 
                         xmn=xmin, 
                         xmx=xmax, 
                         ymn=ymin, ymx=ymax)


#Using KRIGE fitting to interpolate grid

# fit
  fit_krig <- fields::Krig(x, y, theta=100)
  #this part takes too long.

# look at the surface
# fields::surface(fit_krig, type="C") 

# interpolate to the raster grid
grid_krig <- raster::interpolate(grid, fit_krig)

# Mask the grid
grid_krig <- raster::mask(x=grid_krig, mask=polygons)

# Plot the interpolation
# raster::plot(grid_krig)

# Transform to data frame for ggplot

val <- data.frame(t_fit = raster::getValues(grid_krig))
xy <- as.data.frame(raster::xyFromCell(grid_krig,1:raster::ncell(grid_krig)))
grid_t_krig <- bind_cols(xy,val) %>%   
  mutate(date=as_date(x, origin="2016-01-01"), 
         t_fit = if_else(t_fit <0,0,t_fit) ) %>%
  dplyr::rename(depth_m=y) %>% 
  filter(!is.na(t_fit))

# Plot with ggplot
  
temp <- ggplot(grid_t_krig, aes(x=date, y=depth_m)) +
        geom_raster(mapping=aes(fill = t_fit)) + 
        geom_contour(data = grid_t_krig, mapping = aes(z=t_fit),  
                               breaks = c(seq(0, 15,3))) +
        scale_fill_distiller(palette = "Spectral") +
        scale_x_date(limits=c(xmin_gg,xmax_gg), 
                     date_breaks = "1 month", 
                     date_minor_breaks = "1 week", 
                     date_labels =  "%d/%m/%y") +
        scale_y_reverse() +
        geom_point(data=CTD, 
                   mapping=aes(x=date, y=depth_m), size=0.5, color="white" ) +
        ggtitle("2Downcast temp")  +
        xlab("Date") + ylab("Depth (m)") +
        theme(panel.border = element_rect(colour = "black") ) +
        theme_bw(scaling_factor) +
     labs(fill = "Temp") +    
  theme(axis.text=element_text(size=28),
        axis.title=element_text(size=28,face="bold"),
        legend.title =element_text(size=28,face="bold"),
        legend.text = element_text(size=20),        
        title = element_text(size=28, face = "bold", hjust = 0.5))
temp

```
