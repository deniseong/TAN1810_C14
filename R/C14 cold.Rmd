---
title: "C14 cold data"
author: "Denise Ong"
date: "2/28/2021"
output: pdf_document
---
```{r setup, include=FALSE}
  knitr::opts_chunk$set(message=FALSE,
                        warning=FALSE,
                        cache=TRUE,
                        tidy=FALSE)
```

```{r}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(broom)
library(ggpubr)
library(stringr)
```

# 1. Read table for C14 cold values, merge for cycle and experiment number. Add new column to indicate dark.
```{r}
C14_cold_raw <- readxl::read_excel("../data_used/TAN1810_14C-Pico_25052020_QA_1.0.xlsx", sheet = "Cold 14C - Pico Results", skip = 5,  n_max = 93) %>%
  select (`Unique code or sample identifier`,`Station`,`Depth m`, `Sample ID`, `DPM to full volume`, `SA_dpm_mL`, `DIC`, `NPP_cold`, `NPP_standard`)  %>%
  rename(name = `Unique code or sample identifier`,
            station = `Station`,
            depth = `Depth m`,
            sample_id = `Sample ID`,
            DPM_full = `DPM to full volume`,
            SA = `SA_dpm_mL`) %>%
   add_column(dark = NA)
           #mutate(dark = case_when (str_detect(name,"D") ~ TRUE, TRUE~FALSE))
  C14_hot <- readxl::read_excel("../data_used/TAN1810_14C-Pico_25052020_QA_1.0.xlsx", sheet = "Complete data TAN1810", skip = 11) %>%
  dplyr::select (`Cycle#`, `EXP#`, `SAMPLE`, `STN`, `DEPTH`) %>%   
     rename(cycle = `Cycle#`,
            exp = `EXP#`,
            sample = `SAMPLE`, 
            station = `STN`,
            depth = `DEPTH`)%>%
    distinct()
C14_cold <- right_join(C14_hot, C14_cold_raw) %>%
  na_if("missing")
C14_cold$cycle <- as.character(C14_cold$cycle) 
C14_cold$exp <- as.character(C14_cold$exp)
C14_cold$NPP_standard <- as.double(C14_cold$NPP_standard)
# Dark column. Create empty col then use grep to fill in.
C14_cold$dark <- as.character(C14_cold$dark)
C14_cold$dark[grep("D", C14_cold$name)] = "dark"
C14_cold$dark <- ifelse(is.na(C14_cold$dark), 
             'light', C14_cold$dark)
#C14_cold$dar[is.na(C14_cold$dar)] <- "light"
#Add missing cycle and sample details, based on the voyage report.
C14_cold$cycle[grep("U9106", C14_cold$name)] = "1"
C14_cold$exp[grep("U9106", C14_cold$name)] = "2"
C14_cold$sample[grep("40", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9164", C14_cold$name)] = "5"
C14_cold$sample[grep("70", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9167", C14_cold$name)] = "5"
C14_cold$sample[grep("12", C14_cold$name)] = "SUR"
C14_cold$sample[grep("60", C14_cold$name)] = "DCM"
C14_cold$cycle[grep("U9136", C14_cold$name)] = "2"
C14_cold$exp[grep("U9136", C14_cold$name)] = "6"
C14_cold
```
Calculations for NPP_cold and NPP_standard have already been done. Assume that the values are correct.

#remove dark values
```{r}
cold_dark_NPP <- C14_cold %>% 
  filter(dark == "dark") %>%
  filter(!(cycle ==3 & exp == 7)) %>%#very high values. Check if it is a dark vial?
  rename(NPP_cold_dark = NPP_cold)  %>%
  rename(NPP_standard_dark = NPP_standard)%>%
  select(cycle, exp, sample, NPP_cold_dark, NPP_standard_dark)
cold_dark_NPP
# Check the values of dpm dark with histogram. The values are normally distributed, concentrated around the mean.
hist(cold_dark_NPP$NPP_cold_dark)
hist(cold_dark_NPP$NPP_standard_dark)
mean(cold_dark_NPP$NPP_cold_dark)
mean(cold_dark_NPP$NPP_standard_dark, na.rm = TRUE) #ignore NA values
#means are ok
```
Means are ok, dark values are low.

```{r}
cold_corrected <- full_join(C14_cold,cold_dark_NPP) %>% 
  filter (dark == "light") %>% 
  # DV - The next line replace dpm_dark to average dpm_dark if no value. Checked with histogram above.
  mutate(NPP_cold_dark = case_when (is.na(NPP_cold_dark) ~ mean(NPP_cold_dark, na.rm = TRUE),
                               TRUE ~ NPP_cold_dark)) %>%
 
  mutate(NPP_standard_dark = case_when (is.na(NPP_standard_dark) ~ mean(NPP_standard_dark, na.rm = TRUE), TRUE ~ NPP_standard_dark))  %>%
  mutate(NPP_cold_corrected = NPP_cold - NPP_cold_dark)%>%
  mutate(NPP_standard_corrected = NPP_standard - NPP_standard_dark) %>%
  select(cycle, exp, sample,  station, depth,NPP_cold_corrected,NPP_standard_corrected)

cold_corrected
```

```{r}
cold_mean_vial<- cold_corrected %>%
  group_by(cycle, exp, sample) %>%
  summarise(NPP_cold_mean = mean(NPP_cold_corrected, na.rm = TRUE))
cold_mean_standard <- cold_corrected %>%
  group_by(cycle, exp, sample) %>%
  summarise(NPP_standard_mean = mean(NPP_standard_corrected, na.rm = TRUE))

cold_mean <- full_join (cold_mean_standard,cold_mean_vial)%>%
  mutate(difference = NPP_standard_mean - NPP_cold_mean)
cold_mean
```


```{r}
C14_cold_2 <- cold_corrected %>%
  mutate(difference = NPP_cold_corrected - NPP_standard_corrected)
C14_cold_2
```
The units is (mgC/m3/day).

cycle 3: exp 7 : surface and DCM have very large differences (22-24) between standard and cold. 
- for DCM standard is too low compared to cold.
- for SUR standard is too high. High size fraction, increases variability.
- all replicates have large difference.

Cycle 4: exp 10 : surface and DCM also have moderate differences (around 8).
- for both standard are lower than cold.
- all replicates have large difference

The rest are similar, usually <1, maximum 5. 
cycle 1: exp 2: SUR, one has difference of 12.9. Cold is higher. - remove?

standard fractionated?- from Andres
- to get standard fractionated NPP 
- nutrients
- pigments
standard is too high compared to the exp. Its on the high size fraction, increase variability
standard is too low. 